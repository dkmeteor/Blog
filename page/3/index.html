<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DK&#39;s Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="DK's Lab">
<meta property="og:url" content="http://blog.dk-exp.com/page/3/index.html">
<meta property="og:site_name" content="DK's Lab">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DK's Lab">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="DK&#39;s Lab" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?47d977b9cd46d5988a3e06ada67a7fa9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">DK</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/circle/" style="font-size: 10px;">circle</a> <a href="/tags/list/" style="font-size: 10px;">list</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">DK</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">DK</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-checkbox-paddingleft" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/26/checkbox-paddingleft/" class="article-date">
  	<time datetime="2015-03-26T08:30:09.000Z" itemprop="datePublished">2015-03-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/26/checkbox-paddingleft/">关于CheckBox的PaddingLeft</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在不同Android版本中对PaddingLeft的计算方式不同</p>
<p>在Android 4.1.2 之前,Checkbox的 paddingleft 是从View最左侧开始计算的</p>
<p>而Android 4.1.2 之后,Checkbox的 paddingLeft 是从drawableLeft的右侧开始计算起的</p>
<p>2个版本之间的 paddingLeft会差一个 drawableLeft的宽度</p>
<p>一个兼容实现方式</p>
<pre><code>//View hack for fucking difference between versions
        if (Build.VERSION.SDK_INT &amp;lt;= 16) {//4.1.2
            mCheckBox.setPadding(ViewUtils.getPixels(20 + 10, mContext), 0, 0, 0);
            } else {
            mCheckBox.setPadding(ViewUtils.getPixels(10,mContext), 0, 0, 0);
        }
</code></pre><p>讨厌这种写法。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Algorithm/">Algorithm</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-circleanimation-update" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/22/circleanimation-update/" class="article-date">
  	<time datetime="2015-03-22T10:35:39.000Z" itemprop="datePublished">2015-03-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/22/circleanimation-update/">CircleAnimation Update</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/circle_animation_demo2.gif" alt="circle_animation"></p>
<p>修改了实现方式，不再依赖RevealAnimator</p>
<p>也不再依赖</p>
<pre><code>/** @hide */
public void setRevealClip(boolean shouldClip, float x, float y, float radius)&lt;/pre&gt;
</code></pre><p>删除了反射的setRevealClip的部分</p>
<hr>
<p>新的实现完全基于老的Canvas API，兼容低版本</p>
<hr>
<p>缩放的部分加了个bounce效果，不过效果并不好，估计是系数选的不对，看来还是去找一套算好的系数。</p>
<p>最后再把相关接口调整一下，一坨AnimatorSet的嵌套逻辑最后用 playSequentially 整理一下应该就可以结束了。</p>
<hr>
<p>顺带 看了下 CircularReveal <a href="https://github.com/ozodrukh/CircularReveal/" target="_blank" rel="external">https://github.com/ozodrukh/CircularReveal/</a> 的源代码</p>
<p>用这个方案来实现也可以，不过</p>
<p>先draw再clipPath</p>
<p>和</p>
<p>drawCircle with BitmapShader</p>
<p>从结果上来看是完全等价的。</p>
<p>以后需要在ViewGroup上实现该效果可能才用得上这个方案</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-circleanimation" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/19/circleanimation/" class="article-date">
  	<time datetime="2015-03-19T09:55:51.000Z" itemprop="datePublished">2015-03-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/19/circleanimation/">CircleAnimation</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/circle_animation_demo.gif" alt="circle_animation"></p>
<p>下午和同事讨论转场效果，晚上蛋疼试了一下。</p>
<p>做起来还比较简单，不过RevealAnimator整个系列API 还全是 @Hide，最后反射了几个View的私有API hack了一下..</p>
<p>加速器曲线没仔细调，用sin函数凑合了一下</p>
<p>目前限制还比较多，依赖Container，仅支持API21， 因为反射的关系，也不用谈什么兼容性了…我自己都不知道那几个@hide 方法是哪个版本加的..grepcode不知道为毛挂着代理也访问不了，一下子还不知道去哪里查，@hide 的API官方文档上压根就找不到..</p>
<p>考虑兼容性要正常使用的话 动画的位置需要用 DecorView的根容器置换一下，然后这一套私有API要全部扔掉，换成ViewGroup里的canvas<span class="pl-k">.</span>clipPath(CirclePath)去实现</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-euclid-code-anaylsis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/19/euclid-code-anaylsis/" class="article-date">
  	<time datetime="2015-03-19T09:30:38.000Z" itemprop="datePublished">2015-03-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/19/euclid-code-anaylsis/">Euclid 源码分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Euclid 源码分析</p>
<p>Euclid<br><a href="https://github.com/Yalantis/Euclid" target="_blank" rel="external">https://github.com/Yalantis/Euclid</a></p>
<p>效果比较惊艳，clone下来分析一下源码~</p>
<p>99%的UI动效都是Trick…..<br>看完源码蛋都碎了….</p>
<hr>
<p>看源码之前比较疑惑如何做到Activity切换时动效这么流畅<br>还以为是 android.Transition Framework 的一个我不知道的用法..</p>
<p>表现形式上很像新的转场动画特效（Shared elements between activities）</p>
<blockquote>
<p>android.Transition Framework can be used for three main things:</p>
<ul>
<li>Animate View elements in transitions between activites (or fragments)</li>
<li>Animate shared elements (hero views) in transitions between activities (or fragments)</li>
<li>Animate View elements from one activity scene to another.</li>
</ul>
</blockquote>
<p>Github上有个低版本的兼容库 <a href="https://github.com/tianzhijiexian/ActivityOptionsICS" target="_blank" rel="external">https://github.com/tianzhijiexian/ActivityOptionsICS</a><br>使用在Intent上传递Bitmap做到View的传递，不过只有视觉上的效果，因为传过去的并不是View，只是用指定View生成的Bitmap</p>
<p>我自己的ScreenTransitionTool原理也和这个一样…….不过当时没写完…丢下了就有点捡不起来了..</p>
<p>这个时候就觉得 IOS 的 ViewController系统优势的多,Controller切换时可以同时访问前后2个Controller</p>
<p>回归正题</p>
<p>Euclid可以做到这个效果的原因真的很傻逼，因为它的List界面和Detail界面在同一个Activity中….</p>
<p>所以…..剩下就是普通的 ObjectAnimator ……… sad ….</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-different-between-mipmap-and-drawable" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/17/different-between-mipmap-and-drawable/" class="article-date">
  	<time datetime="2015-03-17T07:48:33.000Z" itemprop="datePublished">2015-03-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/17/different-between-mipmap-and-drawable/">mipmap 目录和drawable 目录有什么区别</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我简单总结一下：</p>
<p>使用上没有任何区别,你把它当drawable用就好了。</p>
<p>但是用mipmap系统会在缩放上提供一定的性能优化。</p>
<p>#官方介绍：</p>
<blockquote>
<p>Mipmapping for drawables</p>
<p>  Using a mipmap as the source for your bitmap or drawable is a simple way to provide a quality image and various image scales, which can be particularly useful if you expect your image to be scaled during an animation.</p>
<p>  Android 4.2 (API level 17) added support for mipmaps in the Bitmap class—Android swaps the mip images in your Bitmap when you’ve supplied a mipmap source and have enabled setHasMipMap(). Now in Android 4.3, you can enable mipmaps for a BitmapDrawable object as well, by providing a mipmap asset and setting the android:mipMap attribute in a bitmap resource file or by calling hasMipMap().</p>
</blockquote>
<p>&nbsp;</p>
<hr>
<p>#应用场景：</p>
<blockquote>
<p>If you know that you are going to draw this bitmap at less than 50% of its original size, you may be able to obtain a higher quality by turning this property on. Note that if the renderer respects this hint it might have to allocate extra memory to hold the mipmap levels for this bitmap.</p>
</blockquote>
<p>&nbsp;</p>
<hr>
<p>#一个应用实例：</p>
<blockquote>
<p>Nexus 6<br>  Screen<br>  The Nexus 6 boasts an impressive 5.96” Quad HD screen display at a resolution of 2560 x 1440 (493 ppi). This translates to ~ 730 x 410 dp (density independent pixels).</p>
<p>  Check your assets<br>  It has a quantized density of 560 dpi, which falls in between the xxhdpi and xxxhdpi primary density buckets. <strong>For the Nexus 6, the platform will scale down xxxhdpi assets</strong>, but if those aren’t available, then it will scale up xxhdpi assets.</p>
<p>  Provide at least an xxxhdpi app icon because devices can display large app icons on the launcher. It’s best practice to place your app icons in mipmap- folders (not the drawable- folders) because they are used at resolutions different from the device’s current density. For example, an xxxhdpi app icon can be used on the launcher for an xxhdpi device.</p>
<p>  res/<br>  mipmap-mdpi/<br>  ic_launcher.png<br>  mipmap-hdpi/<br>  ic_launcher.png<br>  mipmap-xhdpi/<br>  ic_launcher.png<br>  mipmap-xxhdpi/<br>  ic_launcher.png<br>  mipmap-xxxhdpi/<br>  ic_launcher.png # App icon used on Nexus 6 device launcher<br>  Choosing to add xxxhdpi versions for the rest of your assets will provide a sharper visual experience on the Nexus 6, but does increase apk size, so you should make an appropriate decision for your app.</p>
<p>  res/<br>  drawable-mdpi/<br>  ic_sunny.png<br>  drawable-hdpi/<br>  ic_sunny.png<br>  drawable-xhdpi/<br>  ic_sunny.png<br>  drawable-xxhdpi/ # Fall back to these if xxxhdpi versions aren’t available<br>  ic_sunny.png<br>  drawable-xxxhdpi/ # Higher resolution assets for Nexus 6<br>  ic_sunny.png</p>
</blockquote>
<p>#总结<br>这个实例总结一下是这样：<br>Nexus 6 有 493 ppi<br>它刚好在 xxhdpi和xxxhdpi之间<br>所以显示的时候需要对xxxhdpi的资源进行缩小<br>如果你用了mipmap-xxxhdpi,那么这里会对sclae有一个优化，性能更好，占用内存更少。</p>
<p>所以现在官方推荐使用mipmap</p>
<blockquote>
<p>It’s best practice to place your app icons in mipmap- folders (not the drawable- folders) because they are used at resolutions different from the device’s current density.</p>
</blockquote>
<p>&nbsp;</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-faceboo-list-performance-update" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/17/faceboo-list-performance-update/" class="article-date">
  	<time datetime="2015-03-17T06:01:52.000Z" itemprop="datePublished">2015-03-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/17/faceboo-list-performance-update/">关于 Facebook新闻页优化 的分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>关于 Facebook新闻页优化 的分析</p>
<p>#私货</p>
<p>简单一点概括，就是Facebook在ListView页面中，将原来的View-Model-Binder再次拆解成粒度更细的模型。</p>
<p>在原本的<code>View-Model-Binder</code>模型中，依靠将部分的View设置成<code>visible</code> 或 <code>gone</code> 来控制功能块的显示 （转帖/图片/etc）</p>
<p>在优化过的模型中，原本的View被拆解成更细粒度的小View，然后只加载需要的部分</p>
<p>原文没有提及，但应当是利用</p>
<pre><code>public int getItemViewType(int position) {
return 0;
}

public int getViewTypeCount() {
return 1;
}
</code></pre><p>实现的。</p>
<p>翻了一下ListView源代码</p>
<p>不同type的View被分类cache在RecycleBin中</p>
<pre><code>public void setViewTypeCount(int viewTypeCount) {
    if (viewTypeCount &amp;lt; 1) {
        throw new IllegalArgumentException(&quot;Can&apos;t have a viewTypeCount &amp;lt; 1&quot;);
    }
    //noinspection unchecked
    ArrayList&amp;lt;View&amp;gt;[] scrapViews = new ArrayList[viewTypeCount];
    for (int i = 0; i &amp;lt; viewTypeCount; i++) {
        scrapViews[i] = new ArrayList&amp;lt;View&amp;gt;();
    }
    mViewTypeCount = viewTypeCount;
    mCurrentScrap = scrapViews[0];
    mScrapViews = scrapViews;
}
</code></pre><p>参考RecycleBin的setViewTypeCount部分，此处用ArrayList[]来cache所有type的view</p>
<p>不过由于被设置成gone的View本身就不参与meaure和layout,也不会参与draw,只会额外占据一些内存。</p>
<p>所以Facebook做了这些优化以后  性能只提升了10%</p>
<p>在View的性能优化中，我觉得10%太少了，而新的模型复杂度变高了很多。</p>
<p>原本由于ViewType的原因，需要将Model和View的实现细节暴露在 Adapter中，Facebook这个优化实现似乎为了保持其封装性</p>
<p>于是将View-Model-Binder又通过Definition又封装了一层。</p>
<p>综合考虑的话….我觉得意义不大。</p>
<p>优化掉了一些无用View,但是增加了额外的中间层，很难说这样的改动是好是坏。</p>
<p>IOS开发可能更习惯View-Binder写法</p>
<p>Android开发可能会更习惯直接使用ViewHolder去操作</p>
<p>而Facebook这个写法更复杂，增加了额外的Definition层，Binder也根据ViewType被拆解成多个。</p>
<hr>
<p>考虑一下直接用最大粒度的View来做ViewType区分？</p>
<p>思考了一下….参考Faacebook或微博这个界面…应当是不行的…</p>
<p>同屏最多也就 2~4条 post</p>
<p>直接用Item做type区分的话….由于数据随机性的问题</p>
<p>cache会被经常性的加载和释放…..反而起不到作用…</p>
<p>使用细粒度的子View做type区分的话，在cache上有优势的多..</p>
<hr>
<p><strong>结论：有用，必要性不足。</strong></p>
<p><strong>鉴于这个Definition模型的复杂度，非微博，facebook,朋友圈类型的复杂Item，并不需要使用此优化方法。</strong></p>
<p><strong>正常使用View-model-binder模型就好了</strong></p>
<hr>
<p>中文版<br><a href="http://blog.aaapei.com/article/2015/02/facebookxin-wen-ye-listviewyou-hua" target="_blank" rel="external">http://blog.aaapei.com/article/2015/02/facebookxin-wen-ye-listviewyou-hua</a></p>
<p>&nbsp;</p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>android系统每隔16.7ms发出一个渲染信号，通知ui线程进行界面的渲染。为了达到流畅的体验，应用程序需要在这个时间内完成应用逻辑，使系统达到60fps。当一个Listview被添加到布局时，其关联的adapter的getView方法将会被回调。在16.7毫秒这样一个时间单元内，可见listitem单元的getView方法将被按照顺序执行。在大多数情况下，由于其他绘图行为的存在，例如measure和draw，getVIew实际分配到执行时间远低于16ms。一旦listview包含复杂控件时，在16毫秒内不能完成渲染，用户只能看到上一祯的结果，这时就发生了掉帧。</p>
<h3 id="Facebook新闻页介绍"><a href="#Facebook新闻页介绍" class="headerlink" title="Facebook新闻页介绍"></a>Facebook新闻页介绍</h3><p>Facebook的新闻页是一个复杂的listview控件，如何使它获得流畅的滚动体验一直困扰我们。 首先，新闻页的每一条新闻的可见区域非常大，包含一系列的文本以及照片；其次，新闻的展现类型也很多样，除了文本以及照片，新闻的附件还可包含链接、音频、视频等。除此之外，新闻还可以被点赞、被转载，导致一个新闻会被其他新闻包含在内。当新闻被大量用户转载时，甚至会出现一条新闻占据两个屏幕的情况。加上android用户的机型多为中低端设备，这使我们在16.7ms内完成新闻页的渲染变的非常困难。</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xpa1/t39.2365-6/10935993_1534797460105141_1373600061_n.png" alt=""></p>
<h3 id="新闻页最初架构"><a href="#新闻页最初架构" class="headerlink" title="新闻页最初架构"></a>新闻页最初架构</h3><p>在2012年，我们将新闻页从web-view转化成本地控件，在最初的那个版本中，基于View-Model-Binder设计模型，我们为新闻listitem创建了一个自定义StoryView类，这个类有一个bindModel方法，该方法用于和数据进行绑定。代码是这样的：</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xap1/t39.2365-6/10935990_1412843022342801_1297058886_n.png" alt="">StoryView的包含的子控件都会有一个bindModel方法，例如HeadVIew通过该方法与其相关的数据进行绑定。</p>
<p>这种设计，代码非常直观清晰，但他的缺点也很明显：</p>
<ul>
<li>listview复用机制不能有效的工作,Android’s recycling mechanism does not work well in this case: Every item in the ListView was usually a StoryView, but once bound to a story, two StoryViews would be radically different and recycling one into the other wasn’t effective.（这一段存疑，直接放原文）</li>
<li>逻辑嵌套：采用bindModel绑定控件和数据，业务逻辑与视图逻辑耦合，导致逻辑类层次非常深；</li>
<li>布局嵌套非常深：不但导致低效的视图渲染，例如新闻被不停的转载的极端场景下还会导致栈溢出；</li>
<li>bindModel方法逻辑过重：bindModel方法在当用户滚动列表时被ui线程回调，由于所有的数据解析都在这个方法内，导致该方法耗时</li>
</ul>
<p>以上这些问题虽有他们单独的解决方法，例如我们可以自己设计一套回收机制解决storyView复用问题。但基于维护成本和开发时间考虑，我们决定进行一次重构。</p>
<h3 id="重构方案"><a href="#重构方案" class="headerlink" title="重构方案"></a>重构方案</h3><p>重构工作大约是一年之前开始的，为了解决前一个架构的问题，首先我们决定将一条新闻分隔成多个listview item。例如，新闻的headerview将是一个独立的listitem。这样，我们可以利用android回收机制，HeaderView新闻子控件将被不同的新闻复用。另外，切分成小view也使得内存占用更小，在之前的架构中，Storyview部分的可见会导致这个Storyview被加载到内存中，而现在，粒度更小，只有可见的子控件才会被加载。</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xap1/t39.2365-6/10935983_984256741587871_980206636_n.png" alt=""></p>
<p>另一个大的修改是，我们将视图逻辑和数据逻辑分离，StoryView被分离成两个类： 只负责展现的视图类，以及一个Binder类。视图类仅包含set方法（例如HeaderView包含了setTitle，setSubTitle。setProfiePic等等）。Binder类包含了原来的bindMethod的逻辑，binder类包含三个方法：prepare，bind，unbind。 bind方法调用view的set方法设置数据，unbind清理视图数据，prepare方法在cpu空闲期间做一些预初始化工作，例如进行click事件绑定、数据格式化、创建spannable等等，它会在getView方法之前被调用 <img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xfp1/t39.2365-6/10956894_918624611495337_1619622974_n.png" alt=""></p>
<p>我们遇到的技术难点是Binder的设计，由于StoryView被拆分不同的子控件，一条新闻可能会包含多个不同的Binder。而在之前，我们只需要根据视图的树结构进行结构化赋值。因此，我们引进了<em>PartDefinition</em>类，PartDefinition负责维护一条新闻包含哪些子控件、包含Binder的类型以及为新闻创建Binder类，有两种类型的PartDefinition：单个PartDefinition以及PartDefinition集合。</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xfa1/t39.2365-6/10935981_1536551233276267_1103658334_n.png" alt=""></p>
<p>一个新闻在重构之后的PartDefinition结构是这样的：</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xaf1/t39.2365-6/10935975_856616717694467_1297407005_n.png" alt=""></p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ul>
<li>采取新的架构，内存错误减少了17%，总crash率减少了8%，彻底解决涨溢出问题</li>
<li>渲染时间减少了10%，大新闻场景不再掉帧</li>
<li>精简了原来的自定义回收机制，同时在重构过程中增加了单元测试</li>
</ul>
<p>&nbsp;</p>
<p>英文原文：</p>
<p><a href="https://code.facebook.com/posts/879498888759525/fast-rendering-news-feed-on-android/" target="_blank" rel="external">https://code.facebook.com/posts/879498888759525/fast-rendering-news-feed-on-android/</a></p>
<p>&nbsp;</p>
<p>If you work on an Android app (or any touch screen based app actually), there’s a very good chance you have at least one activity based on a ListView. In many cases, it may be the screen of your app where users interact with the app the most. In the case of Facebook for Android, this ListView is your News Feed. Keeping News Feed working well in Facebook’s Android app presents a variety of engineering challenges starting with performance considerations for touchscreens.</p>
<h2 id="Why-ListView-Gets-Complicated"><a href="#Why-ListView-Gets-Complicated" class="headerlink" title="Why ListView Gets Complicated"></a>Why ListView Gets Complicated</h2><p>ListView presents an interesting performance problem that wasn’t as dominant on non-touch interfaces - the smoothness of the scrolling experience. Users expect that the content will seamlessly keep pace with their fingers as they scroll on a touchscreen. This need wasn’t as important when using a keyboard and mouse.</p>
<p>To get your list to appear as if it scrolls smoothly, you need to render about 60 frames of it per second. Basic arithmetic translates this challenge into rendering one frame in under 16.7 milliseconds. This is pretty easily done for most frames with the exception of a notable subset. Whenever a new view goes into the viewport in your ListView, the ListView will call its adapter’s<code>getView</code> method. That method, in turn, has to get a view, and bind all its content into it in less than 16.7ms. (In fact, since other actions have to happen, such as measuring and drawing, there’s even less time). This is easily achievable for simple content, such as the views that contain text only. It becomes challenging when trying to render rich content which contains complicated views — a lot of text and images, for example. Android’s simple tool to solve this is view recycling: The adapter’s<code>getView</code> method will get an existing <code>convertView</code> to use if one was made before. This trick works very well, but only when your views are similar to each other.</p>
<h2 id="Rendering-the-Facebook-News-Feed"><a href="#Rendering-the-Facebook-News-Feed" class="headerlink" title="Rendering the Facebook News Feed"></a>Rendering the Facebook News Feed</h2><p>Facebook’s News Feed, a popular screen in the Facebook for Android app, is an extreme example of a complicated ListView. This makes delivering a smooth scrolling experience especially hard.</p>
<p>First, each story you see in the feed is pretty tall, and contains several pieces of text and photos. This makes the challenge of binding all of the story’s data without skipping frames significantly harder.</p>
<p>Secondly, there are multiple variations of stories in your feed. Aside from a simple story containing some text and a photo, you can see multiple variations of attachments: a preview for a link, an album, a video, etc. The story might be shared, in which case the story contains another story inside it. Hardest of all, we need to render aggregated stories which means one story can actually be composed of several stories that are related. A good example of this is when many of your friends wish you a happy birthday. These aggregated stories are the most challenging to render, as one of them can easily be twice as tall as the screen of the device.</p>
<p>As an extra challenge, the typical Android phone is not a high-end device. So the amount of computations you can fit in under 16.7ms is likely less than the amount on the majority of phones you develop on.</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xpa1/t39.2365-6/10935993_1534797460105141_1373600061_n.png" alt=""></p>
<h2 id="How-it-used-to-work"><a href="#How-it-used-to-work" class="headerlink" title="How it used to work"></a>How it used to work</h2><p>Around 2012, we started working on converting News Feed from a web-view based solution to native rendering. We knew this was going to be a complicated task due to the sheer number of features news feed supported already at that time. Our design was based on the following concept: For every piece of a story in the feed, we created a custom view class. That custom view class would have a method called <code>bindModel</code> which would take the object this view was supposed to display and update the view to display it.</p>
<p>So, this meant to display a story we had a <code>StoryView</code> class, which among other things, had a<code>HeaderView</code> inside it to display the header of the story.</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xap1/t39.2365-6/10935990_1412843022342801_1297058886_n.png" alt=""></p>
<p>This approach was simple and intuitive for finding the right piece of code or knowing where to add it, but had various drawbacks:</p>
<ul>
<li>Android’s recycling mechanism does not work well in this case: Every item in the ListView was usually a <code>StoryView</code>, but once bound to a story, two <code>StoryViews</code> would be radically different and recycling one into the other wasn’t effective.</li>
<li>Complicated hierarchies: Using a <code>bindModel</code> method inside views meant coupling the business logic with the layout logic. Once something as complicated as a view for displaying a story existed, it was natural to subclass it when you needed a variation of that logic. This resulted in a complicated and hard to navigate hierarchy of classes, which is something to avoid.</li>
<li>Deep-View hierarchy: Logically grouping things meant putting them inside the same view which resulted in a very deep hierarchy of views. This means worse performance for Android when measuring views, and in extreme cases meant actual crashes due to stack overflows of the number of views. This cases tended to happen in something as an aggregated story, where the recursive “story in a story” rendering caused a very deep hierarchy.</li>
<li>Computationally-intensive method: There is no nice and consistent way to execute code before<code>bindModel</code> is called. Since <code>bindModel</code> is called while the user is scrolling, it’s a pretty bad time to do heavy work. Since this is the place where you unpack a complicated story object into the various parts, that would not always be the case, which made <code>bindModel</code> a computationally intense method to run for some of the views.</li>
</ul>
<p>All of these problems were solvable, but each required its own custom solution, which took time, and made maintenance more complicated. For example, to solve the recycling problem we had to implement our own custom recycler to work on top of the list view. With that in mind, we decided to rewrite our rendering code to avoid these pitfalls.</p>
<h2 id="Making-News-Feed-Scrolling-Smoother"><a href="#Making-News-Feed-Scrolling-Smoother" class="headerlink" title="Making News Feed Scrolling Smoother"></a>Making News Feed Scrolling Smoother</h2><p>About a year ago we felt it was the time to invest in a new architecture for our rendering code for News Feed. We knew we wanted to avoid the pitfalls of the previous design, and try to get rid of our more fragile code. For that purpose we considered a new idea: Splitting each story in the News Feed to several items in the ListView. Using this idea, the header part of a story will be its own item in the ListView. This nice trick results in various advantages right away. First, this makes Android’s recycling effective again. If before two custom views for a story were two different to have one recycled into the other, now, recycling is happening on a sub story level.</p>
<p>So a story’s header view is being recycled with a different header, and these have the same layout. The second big advantage is that splitting the views lets us store less views in memory, and bind a story over several frames. If before a huge aggregated story presented a difficult task of binding it without skipping a frame, now this story is split into many parts, and only one of those needs to be bound during frame. This effectively amortizes the binding time for a story over several frames, resulting in less skipped frames.</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xap1/t39.2365-6/10935983_984256741587871_980206636_n.png" alt=""></p>
<p>The other idea we incorporated to the design is decoupling the binding logic from the custom Views themselves. For this purpose we basically split our previous custom view into two classes: A simpler “dumb” custom view, and a Binder class. The custom view is now limited to a basic set of setters (such as “setTitle”, “setSubtitle” and “setProfilePic” for the header) and is unaware of a story object. The binder class is the replacement for the <code>bindModel</code> method. It has three methods: <code>prepare</code>, <code>bind</code>, and <code>unbind</code>. The <code>bind</code> method takes a view and sets the right info from the story on it, the <code>unbind</code>reverses this and does cleanup which might be necessary (usually it’s not needed) and lastly, the<code>prepare</code> method is meant to solve the issue of performing hard work during binding time. It is called before the first time a binder is bound, and intelligently scheduled when there’s free CPU time on the UI thread. This makes it ideal for allocating click listeners, formatting strings, building spannables and so forth.</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xfp1/t39.2365-6/10956894_918624611495337_1619622974_n.png" alt=""></p>
<p>To make our adapter work, we just need to generate the right list of binders. This is not a simple task; there are many types of binders, and each story has a different number of them according to the parts it should render. In the previous design, this was solved by the hierarchy of views, but now that there’s no “one view” per story we needed to create it in a different way. We decided to do this by creating a <code>PartDefinition</code> class to define each possible part of a story. There are two types of part definitions: A single part definition which defines what views it needs, whether it is needed for a specific story, and how to create the correct binder for it. The second type is a group part definition that lets us logically group several parts into one.</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xpf1/t39.2365-6/10935981_1536551233276267_1103658334_n.png" alt=""></p>
<p>Using these classes we rebuilt the hierarchy of parts of a story. Now to generate the list of binders for a story, we simply start from the root part and recursively expand it to the list of single parts, which we then use to generate binders.</p>
<p><img src="https://fbcdn-dragon-a.akamaihd.net/hphotos-ak-xaf1/t39.2365-6/10935975_856616717694467_1297407005_n.png" alt=""></p>
<p>This rewrite effort has resulted in many benefits:</p>
<ul>
<li>The number of out-of-memory errors experienced by people using Facebook has been reduced by 17% and the number of total errors was reduced by 8%. Some errors, such as stack overflows in the view hierarchy have disappeared.</li>
<li>The maximum time it takes to render a frame was reduced by 10%, after additional optimizations and removal of custom recycling code that were no longer needed. Additional simplifications are expected to improve by such amounts once more. Big jumps that resulted from loading a tall complicated story have disappeared.</li>
<li>We were able to simplify reusing our feed code with different layouts, which helped in the creation of the stand alone app for Facebook Groups on Android.</li>
<li>The new design has lent itself to improving our code quality. More teams can contribute to News Feed while being sandboxed from other teams working on parallel features. We also used this opportunity to make sure our code is testable and well covered. The new feed code has a line coverage with unit tests of 70% compared to 17% in the old code.</li>
</ul>
<p>This has been a great undertaking to replace such a core piece of code seamlessly, but the hard work was worth it as it paid of both in improving the performance, and the reliability and maintainability of the code.</p>
<hr>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-speed-up-android-studio-gradle-build" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/16/speed-up-android-studio-gradle-build/" class="article-date">
  	<time datetime="2015-03-16T08:48:01.000Z" itemprop="datePublished">2015-03-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/16/speed-up-android-studio-gradle-build/">Android Studio Gradle构建速度优化</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.</p>
<p><a href="https://www.timroes.de/2013/09/12/speed-up-gradle/" target="_blank" rel="external">https://www.timroes.de/2013/09/12/speed-up-gradle/</a></p>
<p>create a file named <strong>gradle.properties</strong> in the following directory:</p>
<ul>
<li>/home/&lt;username&gt;/.gradle/ (<em>Linux</em>)</li>
<li>/Users/&lt;username&gt;/.gradle/ (<em>Mac</em>)</li>
<li>C:\Users\&lt;username&gt;.gradle (<em>Windows</em>)<br>Add this line to the file:</li>
</ul>
<pre><code>org.gradle.daemon=true
</code></pre><p>From now on Gradle will use a daemon to build, whether you are using Gradle from command line or building in Android Studio. You could also place the <strong>gradle.properties</strong> file to the root directory of your project and commit it to your SCM system. But you would have to do this, for every project (if you want to use the daemon in every project).</p>
<p>关于这个写法有几个变种，都尝试了一下，并没有用。</p>
<p>参考Android Studio配置选项</p>
<p><img src="/images/gradle-build-speed-up-android-studio-setting.png" alt="speed-up-gradle"></p>
<p>Android Studio 1.1.0+版本中该配置已经默认打开。</p>
<hr>
<p>2.<br>用命令行Build</p>
<p>可以参考这个讨论串<br><a href="https://plus.google.com/u/0/+RicardoAmaral/posts/e9PG6vSN5w3" target="_blank" rel="external">https://plus.google.com/u/0/+RicardoAmaral/posts/e9PG6vSN5w3</a></p>
<p>gradle assembleDebug<br>实测速度快50%左右 原理不明<br>回头写个脚本 build完成再自动安装运行应该就好了</p>
<p>更新下</p>
<p>gradle installDebug 就可以了，不用自己在gradle里搞task了，省事.<br>明天测试下性能</p>
<hr>
<p>3.<br>Android模块化编程之引用本地的aar<br><a href="http://stormzhang.com/android/2015/03/01/android-reference-local-aar/" target="_blank" rel="external">http://stormzhang.com/android/2015/03/01/android-reference-local-aar/</a></p>
<p>目前把项目中引用的Library都打成了本地aar，减少编译的文件，编译速度显著加快</p>
<hr>
<p>4.<br>我觉得TMD还是把公司的破电脑扔了换个新的才能从根本上解决问题</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-galaxy" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/03/01/galaxy/" class="article-date">
  	<time datetime="2015-02-28T23:03:07.000Z" itemprop="datePublished">2015-03-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/03/01/galaxy/">Galaxy</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/galaxy-high.png" alt="galaxy-high"></p>
<p><img src="/images/galaxy-low.png" alt="galaxy-low"></p>
<p><a href="https://github.com/dkmeteor/Galaxy" target="_blank" rel="external">https://github.com/dkmeteor/Galaxy</a></p>
<p>从<a href="https://android.googlesource.com/platform/packages/wallpapers/Galaxy4/" target="_blank" rel="external">https://android.googlesource.com/platform/packages/wallpapers/Galaxy4/</a> clone出来</p>
<p>然后转成了 gradle 工程</p>
<p>之前就吐槽 RenderScript在 Gradle里集成多蛋疼…..</p>
<p>源码库里那个Galaxy4工程是和源码一起编译的….不受 @hide 标识影响</p>
<p>但是我要build就发现…….在SDK21里 全是@hide 的class</p>
<p>试了半天….发现只能用 SDK 17编译….这玩意也没个集成文档</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-gradle-build-renderscript" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/02/27/gradle-build-renderscript/" class="article-date">
  	<time datetime="2015-02-27T07:49:21.000Z" itemprop="datePublished">2015-02-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/27/gradle-build-renderscript/">Gradle编译RenderScript</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Gradle编译RenderScript</p>
<p>有点操蛋，现在官方文档上还是eclipse上的集成方式</p>
<p><a href="https://android.googlesource.com/platform/frameworks/rs/" target="_blank" rel="external">https://android.googlesource.com/platform/frameworks/rs/</a></p>
<p>demo更不知道是哪年的版本</p>
<p>早先还有各种指定renderscript.srcDirs = [‘src’] 的写法</p>
<p>随着Gradle和plugin的更新…这破写法一天一变….网上能搜到一打的不一样的写法…没几个能用的…</p>
<hr>
<p>比较正确的请参考这个</p>
<p><a href="http://stackoverflow.com/questions/19658145/how-to-use-the-renderscript-support-library-with-gradle/22976675#22976675" target="_blank" rel="external">http://stackoverflow.com/questions/19658145/how-to-use-the-renderscript-support-library-with-gradle/22976675#22976675</a></p>
<p>以我的项目为例<br>目前是这样的</p>
<pre><code>apply plugin: &apos;com.android.application&apos;

android {
compileSdkVersion 21
buildToolsVersion &quot;21.1.2&quot;

defaultConfig {
applicationId &quot;com.dk.heartbeats&quot;
minSdkVersion 17
targetSdkVersion 21
versionCode 1
versionName &quot;1.0&quot;
renderscriptTargetApi 19
renderscriptSupportModeEnabled false
}

buildTypes {
release {
minifyEnabled false
proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;
}
}

}

dependencies {
compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])
compile &apos;com.android.support:appcompat-v7:21.0.3&apos;
compile &apos;com.jakewharton:butterknife:6.0.0&apos;
compile files(&apos;libs/jtransforms-2.4.jar&apos;)
compile files(&apos;libs/renderscript-v8.jar&apos;)
}
</code></pre><p>注意这个<br><code>renderscriptSupportModeEnabled true</code><br>和<br><code>compile files(&#39;libs/renderscript-v8.jar&#39;)</code></p>
<p>原则上 当你设置了 <code>renderscriptSupportModeEnabled true</code><br>gradle应当自动将 v8挂载到项目中，不需要自己去把renderscript-v8.jar拷过来</p>
<p>但是我设置了以后 sync gradle / clean / build 以后依然提示我v8 not found…无奈之下自己把v8 jar拷到lib目录下编译</p>
<p>顺便 这个 renderscript-v8.jar在 <code>SDK\build-tools\21.1.2\renderscript\lib</code> 下</p>
<p>没想到的是…这个时候这破玩意好了又告诉我multiply dex……</p>
<p>没办法 我又把上面的关了…</p>
<p>反正这2个使用任意一个应该就可以了….</p>
<hr>
<p>renderscriptTargetApi 19</p>
<p>这个 必须要</p>
<hr>
<p>你们如果看过以前的工程的话…会发现.rs文件都是直接仍在包名下<br>比如官方Demo里的 yuv.rs就直接扔在 com.android.rs.livepreview 下面</p>
<p>同时，早期Gradle版本可以通过</p>
<pre><code>sourceSets {
    main {
        manifest.srcFile &apos;AndroidManifest.xml&apos;
        java.srcDirs = [&apos;src&apos;]
        resources.srcDirs = [&apos;src&apos;]
        aidl.srcDirs = [&apos;src&apos;]
        renderscript.srcDirs = [&apos;src&apos;]
        res.srcDirs = [&apos;res&apos;]
        assets.srcDirs = [&apos;assets&apos;]
    }

instrumentTest.setRoot(&apos;tests&apos;)
}
</code></pre><p>指定编译路径<br>恩<br>注意</p>
<p>renderscript.srcDirs = [‘src’]</p>
<p>遗憾的是我实验了一下自己指定renderscript路径毫无反应。<br>查找了一些资料以后发现需要直接扔在<br>rs文件夹下…</p>
<p>项目结构像这样</p>
<pre><code>--app
--builds
--libs
--src
    --android test
    --main
        --java
        --res
        --rs
        AndroidManifest.xml
</code></pre><p>意会一下…就是默认gradle项目格式…放在和java同层的rs文件夹里才会生成对应的<code>ScriptC_yuv.java</code>文件</p>
<p>这个文件在<br><code>{project folder}\app\build\generated\source\rs\debug\{package name}\</code> 下</p>
<hr>
<p>官方不打算出一个正式的 Gradle 集成 RenderScript的Guide并保持更新么？<br>这集成方式一版本一变上下不兼容简直醉了</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-solve-scrollview-gridview-conflict-for-auto-scroll" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/02/27/solve-scrollview-gridview-conflict-for-auto-scroll/" class="article-date">
  	<time datetime="2015-02-27T06:29:01.000Z" itemprop="datePublished">2015-02-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/27/solve-scrollview-gridview-conflict-for-auto-scroll/">ScrollView 中嵌套 GridView 导致 ScrollView 默认不停留在顶部的解决方案和分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>ScrollView</code>中嵌套 <code>GridView</code> 导致 <code>ScrollView</code> 默认不停留在顶部的解决方案和分析</p>
<p>发生情况大概是我在ScrollView顶部放了一个ViewPager用来做广告Banner,底部放了个GridVie, 来实现一个类似9宫格效果的展示.</p>
<p>然后出现的状况是,当我获取完数据并调用notifyDataSetChanged();后 ScrollView自动滚到了最底部,也就是GridView所在的位置.</p>
<p>研究了一下,获取了一些解决方案</p>
<p>– 让界面顶部的某一个View获取focus<br>– grid.setFocusable(false);<br>– 手动scrollto(0,0)<br>– 重写ScrollView中的computeScrollDeltaToGetChildRectOnScreen,让该方法返回0</p>
<p>目前简单的用setFocusable(false)解决了该问题</p>
<p>试着分析一下这个问题产生的原因. 从解决方案反推,可以发现这个问题和 <code>focus</code> 有关系</p>
<p>一个猜测是 notifyDataSetChanged()之后,grid由于加载了数据的关系高度产生了变化</p>
<p>这导致了ScrollView内部重新走了 onLayout / onMeaure 流程 在这个流程中 ScrollView会将自身滚动到 获得 focus 的 child 位置</p>
<p>上面关于focus的解决方案即是从这个角度去解决问题</p>
<p>跟踪一下调用链</p>
<pre><code>protected void onLayout(boolean changed, int l, int t, int r, int b) {
 super.onLayout(changed, l, t, r, b);
 mIsLayoutDirty = false;
 // Give a child focus if it needs it
 if (mChildToScrollTo != null &amp;&amp; isViewDescendantOf(mChildToScrollTo, this)) {
 scrollToChild(mChildToScrollTo);
 }
 ...
}
</code></pre><p>可以看到 onLayout 的时候确实会将ScrollView滚动到focus child位置</p>
<pre><code>private void scrollToChild(View child) {
 child.getDrawingRect(mTempRect);

 /* Offset from child&apos;s local coordinates to ScrollView coordinates */
 offsetDescendantRectToMyCoords(child, mTempRect);

 int scrollDelta = computeScrollDeltaToGetChildRectOnScreen(mTempRect);

 if (scrollDelta != 0) {
 scrollBy(0, scrollDelta);
 }
}
</code></pre><p>从代码逻辑上来看 避免 GridView获取focus可以解决该问题.</p>
<p>而重写ScrollView中的computeScrollDeltaToGetChildRectOnScreen则是从另一个角度解决该问题</p>
<p>而scrollToChild这个方法会根据computeScrollDeltaToGetChildRectOnScreen的返回值来计算滚动的位置</p>
<p>重载computeScrollDeltaToGetChildRectOnScreen让其返回0 会导致ScrollView内布局产生变化时,不能正确滚动到focus child位置,当然,这也就是我们想要的效果,布局变化时ScrollView不需要自己去滚动.</p>
<p>至于computeScrollDeltaToGetChildRectOnScreen代码太长就不贴了</p>
<p>大致代码是 根据当前 scrollY和focus child 的 rect.bottom 去计算要滚到哪</p>
<p>逻辑理顺以后觉得这个问题也没什么奇怪的.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 DK
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>