<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DK&#39;s Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="DK's Lab">
<meta property="og:url" content="http://blog.dk-exp.com/page/4/index.html">
<meta property="og:site_name" content="DK's Lab">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DK's Lab">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="DK&#39;s Lab" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?47d977b9cd46d5988a3e06ada67a7fa9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">DK</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/circle/" style="font-size: 10px;">circle</a> <a href="/tags/list/" style="font-size: 10px;">list</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">DK</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">DK</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-solve-scrollview-gridview-conflict-for-auto-scroll" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/02/27/solve-scrollview-gridview-conflict-for-auto-scroll/" class="article-date">
  	<time datetime="2015-02-27T06:29:01.000Z" itemprop="datePublished">2015-02-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/27/solve-scrollview-gridview-conflict-for-auto-scroll/">ScrollView 中嵌套 GridView 导致 ScrollView 默认不停留在顶部的解决方案和分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>ScrollView</code>中嵌套 <code>GridView</code> 导致 <code>ScrollView</code> 默认不停留在顶部的解决方案和分析</p>
<p>发生情况大概是我在ScrollView顶部放了一个ViewPager用来做广告Banner,底部放了个GridVie, 来实现一个类似9宫格效果的展示.</p>
<p>然后出现的状况是,当我获取完数据并调用notifyDataSetChanged();后 ScrollView自动滚到了最底部,也就是GridView所在的位置.</p>
<p>研究了一下,获取了一些解决方案</p>
<p>– 让界面顶部的某一个View获取focus<br>– grid.setFocusable(false);<br>– 手动scrollto(0,0)<br>– 重写ScrollView中的computeScrollDeltaToGetChildRectOnScreen,让该方法返回0</p>
<p>目前简单的用setFocusable(false)解决了该问题</p>
<p>试着分析一下这个问题产生的原因. 从解决方案反推,可以发现这个问题和 <code>focus</code> 有关系</p>
<p>一个猜测是 notifyDataSetChanged()之后,grid由于加载了数据的关系高度产生了变化</p>
<p>这导致了ScrollView内部重新走了 onLayout / onMeaure 流程 在这个流程中 ScrollView会将自身滚动到 获得 focus 的 child 位置</p>
<p>上面关于focus的解决方案即是从这个角度去解决问题</p>
<p>跟踪一下调用链</p>
<pre><code>protected void onLayout(boolean changed, int l, int t, int r, int b) {
 super.onLayout(changed, l, t, r, b);
 mIsLayoutDirty = false;
 // Give a child focus if it needs it
 if (mChildToScrollTo != null &amp;&amp; isViewDescendantOf(mChildToScrollTo, this)) {
 scrollToChild(mChildToScrollTo);
 }
 ...
}
</code></pre><p>可以看到 onLayout 的时候确实会将ScrollView滚动到focus child位置</p>
<pre><code>private void scrollToChild(View child) {
 child.getDrawingRect(mTempRect);

 /* Offset from child&apos;s local coordinates to ScrollView coordinates */
 offsetDescendantRectToMyCoords(child, mTempRect);

 int scrollDelta = computeScrollDeltaToGetChildRectOnScreen(mTempRect);

 if (scrollDelta != 0) {
 scrollBy(0, scrollDelta);
 }
}
</code></pre><p>从代码逻辑上来看 避免 GridView获取focus可以解决该问题.</p>
<p>而重写ScrollView中的computeScrollDeltaToGetChildRectOnScreen则是从另一个角度解决该问题</p>
<p>而scrollToChild这个方法会根据computeScrollDeltaToGetChildRectOnScreen的返回值来计算滚动的位置</p>
<p>重载computeScrollDeltaToGetChildRectOnScreen让其返回0 会导致ScrollView内布局产生变化时,不能正确滚动到focus child位置,当然,这也就是我们想要的效果,布局变化时ScrollView不需要自己去滚动.</p>
<p>至于computeScrollDeltaToGetChildRectOnScreen代码太长就不贴了</p>
<p>大致代码是 根据当前 scrollY和focus child 的 rect.bottom 去计算要滚到哪</p>
<p>逻辑理顺以后觉得这个问题也没什么奇怪的.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-blur-drawer" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/02/08/blur-drawer/" class="article-date">
  	<time datetime="2015-02-08T07:56:18.000Z" itemprop="datePublished">2015-02-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/08/blur-drawer/">Blur-Drawer</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/blur-drawer.gif" alt="blur-drawer"></p>
<p><a href="https://github.com/charbgr/BlurNavigationDrawer" target="_blank" rel="external">https://github.com/charbgr/BlurNavigationDrawer</a></p>
<p>对客户这个UX实在心里没底….赶紧了找了套备胎先放着….</p>
<p>回头让我再改我就用这一套…</p>
<p>这一套代码和我的Folder-DrawerLayout一样 是直接从android.support.v4.widget.DrawerLayout继承下来的…</p>
<p>兼容和升级会非常方便</p>
<p>Blur算法部分和我常用的那一套也一样。。。高版本走RenderScript，低版本用StackBlur…支持先ScaleDown再Blur..性能也OK..不用再做额外的性能优化..</p>
<p>考虑到Blur半径比较大…其实Scale还可以开大一点…</p>
<hr>
<p>目前看来唯一一个问题是 Blur的触发点在ActionBarDrawerToggle里的onDrawerSlide里….</p>
<p>项目目前把ActionBar干掉了…也没用ToolBar    顶上现在是个自定义Header….</p>
<p>不知道会有多大影响。。。</p>
<p>不过最坏情况也不过把这部分逻辑摘出来扔在Drawerlayout的Listener里…时间上考虑还比较safe.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-run-rm---rf-on-Android" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/02/05/run-rm---rf-on-Android/" class="article-date">
  	<time datetime="2015-02-05T07:23:17.000Z" itemprop="datePublished">2015-02-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/05/run-rm---rf-on-Android/">在Android上执行 rm -rf /</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>和人讨论在Android上执行linux的命令问题。</p>
<p>于是试了试每个人都会试的 rm -rf /</p>
<p>过程略去</p>
<p>最终结果代码是这样</p>
<pre><code>Process process = null;
DataOutputStream os = null;
try {
    process = Runtime.getRuntime().exec(&quot;su&quot;);
    os = new DataOutputStream(process.getOutputStream());
    os.writeBytes(&quot;rm -rf /&quot; + &quot;\n&quot;);
    os.writeBytes(&quot;exit\n&quot;);
    os.flush();
    process.waitFor();

} catch (IOException e) {
    e.printStackTrace();
} catch (InterruptedException e) {
    e.printStackTrace();
} finally {
    if (os != null)
        try {
            os.close();
        } catch (IOException e) {
            e.printStackTrace();
        }
    process.destroy();
}
</code></pre><p>主要麻烦是玩坏了就要重建虚拟机…好在Genymotion启动速度还可以</p>
<p>比较奇怪的时候 成功执行以后</p>
<p>系统黑屏 卡死 无反应</p>
<p>但是重启以后，系统居然回到未初始化状态…类似于 恢复出厂设置 的结果……</p>
<p><img src="/images/rm.jpg" alt="rm"></p>
<p>真机未测试…看有没有勇者试一下…变砖了本人不负任何责任….</p>
<hr>
<p>本来计划看一下galaxy.rs的脚本….但是这几天状态太差……感觉需要调整一下作息…….</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a><a class="article-category-link" href="/categories/android/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-use-ioc-in-android" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/28/use-ioc-in-android/" class="article-date">
  	<time datetime="2015-01-28T08:21:10.000Z" itemprop="datePublished">2015-01-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/28/use-ioc-in-android/">是否有必要在Android项目中使用IOC框架</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本来只是想找个注解库用一下<br>结果顺便看了看相关的库</p>
<p>首先是<br>butterknife   <a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="external">https://github.com/JakeWharton/butterknife</a></p>
<p>在任何项目中使用butterknife都是正确且没有问题的. 非常轻量级的库.<br>可以缩减一部分代码.<br>不过对一般应用而言..90%的时间是处理业务逻辑….View binding这种工作量其实很小…而且在IDE有代码提示的情况下其实也不会多敲几下键盘,  findviewById(R.id.text)<br>有智能提示的比如 AS 打 fv然后回车就好了…..对比 InjectView(R.id.text)</p>
<p>onClick绑定一般会用公共的OnClickListener写在一起然后用Switch Case去区分每个按钮的事件..<br>阅读性上还可以…也不算复杂….用butterknife可以直接做方法绑定…略微方便了一点点.</p>
<p>总统而言  便捷性上和可阅读性上有一定提升,虽然推荐使用,但是影响没有大到一定要用的地步.</p>
<p>其次是<br>Dagger <a href="https://github.com/square/dagger" target="_blank" rel="external">https://github.com/square/dagger</a></p>
<p>Dagger其实和butterknife一样也是<span style="color: #999999;"> </span><span style="color: #444444;"><a href="https://github.com/JakeWharton" target="_blank" rel="external">JakeWharton</a> 写的, 算是一家的产品吧.</span><br><span style="color: #444444; font-family: Helvetica, arial, freesans, clean, sans-serif, 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: small;">View binding注解部分和</span>butterknife几乎一致.可以认为没有区别.<br>Dagger额外提供了 IOC框架 功能</p>
<p>最后是<br>RoboGuice <a href="https://github.com/roboguice/roboguice" target="_blank" rel="external">https://github.com/roboguice/roboguice</a>  和<br>google guice <a href="https://github.com/google/guice" target="_blank" rel="external">https://github.com/google/guice</a></p>
<p>据说 Dagger2.0 也被移交给Google管理了</p>
<p>RoboGuice在View Binding上和以上2个库没有区别<br>也额外提供了 IOC框架功能</p>
<p>它和 Dagger 的区别是<br>RoboGuice 是 运行时 通过反射实现的IOC<br>Dagger 是通过 <span style="color: #333333;">APT(Annotation Process Tool)  在运行时 生成辅助类 实现的 IOC</span><br><span style="color: #333333;"> </span><br><span style="color: #333333;">原理上来讲 Dagger性能当然比 </span>RoboGuice 要好…但是 如果不是大量通过IOC生成对象…<br>仅仅普通使用应当差别可以忽略不计..未测试…</p>
<hr>
<p>以上都是背景…下面进入正题…</p>
<p>不考虑RoboGuice和Dagger对代码的精简作用,是否有必要在Android上使用IOC框架?<br>(因为只考虑代码精简的话,butterknife就可以了….IOC更多的是设计上的考虑)</p>
<p>首先把这个文章看了2遍<br><a href="https://github.com/android-cn/android-open-project-analysis/tree/master/dagger" target="_blank" rel="external">https://github.com/android-cn/android-open-project-analysis/tree/master/dagger</a></p>
<p>又翻了一下Spring中使用IOC的例子…</p>
<p>IOC的核心是解耦…<br>解耦的目的是 …. 修改耦合对象时不影响另外一个对象…降低模块之间的关联</p>
<p>从Spring来看…..在Spring中IOC更多的是依靠 xml的配置…</p>
<p>而以上Android上的IOC框架均不使用xml配置系统….而且也没有必要….<br>毕竟不是web要去考虑server/system/db/web容器的差异…</p>
<p>常见的例子..</p>
<p><pre class="lang:default decode:true ">public class MainActivity extends Activity {<br>    @Inject Boss boss;<br>    …<br>}</pre><br>&nbsp;</p>
<p>就看 <a href="https://github.com/rengwuxian" target="_blank" rel="external">扔物线</a> 写的这个例子好了..</p>
<p>对于这个设计而言…谁被解耦了?</p>
<p>MainActivity和Boss被解耦了…..更确切的讲….MainActivity和Boss的构造方法解耦了…<br>如果你下面需要使用Boss对象,仍然需要调用Boss中的方法…那么Boss和MainActivity依然存在依赖关系..<br>好处是,我修改Boss的构造方法不会影响MainActivity了…我可以修改Provider去自己获取参数..<br>仅此而已?</p>
<p>Android中 Activity 一般不会参与复用..你不会去再写一个Activity继承MainActivity,也不会去生成多个MainActivity….即使同时存在多个MainActivity实例也是归系统管理..和你没有关系…. 所有通常我认为只有Boss是会复用的会变化的会被继承的…MainActivity的变化只和它自身有关系,不会影响系统中其它部分..</p>
<p>仔细思考,即使是在IOC框架中,耦合性也并没有消失,只是将耦合的部分从 Class之间转移到了 Class和IOC容器之间<br>回到上面这个部分…</p>
<p>你觉得 Activity 在 Android app中 处于 一个什么角色??<br>Activity不能充当容器角色么?</p>
<p>UI / 业务逻辑 / DB / Conection / Cache<br>所有组件都只和Activity产生依赖关系,互相之间互不影响….</p>
<p>在Activity外再嵌套一层IOC容器来解耦偶到底有无必要?<br>Activity为什么还需要解耦?</p>
<p>画一下2个模型图</p>
<p><img src="/images/IOC.png" alt="IOC"></p>
<p>有区别?<br>我构造一个场景<br>Activity需要做请求网络的操作,操作完成后写DB和Cache,IOC给你注入一个 HttpMananger / DBManager / CacheManager 又如何,你不要调用它们的方法吗? 耦合性并没有降低。</p>
<hr>
<p>总之我认为在这样的典型场景下使用IOC并无必要，因为目前为止我看到的Android上使用IOC的例子均是类似这样注入一个单例/工程 管理类。</p>
<p>如果其中某一个模块复杂度非常高，可以被分离成多个子模块，那么在子模块间使用IOC进行解耦是很不错的方案。遗憾的是，目前没遇到这样的应用。</p>
<p>我猜想在某一个专业领域非常深入的应用可能会更需要这样的功能。</p>
<p>比如图像处理应用。使用颜色渲染器，光线渲染，分层/块/区处理，自动裁切，构造Gif/短视频 等等等，其在单一功能上流程长复杂度高，那么使用IOC分离这些模块非常棒。</p>
<p>遗憾的是目前我常做的这些 社交/电商 应用 在层级上非常非常浅，更多的UI/交互/业务逻辑 之类的玩意，这些东西属于很恶心很麻烦，但是不复杂也不难的东西。</p>
<p>恩。。。发到SegmenFault看看别人是什么看法。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-renderscript" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/26/renderscript/" class="article-date">
  	<time datetime="2015-01-25T20:45:44.000Z" itemprop="datePublished">2015-01-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/26/renderscript/">一个RenderScript效果分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/rs-youyube.png" alt="rs"></p>
<p>填个坑…很早以前就知道这个效果,当时只知道是用RenderScript做的..</p>
<p>正好有空研究一下 , 翻了一下RenderScript的资料…..这个效果最早的出处应该就是这个PPT了</p>
<p><a href="http://pan.baidu.com/s/1kT0zTiR" target="_blank" rel="external">PPT</a></p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>把图片放大又看了一下….我犯了个错误…误以为这是个球面…..就像 黑客帝国 里 球形监控室 的效果….</p>
<p>其实不是的…….所以用 HorizonList/Grid/RecyclerView 配合Transform Matrix就可以了……..</p>
<p>看这个设计也只能横向滚动,而不是可360°滚动的….我想多了…毕竟是11年的东西….</p>
<hr>
<p>&nbsp;</p>
<h1 id="假设是球面效果的话"><a href="#假设是球面效果的话" class="headerlink" title="假设是球面效果的话"></a>假设是球面效果的话</h1><p>&nbsp;</p>
<p>感觉还是比较奇怪…..</p>
<p>要讨论能不能的话….当然是可以做的….</p>
<p>即使不用RenderScript直接用 MeshVerts 也可以实现该效果…</p>
<p>找到坐标对应关系就可以做 球面映射 .</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>问题在于无论是 RenderScript 还是 MeshVerts 处理的目标都是 Bitmap (或者 像素数组)</p>
<p>静态帧处理没有问题….实时性无法保证…不知道意义何在….</p>
<p>&nbsp;</p>
<p>如果要保证实时性的话…似乎整个界面都需要实时渲染….整个界面都用SurfaceView / OpenGl 绘制的话代价也太大了.</p>
<hr>
<p>&nbsp;</p>
<p>Google一直以来都没有大力推广过RenderScript, 看来其复杂性和实用性还有待考虑……既然用Matrix就可以搞定就没必要写RS脚本了..</p>
<p>&nbsp;</p>
<hr>
<p>贴一下11年实现这个效果的RS脚本</p>
<p>&nbsp;</p>
<p><pre class="lang:default decode:true ">/**</pre></p>
<ul>
<li>This code is based on the work of daoki2</li>
<li><a href="http://code.google.com/p/renderscript-examples/" target="_blank" rel="external">http://code.google.com/p/renderscript-examples/</a></li>
<li>carousel.rs</li>
<li>Copyright (c) 2011 daoki2<br>*/</li>
</ul>
<p>#pragma version(1)</p>
<p>#pragma rs java_package_name(de.inovex.mobi.rsdemos)</p>
<p>#include “rs_graphics.rsh”</p>
<p>#define NUM_ITEMS 15</p>
<p>#define RADIUS 1900</p>
<p>rs_program_vertex gProgVertex;<br>rs_program_fragment gProgFragmentTexture;<br>rs_program_store gProgStoreBlendNone;<br>rs_program_raster gCullNone;<br>rs_sampler gLinearClamp;</p>
<p>rs_allocation gTex_00, gTex_01, gTex_02, gTex_03, gTex_04;<br>rs_allocation gTex_05, gTex_06, gTex_07, gTex_08, gTex_09, gTex_10, gTex_11, gTex_12, gTex_13, gTex_14;</p>
<p>typedef struct <strong>attribute</strong>((packed, aligned(4))) Bitmaps {<br>    rs_allocation data;<br>} Bitmaps_t;<br>Bitmaps_t *bitmap;</p>
<p>float gPx = 0;<br>float gPy = 0;<br>float gVx = 0;<br>float gVy = 0;</p>
<p>//float gDt = 0;</p>
<p>static float vertices[60];<br>static float len;<br>static int rot = 360/NUM_ITEMS/2; // Default angle<br>static int initialized = 0;</p>
<p>void init() {<br>}</p>
<p>static void displayCarousel() {<br>    // Default vertex shader<br>    rsgBindProgramVertex(gProgVertex);</p>
<pre><code>// Setup the projection matrix
rs_matrix4x4 proj;    
float aspect = (float)rsgGetWidth() / (float)rsgGetHeight();
rsMatrixLoadPerspective(&amp;amp;proj, 30.0f, aspect, 0.1f, 2500.0f);
rsgProgramVertexLoadProjectionMatrix(&amp;amp;proj);

// Fragment shader with texture
rsgBindProgramStore(gProgStoreBlendNone);
rsgBindProgramFragment(gProgFragmentTexture);
rsgBindProgramRaster(gCullNone);
rsgBindSampler(gProgFragmentTexture, 0, gLinearClamp);

// Reduce the rotation speed
if (gVx != 0) {
    rot = rot + gVx;
    gVx = gVx * 0.995f;
    if ( gVx &amp;lt; 0.00001f) {
        gVx = 0;
    }
}

// Load vertex matrix as model matrix
rs_matrix4x4 matrix;
rsMatrixLoadTranslate(&amp;amp;matrix, 0.0f, 0.0f, -400.0f); // camera position
rsMatrixRotate(&amp;amp;matrix, rot, 0.0f, 1.0f, 0.0f); // camera rotation
rsgProgramVertexLoadModelMatrix(&amp;amp;matrix);

// Draw the rectangles
Bitmaps_t *b = bitmap;
for (int i = 0; i &amp;lt; 15; i++) {
    rsgBindTexture(gProgFragmentTexture, 0, b-&amp;gt;data);
    rsgDrawQuadTexCoords(
        vertices[i*3],
        -(len/2),
        vertices[i*3+2],
        0,1,
        vertices[i*3],
        len/2,
        vertices[i*3+2],
        0,0,
        vertices[i == 14 ? 0 : (i+1)*3],
        len/2,
        vertices[i == 14 ? 0 + 2 : (i+1)*3 + 2],
        1,0,
        vertices[i == 14 ? 0 : (i+1)*3],
        -(len/2),
        vertices[i == 14 ? 0 + 2 : (i+1)*3 + 2],
        1,1
    );
    b++;
}
</code></pre><p>}</p>
<p>static void initBitmaps() {<br>    // Set the bitmap address to the structure<br>    Bitmaps_t *b = bitmap;<br>    b-&gt;data = gTex_00; b++;<br>    b-&gt;data = gTex_01; b++;<br>    b-&gt;data = gTex_02; b++;<br>    b-&gt;data = gTex_03; b++;<br>    b-&gt;data = gTex_04; b++;<br>    b-&gt;data = gTex_05; b++;<br>    b-&gt;data = gTex_06; b++;<br>    b-&gt;data = gTex_07; b++;<br>    b-&gt;data = gTex_08; b++;<br>    b-&gt;data = gTex_09; b++;<br>    b-&gt;data = gTex_10; b++;<br>    b-&gt;data = gTex_11; b++;<br>    b-&gt;data = gTex_12; b++;<br>    b-&gt;data = gTex_13; b++;<br>    b-&gt;data = gTex_14; b++;</p>
<pre><code>// Calculate the length of the polygon
len = RADIUS * 2 * sin(M_PI/NUM_ITEMS);

// Calculate the vertices of rectangles
float angle;
for (int i = 0; i &amp;lt; NUM_ITEMS; i++) {
    angle = i * 360 / NUM_ITEMS;
    vertices[i*3] = sin(angle * M_PI / 180) * RADIUS;
    vertices[i*3 + 1] = 0;
    vertices[i*3 + 2] = -cos(angle * M_PI / 180) * RADIUS;
}
</code></pre><p>}</p>
<p>int root() {<br>    if (initialized == 0) {<br>        initBitmaps();<br>        initialized = 1;<br>    }</p>
<pre><code>//gDt = rsGetDt();
rsgClearColor(0.0f, 0.0f, 0.3333f, 0.0f);
rsgClearDepth(1.0f);

displayCarousel();

return 10;
</code></pre><p>}<br><br>&nbsp;</p>
<p>现在参考FancyCoverFlow或者3DGallery之类有太多简单的实现方法了…</p>
<p>&nbsp;</p>
<p>更关键的是 MeshVerts这部分对应有Java接口可以直接调用了</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-transformationtool" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/14/transformationtool/" class="article-date">
  	<time datetime="2015-01-13T21:42:24.000Z" itemprop="datePublished">2015-01-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/14/transformationtool/">TransformationTool </a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>既然想到脚本…翻了下…把我原来写的dp百分比换算脚本翻了出来…  反正java也可以用来写写小工具嘛</p>
<p>作用是把所有 dp/sp 单位进行百分比换算….例如在 720X1280 &amp; density = 2 时</p>
<p>1dp = 2px</p>
<p>在 480*800 &amp; density =1.5 时</p>
<p>2/720*480/1.5 = 0.8888889 dp</p>
<p>目的是保证所有元素在不同分辨率上保持比例完全一致</p>
<p>但是大家都知道 android本身设计逻辑不是这样的……dp是物理尺寸相关的单位…所以最后我把UX说服了没用这么个奇怪的方案….不过脚本当时已经写好了….记录一下免得丢了..</p>
<p>至于为什么输入数据是dp单位是因为我写这个脚本的时候界面已经用dp适配好了….否则就该严格按照px先写1920*1080分辨率的…然后用脚本生成所有其它分辨率的…..</p>
<pre><code>import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.HashMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * 
 * @author Peter.Ding
 * 
 */
public class TransformationTool {
    private static final String resourceFolder = &quot;C:\\Users\\peter.ding\\Desktop\\src_folder&quot;;
    private static final String targetFolder = &quot;C:\\Users\\peter.ding\\Desktop\\target_folder&quot;;

    private static final Pattern PATTERN_DP = Pattern.compile(&quot;[0-9]{1,3}dp&quot;);
    private static final Pattern PATTERN_SP = Pattern.compile(&quot;[0-9]{1,3}sp&quot;);

    private static final String SOLUTION_480X800 = &quot;480x800&quot;;
    private static final String SOLUTION_720X1280 = &quot;720x1280&quot;;
    private static final String SOLUTION_1080x1920 = &quot;1080x1920&quot;;

    private static HashMap&amp;lt;String, Float&amp;gt; densityMap = new HashMap&amp;lt;&amp;gt;();

    private static String SRC_SOLUTION = SOLUTION_720X1280;
    private static String TARGET_SOLUTION = SOLUTION_480X800;

    private static int SRC_SOLUTION_WIDTH;
    private static int TARGET_SOLUTION_WIDTH;

    public static void main(String[] args) throws IOException {

        SRC_SOLUTION_WIDTH = Integer.parseInt(SRC_SOLUTION.split(&quot;x&quot;)[0]);
        TARGET_SOLUTION_WIDTH = Integer.parseInt(TARGET_SOLUTION.split(&quot;x&quot;)[0]);

        densityMap.put(SOLUTION_720X1280, 2f);
        densityMap.put(SOLUTION_480X800, 1.5f);
        densityMap.put(SOLUTION_1080x1920, 3.0f);

        File directory = new File(resourceFolder);
        File[] files = directory.listFiles();

        for (File srcFile : files) {
            FileReader fr = new FileReader(srcFile);
            BufferedReader br = new BufferedReader(fr);

            String content = &quot;&quot;;
            String line = null;
            while ((line = br.readLine()) != null) {
                content += line;
            }
            br.close();
            fr.close();

            Matcher matcher = PATTERN_DP.matcher(content);
            while (matcher.find()) {
                String srcString = matcher.group();
                int originDp = Integer.parseInt(srcString.substring(0, srcString.length() - 2));
                String targetString = originDp * densityMap.get(SRC_SOLUTION) * TARGET_SOLUTION_WIDTH / SRC_SOLUTION_WIDTH
                        / densityMap.get(TARGET_SOLUTION) + &quot;dp&quot;;
                content = content.replace(srcString, targetString);
            }

            Matcher matcher_sp = PATTERN_SP.matcher(content);
            while (matcher_sp.find()) {
                String srcString = matcher_sp.group();
                int originDp = Integer.parseInt(srcString.substring(0, srcString.length() - 2));
                String targetString = originDp * densityMap.get(SRC_SOLUTION) * TARGET_SOLUTION_WIDTH / SRC_SOLUTION_WIDTH
                        / densityMap.get(TARGET_SOLUTION) + &quot;sp&quot;;
                content = content.replace(srcString, targetString);
            }

            File targetFile = new File(targetFolder + File.separatorChar + srcFile.getName());
            FileWriter fw = new FileWriter(targetFile);
            fw.write(content);
            fw.flush();
            fw.close();
        }

    }
}
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-android-resource-remover" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/14/android-resource-remover/" class="article-date">
  	<time datetime="2015-01-13T21:30:28.000Z" itemprop="datePublished">2015-01-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/14/android-resource-remover/">android-resource-remover</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/KeepSafe/android-resource-remover" target="_blank" rel="external">https://github.com/KeepSafe/android-resource-remover</a></p>
<p>和刚才那个很类似的脚本…作用是移除所有未使用的资源</p>
<p>看Python代码…..它只是先帮你跑了一遍lint….然后根据lint的结果删除了未使用的资源….</p>
<p>留个档</p>
<pre><code>class=&quot;lang:python decode:true  &quot;&gt;&quot;&quot;&quot;
    clean_app
    ~~~~~~~~~~

    Implements methods for removing unused android resources based on Android
    Lint results.

    :copyright: (c) 2014 by KeepSafe.
    :license: Apache, see LICENSE for more details.
&quot;&quot;&quot;

import argparse
import os
import re
import subprocess
import xml.etree.ElementTree as ET
from lxml import etree

class Issue:

    &quot;&quot;&quot;
    Stores a single issue reported by Android Lint
    &quot;&quot;&quot;
    pattern = re.compile(&apos;The resource (.+) appears to be unused&apos;)

    def __init__(self, filepath, remove_file):
        self.filepath = filepath
        self.remove_file = remove_file
        self.elements = []

    def __str__(self):
        return &apos;{0} {1}&apos;.format(self.filepath)

    def __repr__(self):
        return &apos;{0} {1}&apos;.format(self.filepath)

    def add_element(self, message):
        res = re.findall(Issue.pattern, message)[0]
        bits = res.split(&apos;.&apos;)[-2:]
        self.elements.append((bits[0], bits[1]))

def parse_args():
    &quot;&quot;&quot;
    Parse command line arguments.
    &quot;&quot;&quot;
    parser = argparse.ArgumentParser()
    parser.add_argument(&apos;--lint&apos;,
                        help=&apos;Path to the ADT lint tool. If not specified it assumes lint tool is in your path&apos;,
                        default=&apos;lint&apos;)
    parser.add_argument(&apos;--app&apos;,
                        help=&apos;Path to the Android app. If not specifies it assumes current directory is your Android &apos;
                             &apos;app directory&apos;,
                        default=&apos;.&apos;)
    parser.add_argument(&apos;--xml&apos;,
                        help=&apos;Path to the list result. If not specifies linting will be done by the script&apos;,
                        default=None)
    parser.add_argument(&apos;--ignore-layouts&apos;,
                        help=&apos;Should ignore layouts&apos;,
                        action=&apos;store_true&apos;)
    args = parser.parse_args()
    return args.lint, args.app, args.xml, args.ignore_layouts

def run_lint_command():
    &quot;&quot;&quot;
    Run lint command in the shell and save results to lint-result.xml
    &quot;&quot;&quot;
    lint, app_dir, lint_result, ignore_layouts = parse_args()
    if not lint_result:
        lint_result = os.path.join(app_dir, &apos;lint-result.xml&apos;)
        call_result = subprocess.call([lint, app_dir, &apos;--xml&apos;, lint_result], shell=True)
        if call_result &amp;gt; 0:
            print(&apos;Running the command failed. Try running it from the console. Arguments for subprocess.call: {0}&apos;.format(
                [lint, app_dir, &apos;--xml&apos;, lint_result]))
    return lint_result, app_dir, ignore_layouts

def parse_lint_result(lint_result_path):
    &quot;&quot;&quot;
    Parse lint-result.xml and create Issue for every problem found
    &quot;&quot;&quot;
    root = ET.parse(lint_result_path).getroot()
    issues = []
    for issue_xml in root.findall(&apos;.//issue[@id=&quot;UnusedResources&quot;]&apos;):
        for location in issue_xml.findall(&apos;location&apos;):
            filepath = location.get(&apos;file&apos;)
            # if the location contains line and/or column attribute not the entire resource is unused. that&apos;s a guess ;)
            # TODO stop guessing
            remove_entire_file = (location.get(&apos;line&apos;) or location.get(&apos;column&apos;)) is None
            issue = Issue(filepath, remove_entire_file)
            issue.add_element(issue_xml.get(&apos;message&apos;))
            issues.append(issue)
    return issues

def remove_resource_file(issue, filepath, ignore_layouts):
    &quot;&quot;&quot;
    Delete a file from the filesystem
    &quot;&quot;&quot;
    if os.path.exists(filepath) and (ignore_layouts is False or issue.elements[0][0] != &apos;layout&apos;):
        print(&apos;removing resource: {0}&apos;.format(filepath))
        os.remove(os.path.abspath(filepath))

def remove_resource_value(issue, filepath):
    &quot;&quot;&quot;
    Read an xml file and remove an element which is unused, then save the file back to the filesystem
    &quot;&quot;&quot;
    for element in issue.elements:
        print(&apos;removing {0} from resource {1}&apos;.format(element, filepath))
        parser = etree.XMLParser(remove_blank_text=False, remove_comments=False,
                                 remove_pis=False, strip_cdata=False, resolve_entities=False)
        tree = etree.parse(filepath, parser)
        root = tree.getroot()
        for unused_value in root.findall(&apos;.//{0}[@name=&quot;{1}&quot;]&apos;.format(element[0], element[1])):
            root.remove(unused_value)
        with open(filepath, &apos;wb&apos;) as resource:
            tree.write(resource, encoding=&apos;utf-8&apos;, xml_declaration=True)

def remove_unused_resources(issues, app_dir, ignore_layouts):
    &quot;&quot;&quot;
    Remove the file or the value inside the file depending if the whole file is unused or not.
    &quot;&quot;&quot;
    for issue in issues:
        filepath = os.path.join(app_dir, issue.filepath)
        if issue.remove_file:
            remove_resource_file(issue, filepath, ignore_layouts)
        else:
            remove_resource_value(issue, filepath)

def main():
    lint_result_path, app_dir, ignore_layouts = run_lint_command()
    issues = parse_lint_result(lint_result_path)
    remove_unused_resources(issues, app_dir, ignore_layouts)

if __name__ == &apos;__main__&apos;:
    main()
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-android-localization-helper" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/14/android-localization-helper/" class="article-date">
  	<time datetime="2015-01-13T21:23:30.000Z" itemprop="datePublished">2015-01-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/14/android-localization-helper/">android-localization-helper</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/jordanjoz1/android-localization-helper" target="_blank" rel="external">https://github.com/jordanjoz1/android-localization-helper</a></p>
<p>一个小脚本….可以匹配各个语言下的string.xml内容是否一致</p>
<p>如果有没有国家化的部分会在结果里展示出来</p>
<p>另外还可以将所有语言下的string.xml 按 default下的string,xml顺序重排序</p>
<p>原文没写windows下的使用…实际上只要拷贝 <code>translation_helper.py</code> 到项目res路径下,然后直接执行就好了.  当然..你得有python环境..</p>
<p>在Ajnga和Heyue上试了下….结果还可以…<br>Ajinga没有差异…Heyue里有2个字符串没有values-zh版本…</p>
<p>留个档 脚本直接扔下面</p>
<pre><code>class=&quot;lang:python decode:true &quot;&gt;#!/usr/bin/env python

&apos;&apos;&apos;
This script does two things:
1) Ouputs strings that haven&apos;t been translated in files for each language
2) Cleans up string.xml files for other languages by removing old strings and
re-ordering the strings based on their order in the default language

Other important notes
-Should support all language codes that follow the -** or -**-*** pattern
-This ignores strings that start with &quot;provider.&quot; or have the &quot;translatable&quot;
attribute set to &quot;false&quot;
-The output directory for the missing strings is in the current directory
-The output file names look like &quot;strings_to_trans-**&quot; where &quot;**&quot; is the
language code
&apos;&apos;&apos;

import sys
import os
import xml.etree.ElementTree as ET
import codecs
import argparse

ORIG_DIR = os.getcwd()

def main():

    # parse command line arguments
    res_path, clean, out_path = parseArgs()

    # go to the resource directory and save the whole path
    os.chdir(res_path)
    res_path = os.getcwd()

    # get default keys
    tree = getDefaultTree(res_path)
    keys = getKeysFromTree(tree)
    tags = getTagsFromTree(tree)

    print(&apos;Found %d strings in the default language&apos; % len(keys))

    # get the languages that we want to translate to
    langs = getLangsFromDir(res_path)

    print(&apos;Found translations for: %s&apos; % &apos;, &apos;.join(langs))

    # look for missing keys in each language string file
    missing = findMissingKeys(keys, langs, res_path)

    # remove old strings and sort them all in the same way
    if (clean):
        cleanTranslationFiles(langs, keys, res_path)

    # write files for missing keys for each language
    createOutputDir(out_path)
    writeMissingKeysToFiles(langs, tags, missing, out_path)

    print(&apos;Saved missings strings to: %s&apos; % out_path)

def parseArgs():
    # parse arguments and do error checking
    parser = argparse.ArgumentParser()
    parser.add_argument(&apos;--res&apos;,
                        help=&apos;Path to the app\&apos;s /res directory. If not &apos;
                        &apos;specifies it assumes current directory&apos;,
                        default=&apos;.&apos;)
    parser.add_argument(&apos;--output&apos;,
                        help=&apos;Path to the output directory. If not specifies &apos;
                        &apos;it will create a folder called to_translate in the &apos;
                        &apos;current directory&apos;,
                        default=&apos;./to_translate&apos;)
    parser.add_argument(&apos;--clean&apos;,
                        help=&apos;re-orders and removes strings in the &apos;
                        &apos;translation files to match the default string &apos;
                        &apos;ordering&apos;,
                        action=&quot;store_true&quot;)
    args = parser.parse_args()
    return args.res, args.clean, args.output

def getDefaultTree(res_path):
    os.chdir(res_path)
    if os.path.exists(&apos;values&apos;):
        os.chdir(&apos;values&apos;)
    else:
        sys.exit(&apos;Could not find values/ ... &apos;
                 &apos;Are you in your res/ folder?&apos;)
    ET.register_namespace(&apos;tools&apos;, &quot;http://schemas.android.com/tools&quot;)
    ET.register_namespace(&apos;xliff&apos;, &quot;urn:oasis:names:tc:xliff:document:1.2&quot;)
    return ET.parse(&apos;strings.xml&apos;)

def createOutputDir(out_path):
    # create output directory
    os.chdir(ORIG_DIR)
    if not os.path.exists(out_path):
        os.makedirs(out_path)

def writeMissingKeysToFiles(langs, tags, missing, out_path):
    # write xml files for missing strings for each language
    os.chdir(ORIG_DIR)
    os.chdir(out_path)
    for lang in langs:
        # skip language if it&apos;s not missing any strings
        if (len(missing[lang]) == 0):
            continue

        # create element tree for all the missing tags
        root = ET.Element(&apos;resources&apos;)
        for key in missing[lang]:
            tag = getTagByKeyName(tags, key)
            root.append(tag)

        # write out the strings
        f = codecs.open(&apos;strings_to_trans-%s.xml&apos; % (lang), &apos;wb&apos;, &apos;utf-8&apos;)
        f.write(prettify(root))

def getLanguageTrees(langs, res_path):
    trees = {}
    for lang in langs:
        os.chdir(res_path)
        os.chdir(&apos;values-&apos; + lang)
        if os.path.exists(&apos;strings.xml&apos;):
            trees[lang] = ET.parse(&apos;strings.xml&apos;)
        else:
            print(&apos;Could not find strings.xml file for %s... skipping&apos; % lang)
    return trees

def cleanTranslationFiles(langs, keys, res_path):
    trees = getLanguageTrees(langs, res_path)
    for lang in trees.keys():
        tree = trees[lang]
        keys_trans = getKeysFromTree(tree)
        tags_trans = getTagsFromTree(tree)
        keys_has = intersection(keys, keys_trans)
        root = ET.Element(&apos;resources&apos;)
        for key in keys_has:
            tag = getTagByKeyName(tags_trans, key)
            root.append(tag)

        # write out file
        os.chdir(res_path)
        os.chdir(&apos;values-%s&apos; % (lang))
        f = codecs.open(&apos;strings.xml&apos;, &apos;wb&apos;, &apos;utf-8&apos;)
        f.write(prettify(root))

def intersection(a, b):
    &quot;&quot;&quot;Intersection of sets A and B
    Don&apos;t use Python&apos;s set method since we care about the order
    &quot;&quot;&quot;
    return [el for el in a if el in b]

def difference(a, b):
    &quot;&quot;&quot;Result set of A - B
    Don&apos;t use Python&apos;s set method since we care about the order
    &quot;&quot;&quot;
    return [el for el in a if el not in b]

def getTagByKeyName(tags, key):
    for tag in tags:
        if tag.get(&apos;name&apos;) == key:
            return tag

def prettify(elem):
    &quot;&quot;&quot;Format xml element as a string
    Return a &quot;pretty-printed&quot; XML string for the Element.

    The element tree tostring() preserves the formatting of each individual
    tag, but it can have some funky behavior since we aren&apos;t including all the
    tags we read from the original tree.  On Python 3 tostring() does not add
    the XML declaration, so we need to add that manually.
    &quot;&quot;&quot;
    output = ET.tostring(elem, encoding=&apos;UTF-8&apos;).decode(&apos;utf-8&apos;)

    # make sure we add the xml declaration... stupid python 3
    if not output.startswith(&apos;&amp;lt;?xml&apos;):
        output = &quot;&amp;lt;?xml version=&apos;1.0&apos; encoding=&apos;UTF-8&apos;?&amp;gt;\n&quot; + output

    # fix first string not indenting
    output = output.replace(&apos;&amp;gt;&amp;lt;string&apos;, &apos;&amp;gt;\n    &amp;lt;string&apos;)
    return output

def findMissingKeys(keys, langs, res_path):
    missing = {}
    trees = getLanguageTrees(langs, res_path)
    for lang in trees.keys():
        tree = trees[lang]
        keys_trans = getKeysFromTree(tree)
        missing[lang] = difference(keys, keys_trans)
    return missing

def getLangDir(dir_name):
    &quot;&quot;&quot;
    Supported langauge directories follow one of three patterns:
    https://support.google.com/googleplay/android-developer/table/4419860
    1) values-**
    2) values-**-**
    3) values-**-***
    returns code for language or None if not a language directory
    &quot;&quot;&quot;
    if dir_name[2:].startswith(&apos;values-&apos;):
        code = [dir_name[9:]][0]
        if (len(code) == 2) or (len(code) == 5 and code[2] == &apos;-&apos;) \
                or (len(code) == 6 and code[2] == &apos;-&apos;):
            return code

    # not a language dir
    return None

def getLangsFromDir(res_path):
    os.chdir(res_path)
    langs = []
    for x in os.walk(&apos;.&apos;):
        code = getLangDir(x[0])
        if code is not None:
            langs.append(code)
    return langs

def getKeysFromTree(tree):
    root = tree.getroot()
    keys = []
    for child in root:
        # ignore strings that can&apos;t be translated
        if child.get(&apos;translatable&apos;, default=&apos;true&apos;) == &apos;false&apos;:
            continue
        # ignore providers
        if (child.get(&apos;name&apos;).startswith(&apos;provider.&apos;)):
            continue
        keys.append(child.get(&apos;name&apos;))
    return keys

def getTagsFromTree(tree):
    root = tree.getroot()
    keys = []
    for child in root:
        keys.append(child)
    return keys

if __name__ == &apos;__main__&apos;:
    main()
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-android-ultra-pull-to-refresh-analysis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/13/android-ultra-pull-to-refresh-analysis/" class="article-date">
  	<time datetime="2015-01-13T01:58:35.000Z" itemprop="datePublished">2015-01-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/13/android-ultra-pull-to-refresh-analysis/">android-Ultra-Pull-To-Refresh动画效果简要分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#android-Ultra-Pull-To-Refresh动画效果简要分析</p>
<p><a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">android-Ultra-Pull-To-Refresh</a></p>
<p><img src="https://camo.githubusercontent.com/d3fbe757c87fddc94e998ebdd08ac55956aed1cf/687474703a2f2f737261696e2d6769746875622e71696e6975646e2e636f6d2f756c7472612d7074722f73746f72652d686f7573652d737472696e672e676966" alt="image"></p>
<p>核心类StoreHousePath<br>    package in.srain.cube.views.ptr.header;</p>
<pre><code>import android.util.SparseArray;

import java.util.ArrayList;

/**
* Created by srain on 11/7/14.
*/
public class StoreHousePath {

private static final SparseArray&amp;lt;float[]&amp;gt; sPointList;

static {
sPointList = new SparseArray&amp;lt;float[]&amp;gt;();
float[][] LETTERS = new float[][]{
new float[]{
// A
24, 0, 1, 22,
1, 22, 1, 72,
24, 0, 47, 22,
47, 22, 47, 72,
1, 48, 47, 48
},

new float[]{
// B
0, 0, 0, 72,
0, 0, 37, 0,
37, 0, 47, 11,
47, 11, 47, 26,
47, 26, 38, 36,
38, 36, 0, 36,
38, 36, 47, 46,
47, 46, 47, 61,
47, 61, 38, 71,
37, 72, 0, 72,
},

new float[]{
// C
47, 0, 0, 0,
0, 0, 0, 72,
0, 72, 47, 72,
},

new float[]{
// D
0, 0, 0, 72,
0, 0, 24, 0,
24, 0, 47, 22,
47, 22, 47, 48,
47, 48, 23, 72,
23, 72, 0, 72,
},

new float[]{
// E
0, 0, 0, 72,
0, 0, 47, 0,
0, 36, 37, 36,
0, 72, 47, 72,
},

new float[]{
// F
0, 0, 0, 72,
0, 0, 47, 0,
0, 36, 37, 36,
},

new float[]{
// G
47, 23, 47, 0,
47, 0, 0, 0,
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 48,
47, 48, 24, 48,
},

new float[]{
// H
0, 0, 0, 72,
0, 36, 47, 36,
47, 0, 47, 72,
},

new float[]{
// I
0, 0, 47, 0,
24, 0, 24, 72,
0, 72, 47, 72,
},

new float[]{
// J
47, 0, 47, 72,
47, 72, 24, 72,
24, 72, 0, 48,
},

new float[]{
// K
0, 0, 0, 72,
47, 0, 3, 33,
3, 38, 47, 72,
},

new float[]{
// L
0, 0, 0, 72,
0, 72, 47, 72,
},

new float[]{
// M
0, 0, 0, 72,
0, 0, 24, 23,
24, 23, 47, 0,
47, 0, 47, 72,
},

new float[]{
// N
0, 0, 0, 72,
0, 0, 47, 72,
47, 72, 47, 0,
},

new float[]{
// O
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
47, 0, 0, 0,
},

new float[]{
// P
0, 0, 0, 72,
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
},

new float[]{
// Q
0, 0, 0, 72,
0, 72, 23, 72,
23, 72, 47, 48,
47, 48, 47, 0,
47, 0, 0, 0,
24, 28, 47, 71,
},

new float[]{
// R
0, 0, 0, 72,
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
0, 37, 47, 72,
},

new float[]{
// S
47, 0, 0, 0,
0, 0, 0, 36,
0, 36, 47, 36,
47, 36, 47, 72,
47, 72, 0, 72,
},

new float[]{
// T
0, 0, 47, 0,
24, 0, 24, 72,
},

new float[]{
// U
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
},

new float[]{
// V
0, 0, 24, 72,
24, 72, 47, 0,
},

new float[]{
// W
0, 0, 0, 72,
0, 72, 24, 49,
24, 49, 47, 72,
47, 72, 47, 0
},

new float[]{
// X
0, 0, 47, 72,
47, 0, 0, 72
},

new float[]{
// Y
0, 0, 24, 23,
47, 0, 24, 23,
24, 23, 24, 72
},

new float[]{
// Z
0, 0, 47, 0,
47, 0, 0, 72,
0, 72, 47, 72
},
};
final float[][] NUMBERS = new float[][]{
new float[]{
// 0
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
47, 0, 0, 0,
},
new float[]{
// 1
24, 0, 24, 72,
},

new float[]{
// 2
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
0, 36, 0, 72,
0, 72, 47, 72
},

new float[]{
// 3
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
47, 36, 47, 72,
47, 72, 0, 72,
},

new float[]{
// 4
0, 0, 0, 36,
0, 36, 47, 36,
47, 0, 47, 72,
},

new float[]{
// 5
0, 0, 0, 36,
0, 36, 47, 36,
47, 36, 47, 72,
47, 72, 0, 72,
0, 0, 47, 0
},

new float[]{
// 6
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 36,
47, 36, 0, 36
},

new float[]{
// 7
0, 0, 47, 0,
47, 0, 47, 72
},

new float[]{
// 8
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
47, 0, 0, 0,
0, 36, 47, 36
},

new float[]{
// 9
47, 0, 0, 0,
0, 0, 0, 36,
0, 36, 47, 36,
47, 0, 47, 72,
}
};
// A - Z
for (int i = 0; i &amp;lt; LETTERS.length; i++) {
sPointList.append(i + 65, LETTERS[i]);
}
// a - z
for (int i = 0; i &amp;lt; LETTERS.length; i++) {
sPointList.append(i + 65 + 32, LETTERS[i]);
}
// 0 - 9
for (int i = 0; i &amp;lt; NUMBERS.length; i++) {
sPointList.append(i + 48, NUMBERS[i]);
}
// blank
addChar(&apos; &apos;, new float[]{});
// -
addChar(&apos;-&apos;, new float[]{
0, 36, 47, 36
});
// .
addChar(&apos;.&apos;, new float[]{
24, 60, 24, 72
});
}

public static void addChar(char c, float[] points) {
sPointList.append(c, points);
}

public static ArrayList&amp;lt;float[]&amp;gt; getPath(String str) {
return getPath(str, 1, 14);
}

/**
* @param str
* @param scale
* @param gapBetweenLetter
* @return ArrayList of float[] {x1, y1, x2, y2}
*/
public static ArrayList&amp;lt;float[]&amp;gt; getPath(String str, float scale, int gapBetweenLetter) {
ArrayList&amp;lt;float[]&amp;gt; list = new ArrayList&amp;lt;float[]&amp;gt;();
float offsetForWidth = 0;
for (int i = 0; i &amp;lt; str.length(); i++) {
int pos = str.charAt(i);
int key = sPointList.indexOfKey(pos);
if (key == -1) {
continue;
}
float[] points = sPointList.get(pos);
int pointCount = points.length / 4;

for (int j = 0; j &amp;lt; pointCount; j++) {
float[] line = new float[4];
for (int k = 0; k &amp;lt; 4; k++) {
float l = points[j * 4 + k];
// x
if (k % 2 == 0) {
line[k] = (l + offsetForWidth) * scale;
}
// y
else {
line[k] = l * scale;
}
}
list.add(line);
}
offsetForWidth += 57 + gapBetweenLetter;
}
return list;
}
}
</code></pre><p>对数字和坐标敏感的话,看到上面这几个数组应该就能理解这部分的作用.<br>这里将 数字 和 字母 分解成 对应笔画的 Path , 每2个数字 作为一个坐标点<br>每一行的2个坐标点作为一个笔画</p>
<p>所以,该库不支持 这里定义之外的 其它字符 比如汉字 某些特殊符号之类的…<br>虽然提供了一个方法让你以xml的形式的自定义path进来…但是需要自定义path还是算了…</p>
<p>作为库分析来说…其实看到这里就已经猜到后面的实现方式了……</p>
<p>顺藤摸瓜在 StoreHouseHeader里找到了对 StoreHousePath 的调用<br>这里先把path封装成了 StoreHouseBarItem 对象方便处理</p>
<pre><code>@Override
public void onDraw(Canvas canvas) {
    super.onDraw(canvas);
    float progress = mProgress;
    int c1 = canvas.save();
    int len = mItemList.size();

    for (int i = 0; i &amp;lt; len; i++) {

        canvas.save();
        StoreHouseBarItem storeHouseBarItem = mItemList.get(i);
        float offsetX = mOffsetX + storeHouseBarItem.midPoint.x;
        float offsetY = mOffsetY + storeHouseBarItem.midPoint.y;

        if (mIsInLoading) {
            storeHouseBarItem.getTransformation(getDrawingTime(), mTransformation);
            canvas.translate(offsetX, offsetY);
        } else {

            if (progress == 0) {
                storeHouseBarItem.resetPosition(horizontalRandomness);
                continue;
            }

            float startPadding = (1 - internalAnimationFactor) * i / len;
            float endPadding = 1 - internalAnimationFactor - startPadding;

            // done
            if (progress == 1 || progress &amp;gt;= 1 - endPadding) {
                canvas.translate(offsetX, offsetY);
                storeHouseBarItem.setAlpha(mBarDarkAlpha);
            } else {
                float realProgress;
                if (progress &amp;lt;= startPadding) {
                    realProgress = 0;
                } else {
                    realProgress = Math.min(1, (progress - startPadding) / internalAnimationFactor);
                }
                offsetX += storeHouseBarItem.translationX * (1 - realProgress);
                offsetY += -mDropHeight * (1 - realProgress);
                Matrix matrix = new Matrix();
                matrix.postRotate(360 * realProgress);
                matrix.postScale(realProgress, realProgress);
                matrix.postTranslate(offsetX, offsetY);
                storeHouseBarItem.setAlpha(mBarDarkAlpha * realProgress);
                canvas.concat(matrix);
            }
        }
        storeHouseBarItem.draw(canvas);
        canvas.restore();
    }
    if (mIsInLoading) {
        invalidate();
    }
    canvas.restoreToCount(c1);
}


//StoreHouseBarItem中对应的draw方法
public void draw(Canvas canvas) {
    canvas.drawLine(mCStartPoint.x, mCStartPoint.y, mCEndPoint.x, mCEndPoint.y, mPaint);
}
</code></pre><p>根据startPadding 和 progress的值对每个笔画进行平移 旋转 缩放 以及 alpha值的调整.</p>
<p>注意这里startPadding实际上是通过笔画在数组中的位置计算出来的…</p>
<p>所以简单来看 每一个笔画的 realProgress 是不同的<br>realProgress 受 笔画在数组中的位置 i 和 progress 影响</p>
<hr>
<p>剩下个高光效果直接用Shader渲染的..不分析了…..</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-folder-drawerlayout-3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/12/folder-drawerlayout-3/" class="article-date">
  	<time datetime="2015-01-12T08:59:42.000Z" itemprop="datePublished">2015-01-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/12/folder-drawerlayout-3/">Folder-DrawerLayout 开发日志2</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/folder-draw-layout.jpg" alt="folder-drawer-layout"></p>
<p><img src="/images/Folder-DrawerLayout3.gif" alt="folder-drawer-layout"></p>
<p>弧形褶皱添加完毕…..有些bug….</p>
<p>数值上也需要调整一下….需要构造一个 x=f(y)</p>
<p>当 y=0 或 y=height 时   f(y) = 0 的函数 。。</p>
<p>本来是写了个二次函数。。但是二次函数是对称的。。只能保证中点在 height/2时满足条件….形状和斜率太对称很违和，不够自然…</p>
<p>可能写2个2次函数拼起来也可以….反正y轴上其实只有6个采样点…..都是插值插出来的….曲线不光滑也看不出来……….</p>
<hr>
<p>另外一个隐患是函数太复杂了。。。本来是为了清晰起见把每个步骤都分开计算。。</p>
<p>循环上有些冗余。。。但是对比图形计算的部分。。浪费的性能应该不在一个数量级上。。</p>
<p>但是类似这样的代码</p>
<pre class="lang:java decode:true"> private float[] applyScaleXEffect(float offset) {
        for (int i = 0; i &lt; 6; i++)
            for (int j = 0; j &lt; 51; j++) {
                meshVerts[i * 102 + 2 * j] = meshVerts[i * 102 + 2 * j]
                        * (1.0f + 0.0f * offset) ;

                meshVerts[i * 102 + 2 * j]=(offset) * meshVerts[i * 102 + 2 * j] *  (1+ (meshVerts[i * 102 + 2 * j+1]-1000)*(meshVerts[i * 102 + 2 * j+1]-1000)/10000 /width);
            }
        return meshVerts;
    }</pre>

<p>可阅读性已经基本没有了。。。。考虑到性能问题。。。最后可能还要把冗余的循环计算都合并起来。。。最后可能变成一个超长的公式。。。。。。。估计要做到一次成型。。然后再也不维护了。。</p>
<p>可阅读性要求很高。。。但是对性能又很敏感。。。。。我想想到底要怎么处理这个结构。。。</p>
<p>如果证实冗余的循环对性能影响不大的话。。。还是尽量把每个步骤分开写吧。。。优化的问题扔最后了</p>
<p>数值调整完以后要赶紧把 能拆出来的变量拆出来，能写成常量的写成常量。。不然过几天鬼还记得这个10000是怎么算出来的….</p>
<p>顺便发现用Google看函数图挑形状真是方便..</p>
<p><a href="http://dk-exp.com/wp-content/uploads/2015/01/google.jpg" target="_blank" rel="external"><img src="http://dk-exp.com/wp-content/uploads/2015/01/google-300x221.jpg" alt="google"></a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 DK
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>