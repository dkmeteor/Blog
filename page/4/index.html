<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DK&#39;s Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="DK's Lab">
<meta property="og:url" content="http://blog.dk-exp.com/page/4/index.html">
<meta property="og:site_name" content="DK's Lab">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DK's Lab">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="DK&#39;s Lab" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?47d977b9cd46d5988a3e06ada67a7fa9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">DK</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/circle/" style="font-size: 10px;">circle</a> <a href="/tags/list/" style="font-size: 10px;">list</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">DK</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">DK</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-android-resource-remover" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/14/android-resource-remover/" class="article-date">
  	<time datetime="2015-01-13T21:30:28.000Z" itemprop="datePublished">2015-01-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/14/android-resource-remover/">android-resource-remover</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/KeepSafe/android-resource-remover" target="_blank" rel="external">https://github.com/KeepSafe/android-resource-remover</a></p>
<p>和刚才那个很类似的脚本…作用是移除所有未使用的资源</p>
<p>看Python代码…..它只是先帮你跑了一遍lint….然后根据lint的结果删除了未使用的资源….</p>
<p>留个档</p>
<pre><code>class=&quot;lang:python decode:true  &quot;&gt;&quot;&quot;&quot;
    clean_app
    ~~~~~~~~~~

    Implements methods for removing unused android resources based on Android
    Lint results.

    :copyright: (c) 2014 by KeepSafe.
    :license: Apache, see LICENSE for more details.
&quot;&quot;&quot;

import argparse
import os
import re
import subprocess
import xml.etree.ElementTree as ET
from lxml import etree

class Issue:

    &quot;&quot;&quot;
    Stores a single issue reported by Android Lint
    &quot;&quot;&quot;
    pattern = re.compile(&apos;The resource (.+) appears to be unused&apos;)

    def __init__(self, filepath, remove_file):
        self.filepath = filepath
        self.remove_file = remove_file
        self.elements = []

    def __str__(self):
        return &apos;{0} {1}&apos;.format(self.filepath)

    def __repr__(self):
        return &apos;{0} {1}&apos;.format(self.filepath)

    def add_element(self, message):
        res = re.findall(Issue.pattern, message)[0]
        bits = res.split(&apos;.&apos;)[-2:]
        self.elements.append((bits[0], bits[1]))

def parse_args():
    &quot;&quot;&quot;
    Parse command line arguments.
    &quot;&quot;&quot;
    parser = argparse.ArgumentParser()
    parser.add_argument(&apos;--lint&apos;,
                        help=&apos;Path to the ADT lint tool. If not specified it assumes lint tool is in your path&apos;,
                        default=&apos;lint&apos;)
    parser.add_argument(&apos;--app&apos;,
                        help=&apos;Path to the Android app. If not specifies it assumes current directory is your Android &apos;
                             &apos;app directory&apos;,
                        default=&apos;.&apos;)
    parser.add_argument(&apos;--xml&apos;,
                        help=&apos;Path to the list result. If not specifies linting will be done by the script&apos;,
                        default=None)
    parser.add_argument(&apos;--ignore-layouts&apos;,
                        help=&apos;Should ignore layouts&apos;,
                        action=&apos;store_true&apos;)
    args = parser.parse_args()
    return args.lint, args.app, args.xml, args.ignore_layouts

def run_lint_command():
    &quot;&quot;&quot;
    Run lint command in the shell and save results to lint-result.xml
    &quot;&quot;&quot;
    lint, app_dir, lint_result, ignore_layouts = parse_args()
    if not lint_result:
        lint_result = os.path.join(app_dir, &apos;lint-result.xml&apos;)
        call_result = subprocess.call([lint, app_dir, &apos;--xml&apos;, lint_result], shell=True)
        if call_result &amp;gt; 0:
            print(&apos;Running the command failed. Try running it from the console. Arguments for subprocess.call: {0}&apos;.format(
                [lint, app_dir, &apos;--xml&apos;, lint_result]))
    return lint_result, app_dir, ignore_layouts

def parse_lint_result(lint_result_path):
    &quot;&quot;&quot;
    Parse lint-result.xml and create Issue for every problem found
    &quot;&quot;&quot;
    root = ET.parse(lint_result_path).getroot()
    issues = []
    for issue_xml in root.findall(&apos;.//issue[@id=&quot;UnusedResources&quot;]&apos;):
        for location in issue_xml.findall(&apos;location&apos;):
            filepath = location.get(&apos;file&apos;)
            # if the location contains line and/or column attribute not the entire resource is unused. that&apos;s a guess ;)
            # TODO stop guessing
            remove_entire_file = (location.get(&apos;line&apos;) or location.get(&apos;column&apos;)) is None
            issue = Issue(filepath, remove_entire_file)
            issue.add_element(issue_xml.get(&apos;message&apos;))
            issues.append(issue)
    return issues

def remove_resource_file(issue, filepath, ignore_layouts):
    &quot;&quot;&quot;
    Delete a file from the filesystem
    &quot;&quot;&quot;
    if os.path.exists(filepath) and (ignore_layouts is False or issue.elements[0][0] != &apos;layout&apos;):
        print(&apos;removing resource: {0}&apos;.format(filepath))
        os.remove(os.path.abspath(filepath))

def remove_resource_value(issue, filepath):
    &quot;&quot;&quot;
    Read an xml file and remove an element which is unused, then save the file back to the filesystem
    &quot;&quot;&quot;
    for element in issue.elements:
        print(&apos;removing {0} from resource {1}&apos;.format(element, filepath))
        parser = etree.XMLParser(remove_blank_text=False, remove_comments=False,
                                 remove_pis=False, strip_cdata=False, resolve_entities=False)
        tree = etree.parse(filepath, parser)
        root = tree.getroot()
        for unused_value in root.findall(&apos;.//{0}[@name=&quot;{1}&quot;]&apos;.format(element[0], element[1])):
            root.remove(unused_value)
        with open(filepath, &apos;wb&apos;) as resource:
            tree.write(resource, encoding=&apos;utf-8&apos;, xml_declaration=True)

def remove_unused_resources(issues, app_dir, ignore_layouts):
    &quot;&quot;&quot;
    Remove the file or the value inside the file depending if the whole file is unused or not.
    &quot;&quot;&quot;
    for issue in issues:
        filepath = os.path.join(app_dir, issue.filepath)
        if issue.remove_file:
            remove_resource_file(issue, filepath, ignore_layouts)
        else:
            remove_resource_value(issue, filepath)

def main():
    lint_result_path, app_dir, ignore_layouts = run_lint_command()
    issues = parse_lint_result(lint_result_path)
    remove_unused_resources(issues, app_dir, ignore_layouts)

if __name__ == &apos;__main__&apos;:
    main()
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-android-localization-helper" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/14/android-localization-helper/" class="article-date">
  	<time datetime="2015-01-13T21:23:30.000Z" itemprop="datePublished">2015-01-14</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/14/android-localization-helper/">android-localization-helper</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/jordanjoz1/android-localization-helper" target="_blank" rel="external">https://github.com/jordanjoz1/android-localization-helper</a></p>
<p>一个小脚本….可以匹配各个语言下的string.xml内容是否一致</p>
<p>如果有没有国家化的部分会在结果里展示出来</p>
<p>另外还可以将所有语言下的string.xml 按 default下的string,xml顺序重排序</p>
<p>原文没写windows下的使用…实际上只要拷贝 <code>translation_helper.py</code> 到项目res路径下,然后直接执行就好了.  当然..你得有python环境..</p>
<p>在Ajnga和Heyue上试了下….结果还可以…<br>Ajinga没有差异…Heyue里有2个字符串没有values-zh版本…</p>
<p>留个档 脚本直接扔下面</p>
<pre><code>class=&quot;lang:python decode:true &quot;&gt;#!/usr/bin/env python

&apos;&apos;&apos;
This script does two things:
1) Ouputs strings that haven&apos;t been translated in files for each language
2) Cleans up string.xml files for other languages by removing old strings and
re-ordering the strings based on their order in the default language

Other important notes
-Should support all language codes that follow the -** or -**-*** pattern
-This ignores strings that start with &quot;provider.&quot; or have the &quot;translatable&quot;
attribute set to &quot;false&quot;
-The output directory for the missing strings is in the current directory
-The output file names look like &quot;strings_to_trans-**&quot; where &quot;**&quot; is the
language code
&apos;&apos;&apos;

import sys
import os
import xml.etree.ElementTree as ET
import codecs
import argparse

ORIG_DIR = os.getcwd()

def main():

    # parse command line arguments
    res_path, clean, out_path = parseArgs()

    # go to the resource directory and save the whole path
    os.chdir(res_path)
    res_path = os.getcwd()

    # get default keys
    tree = getDefaultTree(res_path)
    keys = getKeysFromTree(tree)
    tags = getTagsFromTree(tree)

    print(&apos;Found %d strings in the default language&apos; % len(keys))

    # get the languages that we want to translate to
    langs = getLangsFromDir(res_path)

    print(&apos;Found translations for: %s&apos; % &apos;, &apos;.join(langs))

    # look for missing keys in each language string file
    missing = findMissingKeys(keys, langs, res_path)

    # remove old strings and sort them all in the same way
    if (clean):
        cleanTranslationFiles(langs, keys, res_path)

    # write files for missing keys for each language
    createOutputDir(out_path)
    writeMissingKeysToFiles(langs, tags, missing, out_path)

    print(&apos;Saved missings strings to: %s&apos; % out_path)

def parseArgs():
    # parse arguments and do error checking
    parser = argparse.ArgumentParser()
    parser.add_argument(&apos;--res&apos;,
                        help=&apos;Path to the app\&apos;s /res directory. If not &apos;
                        &apos;specifies it assumes current directory&apos;,
                        default=&apos;.&apos;)
    parser.add_argument(&apos;--output&apos;,
                        help=&apos;Path to the output directory. If not specifies &apos;
                        &apos;it will create a folder called to_translate in the &apos;
                        &apos;current directory&apos;,
                        default=&apos;./to_translate&apos;)
    parser.add_argument(&apos;--clean&apos;,
                        help=&apos;re-orders and removes strings in the &apos;
                        &apos;translation files to match the default string &apos;
                        &apos;ordering&apos;,
                        action=&quot;store_true&quot;)
    args = parser.parse_args()
    return args.res, args.clean, args.output

def getDefaultTree(res_path):
    os.chdir(res_path)
    if os.path.exists(&apos;values&apos;):
        os.chdir(&apos;values&apos;)
    else:
        sys.exit(&apos;Could not find values/ ... &apos;
                 &apos;Are you in your res/ folder?&apos;)
    ET.register_namespace(&apos;tools&apos;, &quot;http://schemas.android.com/tools&quot;)
    ET.register_namespace(&apos;xliff&apos;, &quot;urn:oasis:names:tc:xliff:document:1.2&quot;)
    return ET.parse(&apos;strings.xml&apos;)

def createOutputDir(out_path):
    # create output directory
    os.chdir(ORIG_DIR)
    if not os.path.exists(out_path):
        os.makedirs(out_path)

def writeMissingKeysToFiles(langs, tags, missing, out_path):
    # write xml files for missing strings for each language
    os.chdir(ORIG_DIR)
    os.chdir(out_path)
    for lang in langs:
        # skip language if it&apos;s not missing any strings
        if (len(missing[lang]) == 0):
            continue

        # create element tree for all the missing tags
        root = ET.Element(&apos;resources&apos;)
        for key in missing[lang]:
            tag = getTagByKeyName(tags, key)
            root.append(tag)

        # write out the strings
        f = codecs.open(&apos;strings_to_trans-%s.xml&apos; % (lang), &apos;wb&apos;, &apos;utf-8&apos;)
        f.write(prettify(root))

def getLanguageTrees(langs, res_path):
    trees = {}
    for lang in langs:
        os.chdir(res_path)
        os.chdir(&apos;values-&apos; + lang)
        if os.path.exists(&apos;strings.xml&apos;):
            trees[lang] = ET.parse(&apos;strings.xml&apos;)
        else:
            print(&apos;Could not find strings.xml file for %s... skipping&apos; % lang)
    return trees

def cleanTranslationFiles(langs, keys, res_path):
    trees = getLanguageTrees(langs, res_path)
    for lang in trees.keys():
        tree = trees[lang]
        keys_trans = getKeysFromTree(tree)
        tags_trans = getTagsFromTree(tree)
        keys_has = intersection(keys, keys_trans)
        root = ET.Element(&apos;resources&apos;)
        for key in keys_has:
            tag = getTagByKeyName(tags_trans, key)
            root.append(tag)

        # write out file
        os.chdir(res_path)
        os.chdir(&apos;values-%s&apos; % (lang))
        f = codecs.open(&apos;strings.xml&apos;, &apos;wb&apos;, &apos;utf-8&apos;)
        f.write(prettify(root))

def intersection(a, b):
    &quot;&quot;&quot;Intersection of sets A and B
    Don&apos;t use Python&apos;s set method since we care about the order
    &quot;&quot;&quot;
    return [el for el in a if el in b]

def difference(a, b):
    &quot;&quot;&quot;Result set of A - B
    Don&apos;t use Python&apos;s set method since we care about the order
    &quot;&quot;&quot;
    return [el for el in a if el not in b]

def getTagByKeyName(tags, key):
    for tag in tags:
        if tag.get(&apos;name&apos;) == key:
            return tag

def prettify(elem):
    &quot;&quot;&quot;Format xml element as a string
    Return a &quot;pretty-printed&quot; XML string for the Element.

    The element tree tostring() preserves the formatting of each individual
    tag, but it can have some funky behavior since we aren&apos;t including all the
    tags we read from the original tree.  On Python 3 tostring() does not add
    the XML declaration, so we need to add that manually.
    &quot;&quot;&quot;
    output = ET.tostring(elem, encoding=&apos;UTF-8&apos;).decode(&apos;utf-8&apos;)

    # make sure we add the xml declaration... stupid python 3
    if not output.startswith(&apos;&amp;lt;?xml&apos;):
        output = &quot;&amp;lt;?xml version=&apos;1.0&apos; encoding=&apos;UTF-8&apos;?&amp;gt;\n&quot; + output

    # fix first string not indenting
    output = output.replace(&apos;&amp;gt;&amp;lt;string&apos;, &apos;&amp;gt;\n    &amp;lt;string&apos;)
    return output

def findMissingKeys(keys, langs, res_path):
    missing = {}
    trees = getLanguageTrees(langs, res_path)
    for lang in trees.keys():
        tree = trees[lang]
        keys_trans = getKeysFromTree(tree)
        missing[lang] = difference(keys, keys_trans)
    return missing

def getLangDir(dir_name):
    &quot;&quot;&quot;
    Supported langauge directories follow one of three patterns:
    https://support.google.com/googleplay/android-developer/table/4419860
    1) values-**
    2) values-**-**
    3) values-**-***
    returns code for language or None if not a language directory
    &quot;&quot;&quot;
    if dir_name[2:].startswith(&apos;values-&apos;):
        code = [dir_name[9:]][0]
        if (len(code) == 2) or (len(code) == 5 and code[2] == &apos;-&apos;) \
                or (len(code) == 6 and code[2] == &apos;-&apos;):
            return code

    # not a language dir
    return None

def getLangsFromDir(res_path):
    os.chdir(res_path)
    langs = []
    for x in os.walk(&apos;.&apos;):
        code = getLangDir(x[0])
        if code is not None:
            langs.append(code)
    return langs

def getKeysFromTree(tree):
    root = tree.getroot()
    keys = []
    for child in root:
        # ignore strings that can&apos;t be translated
        if child.get(&apos;translatable&apos;, default=&apos;true&apos;) == &apos;false&apos;:
            continue
        # ignore providers
        if (child.get(&apos;name&apos;).startswith(&apos;provider.&apos;)):
            continue
        keys.append(child.get(&apos;name&apos;))
    return keys

def getTagsFromTree(tree):
    root = tree.getroot()
    keys = []
    for child in root:
        keys.append(child)
    return keys

if __name__ == &apos;__main__&apos;:
    main()
</code></pre>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-android-ultra-pull-to-refresh-analysis" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/13/android-ultra-pull-to-refresh-analysis/" class="article-date">
  	<time datetime="2015-01-13T01:58:35.000Z" itemprop="datePublished">2015-01-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/13/android-ultra-pull-to-refresh-analysis/">android-Ultra-Pull-To-Refresh动画效果简要分析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#android-Ultra-Pull-To-Refresh动画效果简要分析</p>
<p><a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">android-Ultra-Pull-To-Refresh</a></p>
<p><img src="https://camo.githubusercontent.com/d3fbe757c87fddc94e998ebdd08ac55956aed1cf/687474703a2f2f737261696e2d6769746875622e71696e6975646e2e636f6d2f756c7472612d7074722f73746f72652d686f7573652d737472696e672e676966" alt="image"></p>
<p>核心类StoreHousePath<br>    package in.srain.cube.views.ptr.header;</p>
<pre><code>import android.util.SparseArray;

import java.util.ArrayList;

/**
* Created by srain on 11/7/14.
*/
public class StoreHousePath {

private static final SparseArray&amp;lt;float[]&amp;gt; sPointList;

static {
sPointList = new SparseArray&amp;lt;float[]&amp;gt;();
float[][] LETTERS = new float[][]{
new float[]{
// A
24, 0, 1, 22,
1, 22, 1, 72,
24, 0, 47, 22,
47, 22, 47, 72,
1, 48, 47, 48
},

new float[]{
// B
0, 0, 0, 72,
0, 0, 37, 0,
37, 0, 47, 11,
47, 11, 47, 26,
47, 26, 38, 36,
38, 36, 0, 36,
38, 36, 47, 46,
47, 46, 47, 61,
47, 61, 38, 71,
37, 72, 0, 72,
},

new float[]{
// C
47, 0, 0, 0,
0, 0, 0, 72,
0, 72, 47, 72,
},

new float[]{
// D
0, 0, 0, 72,
0, 0, 24, 0,
24, 0, 47, 22,
47, 22, 47, 48,
47, 48, 23, 72,
23, 72, 0, 72,
},

new float[]{
// E
0, 0, 0, 72,
0, 0, 47, 0,
0, 36, 37, 36,
0, 72, 47, 72,
},

new float[]{
// F
0, 0, 0, 72,
0, 0, 47, 0,
0, 36, 37, 36,
},

new float[]{
// G
47, 23, 47, 0,
47, 0, 0, 0,
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 48,
47, 48, 24, 48,
},

new float[]{
// H
0, 0, 0, 72,
0, 36, 47, 36,
47, 0, 47, 72,
},

new float[]{
// I
0, 0, 47, 0,
24, 0, 24, 72,
0, 72, 47, 72,
},

new float[]{
// J
47, 0, 47, 72,
47, 72, 24, 72,
24, 72, 0, 48,
},

new float[]{
// K
0, 0, 0, 72,
47, 0, 3, 33,
3, 38, 47, 72,
},

new float[]{
// L
0, 0, 0, 72,
0, 72, 47, 72,
},

new float[]{
// M
0, 0, 0, 72,
0, 0, 24, 23,
24, 23, 47, 0,
47, 0, 47, 72,
},

new float[]{
// N
0, 0, 0, 72,
0, 0, 47, 72,
47, 72, 47, 0,
},

new float[]{
// O
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
47, 0, 0, 0,
},

new float[]{
// P
0, 0, 0, 72,
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
},

new float[]{
// Q
0, 0, 0, 72,
0, 72, 23, 72,
23, 72, 47, 48,
47, 48, 47, 0,
47, 0, 0, 0,
24, 28, 47, 71,
},

new float[]{
// R
0, 0, 0, 72,
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
0, 37, 47, 72,
},

new float[]{
// S
47, 0, 0, 0,
0, 0, 0, 36,
0, 36, 47, 36,
47, 36, 47, 72,
47, 72, 0, 72,
},

new float[]{
// T
0, 0, 47, 0,
24, 0, 24, 72,
},

new float[]{
// U
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
},

new float[]{
// V
0, 0, 24, 72,
24, 72, 47, 0,
},

new float[]{
// W
0, 0, 0, 72,
0, 72, 24, 49,
24, 49, 47, 72,
47, 72, 47, 0
},

new float[]{
// X
0, 0, 47, 72,
47, 0, 0, 72
},

new float[]{
// Y
0, 0, 24, 23,
47, 0, 24, 23,
24, 23, 24, 72
},

new float[]{
// Z
0, 0, 47, 0,
47, 0, 0, 72,
0, 72, 47, 72
},
};
final float[][] NUMBERS = new float[][]{
new float[]{
// 0
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
47, 0, 0, 0,
},
new float[]{
// 1
24, 0, 24, 72,
},

new float[]{
// 2
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
0, 36, 0, 72,
0, 72, 47, 72
},

new float[]{
// 3
0, 0, 47, 0,
47, 0, 47, 36,
47, 36, 0, 36,
47, 36, 47, 72,
47, 72, 0, 72,
},

new float[]{
// 4
0, 0, 0, 36,
0, 36, 47, 36,
47, 0, 47, 72,
},

new float[]{
// 5
0, 0, 0, 36,
0, 36, 47, 36,
47, 36, 47, 72,
47, 72, 0, 72,
0, 0, 47, 0
},

new float[]{
// 6
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 36,
47, 36, 0, 36
},

new float[]{
// 7
0, 0, 47, 0,
47, 0, 47, 72
},

new float[]{
// 8
0, 0, 0, 72,
0, 72, 47, 72,
47, 72, 47, 0,
47, 0, 0, 0,
0, 36, 47, 36
},

new float[]{
// 9
47, 0, 0, 0,
0, 0, 0, 36,
0, 36, 47, 36,
47, 0, 47, 72,
}
};
// A - Z
for (int i = 0; i &amp;lt; LETTERS.length; i++) {
sPointList.append(i + 65, LETTERS[i]);
}
// a - z
for (int i = 0; i &amp;lt; LETTERS.length; i++) {
sPointList.append(i + 65 + 32, LETTERS[i]);
}
// 0 - 9
for (int i = 0; i &amp;lt; NUMBERS.length; i++) {
sPointList.append(i + 48, NUMBERS[i]);
}
// blank
addChar(&apos; &apos;, new float[]{});
// -
addChar(&apos;-&apos;, new float[]{
0, 36, 47, 36
});
// .
addChar(&apos;.&apos;, new float[]{
24, 60, 24, 72
});
}

public static void addChar(char c, float[] points) {
sPointList.append(c, points);
}

public static ArrayList&amp;lt;float[]&amp;gt; getPath(String str) {
return getPath(str, 1, 14);
}

/**
* @param str
* @param scale
* @param gapBetweenLetter
* @return ArrayList of float[] {x1, y1, x2, y2}
*/
public static ArrayList&amp;lt;float[]&amp;gt; getPath(String str, float scale, int gapBetweenLetter) {
ArrayList&amp;lt;float[]&amp;gt; list = new ArrayList&amp;lt;float[]&amp;gt;();
float offsetForWidth = 0;
for (int i = 0; i &amp;lt; str.length(); i++) {
int pos = str.charAt(i);
int key = sPointList.indexOfKey(pos);
if (key == -1) {
continue;
}
float[] points = sPointList.get(pos);
int pointCount = points.length / 4;

for (int j = 0; j &amp;lt; pointCount; j++) {
float[] line = new float[4];
for (int k = 0; k &amp;lt; 4; k++) {
float l = points[j * 4 + k];
// x
if (k % 2 == 0) {
line[k] = (l + offsetForWidth) * scale;
}
// y
else {
line[k] = l * scale;
}
}
list.add(line);
}
offsetForWidth += 57 + gapBetweenLetter;
}
return list;
}
}
</code></pre><p>对数字和坐标敏感的话,看到上面这几个数组应该就能理解这部分的作用.<br>这里将 数字 和 字母 分解成 对应笔画的 Path , 每2个数字 作为一个坐标点<br>每一行的2个坐标点作为一个笔画</p>
<p>所以,该库不支持 这里定义之外的 其它字符 比如汉字 某些特殊符号之类的…<br>虽然提供了一个方法让你以xml的形式的自定义path进来…但是需要自定义path还是算了…</p>
<p>作为库分析来说…其实看到这里就已经猜到后面的实现方式了……</p>
<p>顺藤摸瓜在 StoreHouseHeader里找到了对 StoreHousePath 的调用<br>这里先把path封装成了 StoreHouseBarItem 对象方便处理</p>
<pre><code>@Override
public void onDraw(Canvas canvas) {
    super.onDraw(canvas);
    float progress = mProgress;
    int c1 = canvas.save();
    int len = mItemList.size();

    for (int i = 0; i &amp;lt; len; i++) {

        canvas.save();
        StoreHouseBarItem storeHouseBarItem = mItemList.get(i);
        float offsetX = mOffsetX + storeHouseBarItem.midPoint.x;
        float offsetY = mOffsetY + storeHouseBarItem.midPoint.y;

        if (mIsInLoading) {
            storeHouseBarItem.getTransformation(getDrawingTime(), mTransformation);
            canvas.translate(offsetX, offsetY);
        } else {

            if (progress == 0) {
                storeHouseBarItem.resetPosition(horizontalRandomness);
                continue;
            }

            float startPadding = (1 - internalAnimationFactor) * i / len;
            float endPadding = 1 - internalAnimationFactor - startPadding;

            // done
            if (progress == 1 || progress &amp;gt;= 1 - endPadding) {
                canvas.translate(offsetX, offsetY);
                storeHouseBarItem.setAlpha(mBarDarkAlpha);
            } else {
                float realProgress;
                if (progress &amp;lt;= startPadding) {
                    realProgress = 0;
                } else {
                    realProgress = Math.min(1, (progress - startPadding) / internalAnimationFactor);
                }
                offsetX += storeHouseBarItem.translationX * (1 - realProgress);
                offsetY += -mDropHeight * (1 - realProgress);
                Matrix matrix = new Matrix();
                matrix.postRotate(360 * realProgress);
                matrix.postScale(realProgress, realProgress);
                matrix.postTranslate(offsetX, offsetY);
                storeHouseBarItem.setAlpha(mBarDarkAlpha * realProgress);
                canvas.concat(matrix);
            }
        }
        storeHouseBarItem.draw(canvas);
        canvas.restore();
    }
    if (mIsInLoading) {
        invalidate();
    }
    canvas.restoreToCount(c1);
}


//StoreHouseBarItem中对应的draw方法
public void draw(Canvas canvas) {
    canvas.drawLine(mCStartPoint.x, mCStartPoint.y, mCEndPoint.x, mCEndPoint.y, mPaint);
}
</code></pre><p>根据startPadding 和 progress的值对每个笔画进行平移 旋转 缩放 以及 alpha值的调整.</p>
<p>注意这里startPadding实际上是通过笔画在数组中的位置计算出来的…</p>
<p>所以简单来看 每一个笔画的 realProgress 是不同的<br>realProgress 受 笔画在数组中的位置 i 和 progress 影响</p>
<hr>
<p>剩下个高光效果直接用Shader渲染的..不分析了…..</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-folder-drawerlayout-3" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/12/folder-drawerlayout-3/" class="article-date">
  	<time datetime="2015-01-12T08:59:42.000Z" itemprop="datePublished">2015-01-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/12/folder-drawerlayout-3/">Folder-DrawerLayout 开发日志2</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/folder-draw-layout.jpg" alt="folder-drawer-layout"></p>
<p><img src="/images/Folder-DrawerLayout3.gif" alt="folder-drawer-layout"></p>
<p>弧形褶皱添加完毕…..有些bug….</p>
<p>数值上也需要调整一下….需要构造一个 x=f(y)</p>
<p>当 y=0 或 y=height 时   f(y) = 0 的函数 。。</p>
<p>本来是写了个二次函数。。但是二次函数是对称的。。只能保证中点在 height/2时满足条件….形状和斜率太对称很违和，不够自然…</p>
<p>可能写2个2次函数拼起来也可以….反正y轴上其实只有6个采样点…..都是插值插出来的….曲线不光滑也看不出来……….</p>
<hr>
<p>另外一个隐患是函数太复杂了。。。本来是为了清晰起见把每个步骤都分开计算。。</p>
<p>循环上有些冗余。。。但是对比图形计算的部分。。浪费的性能应该不在一个数量级上。。</p>
<p>但是类似这样的代码</p>
<pre class="lang:java decode:true"> private float[] applyScaleXEffect(float offset) {
        for (int i = 0; i &lt; 6; i++)
            for (int j = 0; j &lt; 51; j++) {
                meshVerts[i * 102 + 2 * j] = meshVerts[i * 102 + 2 * j]
                        * (1.0f + 0.0f * offset) ;

                meshVerts[i * 102 + 2 * j]=(offset) * meshVerts[i * 102 + 2 * j] *  (1+ (meshVerts[i * 102 + 2 * j+1]-1000)*(meshVerts[i * 102 + 2 * j+1]-1000)/10000 /width);
            }
        return meshVerts;
    }</pre>

<p>可阅读性已经基本没有了。。。。考虑到性能问题。。。最后可能还要把冗余的循环计算都合并起来。。。最后可能变成一个超长的公式。。。。。。。估计要做到一次成型。。然后再也不维护了。。</p>
<p>可阅读性要求很高。。。但是对性能又很敏感。。。。。我想想到底要怎么处理这个结构。。。</p>
<p>如果证实冗余的循环对性能影响不大的话。。。还是尽量把每个步骤分开写吧。。。优化的问题扔最后了</p>
<p>数值调整完以后要赶紧把 能拆出来的变量拆出来，能写成常量的写成常量。。不然过几天鬼还记得这个10000是怎么算出来的….</p>
<p>顺便发现用Google看函数图挑形状真是方便..</p>
<p><a href="http://dk-exp.com/wp-content/uploads/2015/01/google.jpg" target="_blank" rel="external"><img src="http://dk-exp.com/wp-content/uploads/2015/01/google-300x221.jpg" alt="google"></a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-folder-drawerlayout-2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/07/folder-drawerlayout-2/" class="article-date">
  	<time datetime="2015-01-07T09:56:13.000Z" itemprop="datePublished">2015-01-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/07/folder-drawerlayout-2/">Folder-DrawerLayout 开发日志1</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&nbsp;</p>
<p><img src="/images/Folder-DrawerLayout-develop-1.gif" alt="folder-drawer-layout"></p>
<p>动态效果加进去了…..</p>
<p>效果意外的恶心…..y轴的偏移看起来要换个 函数 重新构筑一下…</p>
<p>而且如果矩阵是预设的…..对应的偏移节点方程 其实可以算好了。。。再加个数组直接存在里面吧…</p>
<p>最后再用复杂界面测吧….估计效率是坨shit…..毕竟是 5*50矩阵….</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-generic-type-function" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/01/07/generic-type-function/" class="article-date">
  	<time datetime="2015-01-07T08:26:45.000Z" itemprop="datePublished">2015-01-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/01/07/generic-type-function/">泛型函数</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天看到一黑科技….</p>
<p>泛型类 泛型参数倒是很常用…</p>
<p>用在返回值类型上的泛型函数我还是第一次见到这么玩的…</p>
<p>写起代码来大概是这样</p>
<pre><code>public class MainActivity extends Activity{
    private Button mButton;
    private TextView mTextView;
    private ListView mListView;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        mButton = $(R.id.button);
        mTextView = $(R.id.textview);
        mListView = $(R.id.listview);

    }

    public &lt;T extends View&gt; T $(int id)
    {
        return (T) super.findViewById(id);
    }
}
</code></pre><p>一种JQuery的感觉。。。主要是这个$伪装成操作符的样子很有迷惑性…当然JQuery里的$本身也是这样实现的…..</p>
<p>好处大概是代码压缩的厉害。。省掉了强制类型转换。。写起代码来清晰一些。。</p>
<p>使用起来方便。。一共才1行代码。。扔BaseActivity里就好了。。</p>
<p>当然功能很弱逼。。。比注解形的弱多了。。。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-folder-drawerlayout-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/28/folder-drawerlayout-1/" class="article-date">
  	<time datetime="2014-12-28T10:42:40.000Z" itemprop="datePublished">2014-12-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/28/folder-drawerlayout-1/">Folder-DrawerLayout 开发日志0</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/Folder-DrawerLayout-develop-0.gif" alt="folder-drawer-layout"><br><img src="/images/moring-routine.png" alt="morning-routine"></p>
<p>又仔细看了下MorningRoutine….发现还有个渐变阴影…</p>
<p>目测应该是在挂verts之前用shader先渲染在原图上的</p>
<p>x轴看起来也不是均匀的….首</p>
<p>大概先是要把波长写成x相关的函数多代换一层…..</p>
<p>然后这个挤压效果还要把x轴总长按y轴位置等比压缩一下….</p>
<p>原效果verts矩阵是 5*15的…棱角还比较大…..不知道加大verts点数对性能有多大影响…</p>
<p>记录一下,元旦再弄了…有点蛋疼……一次要把这么多玩意载入脑子里面….一旦被interrupt就完了…看来是只适合半夜写了…</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-clientprotocolexception-circularredirectexception" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/12/01/clientprotocolexception-circularredirectexception/" class="article-date">
  	<time datetime="2014-12-01T00:37:26.000Z" itemprop="datePublished">2014-12-01</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/01/clientprotocolexception-circularredirectexception/">ClientProtocolException / CircularRedirectException</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ClientProtocolException-CircularRedirectException"><a href="#ClientProtocolException-CircularRedirectException" class="headerlink" title="ClientProtocolException / CircularRedirectException"></a>ClientProtocolException / CircularRedirectException</h2><p><img src="/images/redirect.png" alt="redirect"></p>
<p>CircularRedirectException 循环重定向<br>其实并没有真的发生循环重定向</p>
<p>三个请求顺序如下:</p>
<p><a href="https://stage.ajinga.com/v1/client-jobs/2680" target="_blank" rel="external">https://stage.ajinga.com/v1/client-jobs/2680</a></p>
<p>–&gt;</p>
<p><a href="http://stage.ajinga.com/m/client-jobs/2680/" target="_blank" rel="external">http://stage.ajinga.com/m/client-jobs/2680/</a></p>
<p>–&gt;</p>
<p><a href="https://stage.ajinga.com/m/client-jobs/2680/" target="_blank" rel="external">https://stage.ajinga.com/m/client-jobs/2680/</a></p>
<p>由于第2个和第3个请求 地址完全一致,<br>httpclient错误的判定其为 循环重定向.</p>
<p>当然实际上 第一次 redirect就该把请求重定向到 <a href="https://stage.ajinga.com/m/client-jobs/2680/" target="_blank" rel="external">https://stage.ajinga.com/m/client-jobs/2680/</a></p>
<p>但是server错误的返回了<br><a href="http://stage.ajinga.com/m/client-jobs/2680/" target="_blank" rel="external">http://stage.ajinga.com/m/client-jobs/2680/</a></p>
<p>由于server不支持非ssl方式连接,自动触发了重定向,又将其重定向至<a href="https://stage.ajinga.com/m/client-jobs/2680/" target="_blank" rel="external">https://stage.ajinga.com/m/client-jobs/2680/</a></p>
<p>逻辑上也没大问题,就是多了一次请求的时间.</p>
<p>通过设置参数</p>
<pre><code>httpClient.getHttpClient().getParams().setParameter(ClientPNames.ALLOW_CIRCULAR_REDIRECTS, true);
</code></pre><p>可以ignore 循环重定向问题.</p>
<p>但是本质上 server第一次就应当返回正确的https方式的redirect地址.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Blog/">Blog</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-how-to-soleve-eclipse-refresh-external-folder" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/21/how-to-soleve-eclipse-refresh-external-folder/" class="article-date">
  	<time datetime="2014-11-21T00:33:53.000Z" itemprop="datePublished">2014-11-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/21/how-to-soleve-eclipse-refresh-external-folder/">How to soleve eclipse refresh external folder</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="How-to-soleve-eclipse-refresh-external-folder"><a href="#How-to-soleve-eclipse-refresh-external-folder" class="headerlink" title="How to soleve eclipse refresh external folder"></a>How to soleve eclipse refresh external folder</h3><p>According to the stackoverflow:</p>
<blockquote>
<p>If you have references to external sources put them in a zip file:<br>YourProject-&gt;rightClick-&gt;Properties-&gt;Java Build Path-&gt;libraries-&gt;…, and then most notably android.jar, but other libs can be the culprit too. Expand it and and select Source attachment, and then (if it doesn’t say ‘None’) press the ‘Edit…’-button. If that points to a directory waht you should do is compress that <strong>source-directory</strong> into a zip file and make the source attachment point to that file.Apparently eclipse/adt feels the need to refresh sources on the file-system. When they’re in a zip-file it seems confident that they have not changed….</p>
</blockquote>
<p>Just unattached source code is OK.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-securerandom-changed-in-latest-android-versionmaybe-since-4-2" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/11/securerandom-changed-in-latest-android-versionmaybe-since-4-2/" class="article-date">
  	<time datetime="2014-11-10T18:13:15.000Z" itemprop="datePublished">2014-11-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/11/securerandom-changed-in-latest-android-versionmaybe-since-4-2/">SecureRandom changed in latest Android version(maybe since 4.2)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>使用以前的自己写的一个AES加密工具类的时候发现跑不通了,调用会直接crash,并抛出</p>
<pre><code>11-11 09:05:16.747: W/System.err(13832): java.security.NoSuchAlgorithmException: SecureRandom AES implementation not found
</code></pre><p>源代码如下:</p>
<pre><code>import java.io.UnsupportedEncodingException;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.security.Provider;
import java.security.SecureRandom;
import java.security.Security;
import java.util.Locale;

import javax.crypto.BadPaddingException;
import javax.crypto.Cipher;
import javax.crypto.IllegalBlockSizeException;
import javax.crypto.KeyGenerator;
import javax.crypto.NoSuchPaddingException;
import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

/**
* 
* @author Peter.Ding
* 
*/public class AESTools {
    private static AESTools instance = new AESTools();
    private String password = &quot;peter.ding@augmentum.com&quot;;
    private KeyGenerator kgen;

    private AESTools() {
    }

    public static AESTools getInstance() {
        return instance;
    }

    public String encrypt(String content) {
        try {
            kgen = KeyGenerator.getInstance(&quot;AES&quot;);
            Provider p = Security.getProvider(&quot;BC&quot;);
            SecureRandom s = SecureRandom.getInstance(&quot;AES&quot;, p);

            //The right code 
            //Provider p = Security.getProvider(&quot;Crypto&quot;); 
            //SecureRandom s = SecureRandom.getInstance(&quot;SHA1PRNG&quot;, p);

            s.setSeed(password.getBytes());
            kgen.init(128, s);
            SecretKey secretKey = kgen.generateKey();
            byte[] enCodeFormat = secretKey.getEncoded();
            SecretKeySpec key = new SecretKeySpec(enCodeFormat, &quot;AES&quot;);
            Cipher cipher = Cipher.getInstance(&quot;AES/ECB/PKCS5Padding&quot;);
            byte[] byteContent = content.getBytes(&quot;utf-8&quot;);
            cipher.init(Cipher.ENCRYPT_MODE, key);
            byte[] result = cipher.doFinal(byteContent);
            return bytesToHexString(result);
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
        } catch (NoSuchPaddingException e) {
            e.printStackTrace();
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
        } catch (IllegalBlockSizeException e) {
            e.printStackTrace();
        } catch (BadPaddingException e) {
            e.printStackTrace();
        } catch (InvalidKeyException e) {
            e.printStackTrace();
        }
        return null;
    }

    public String decrypt(String str) {
        byte[] content = hexStringToByte(str);
        try {
            kgen = KeyGenerator.getInstance(&quot;AES&quot;);
            Provider p = Security.getProvider(&quot;BC&quot;);
            SecureRandom s = SecureRandom.getInstance(&quot;AES&quot;, p);

            //The right code 
            //Provider p = Security.getProvider(&quot;Crypto&quot;); 
            //SecureRandom s = SecureRandom.getInstance(&quot;SHA1PRNG&quot;, p);

            s.setSeed(password.getBytes());
            kgen.init(128, s);
            SecretKey secretKey = kgen.generateKey();
            byte[] enCodeFormat = secretKey.getEncoded();
            SecretKeySpec key = new SecretKeySpec(enCodeFormat, &quot;AES&quot;);
            Cipher cipher = Cipher.getInstance(&quot;AES/ECB/PKCS5Padding&quot;);
            cipher.init(Cipher.DECRYPT_MODE, key);
            byte[] result = cipher.doFinal(content);
            System.out.println(bytesToHexString(result));
            return new String(result, &quot;utf-8&quot;);
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
        } catch (NoSuchPaddingException e) {
            e.printStackTrace();
        } catch (InvalidKeyException e) {
            e.printStackTrace();
        } catch (IllegalBlockSizeException e) {
            e.printStackTrace();
        } catch (BadPaddingException e) {
            e.printStackTrace();
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
        }
        return null;
    }

    public String bytesToHexString(byte[] src) {
        StringBuilder stringBuilder = new StringBuilder(&quot;&quot;);
        if (src == null || src.length &amp;lt;= 0) {
            return null;
        }
        for (int i = 0; i &amp;lt; src.length; i++) {
            int v = src[i] &amp;amp; 0xFF;
            String hv = Integer.toHexString(v);
            if (hv.length() &amp;lt; 2) {
                stringBuilder.append(0);
            }
            stringBuilder.append(hv);
        }
        return stringBuilder.toString().toUpperCase(Locale.ENGLISH);
    }

    public static byte[] hexStringToByte(String hex) {
        int len = (hex.length() / 2);
        byte[] result = new byte[len];
        char[] achar = hex.toCharArray();
        for (int i = 0; i &amp;lt; len; i++) {
            int pos = i * 2;
            result[i] = (byte) (toByte(achar[pos]) &amp;lt;&amp;lt; 4 | toByte(achar[pos + 1]));
        }
        return result;
    }

    private static byte toByte(char c) {
        byte b = (byte) &quot;0123456789ABCDEF&quot;.indexOf(c);
        return b;
    }

}
</code></pre><p>以上代码是我12年的时候为 加密数据库写的,我马上意识到肯定是Android又修改了Security Provider,当时2.1 2.3适配把我坑了一次,4.0适配又把我坑了一次,没想到还要坑我第三次…..无语…</p>
<pre><code>Provider p = Security.getProvider(&quot;BC&quot;);
SecureRandom s = SecureRandom.getInstance(&quot;AES&quot;, p);
</code></pre><p>报错的就是上面这行代码,果断复制粘贴百度</p>
<p>结果搜出来结果就是这个 <a href="http://dkmeteor.iteye.com/blog/1394887" target="_blank" rel="external">http://dkmeteor.iteye.com/blog/1394887</a></p>
<p>仔细一看还是我2012年写的blog…. 算了….不看也知道肯定是 Provider和SecureRandom又改动了…</p>
<p>直接拉Provider列表</p>
<pre><code>Android&apos;s OpenSSL-backed security provider
1ASN.1, DER, PkiPath, PKCS7
BouncyCastle Security Provider v1.49
HARMONY (SHA1 digest; SecureRandom; SHA1withDSA signature)
Harmony JSSE Provider
Android KeyStore security provider
</code></pre><p><a href="http://www.bouncycastle.org/" target="_blank" rel="external">http://www.bouncycastle.org/</a> 翻了一下文档 <code>BouncyCastle</code> 是支持AES的,不知为何直接调用会抛NoSuchAlgorithmException 没看到关于Android内Provider支持的Algorithm具体列表.</p>
<p>试了下使用 Android OpenSSL (2.3以下版本不支持) , 一样会抛出该错误,最后想了想改成原始版本的默认值 SHA1PRNG和Crypto. Done. (2.3+版本默认Default Provider修改成了 Android OpenSSL)</p>
<hr>
<p>后来又找到一篇 Security Enhancements in Jelly Bean 的文档</p>
<p><a href="http://android-developers.blogspot.com/2013/02/security-enhancements-in-jelly-bean.html" target="_blank" rel="external">http://android-developers.blogspot.com/2013/02/security-enhancements-in-jelly-bean.html</a></p>
<p>原文在墙外,关键部分我复制保存以下</p>
<blockquote>
<p>New implementation of SecureRandom</p>
<p>Android 4.2 includes a new default implementation of SecureRandom based on OpenSSL. In the older Bouncy Castle-based implementation, given a known seed, SecureRandom could technically (albeit incorrectly) be treated as a source of deterministic data. With the new OpenSSL-based implementation, this is no longer possible.</p>
<p>In general, the switch to the new SecureRandom implementation should be transparent to apps. However, if your app is relying on SecureRandom to generate deterministic data, such as keys for encrypting data, you may need to modify this area of your app. For example, if you have been using SecureRandom to retrieve keys for encrypting/decrypting content, you will need to find another means of doing that.</p>
<p>A recommended approach is to generate a truly random AES key upon first launch and store that key in internal storage. For more information, see the post “Using Cryptography to Store Credentials Safely”.<br>还有另一篇关于 最佳实践的</p>
</blockquote>
<p><a href="http://android-developers.blogspot.com/2013/02/using-cryptography-to-store-credentials.html" target="_blank" rel="external">http://android-developers.blogspot.com/2013/02/using-cryptography-to-store-credentials.html</a></p>
<p>&nbsp;</p>
<blockquote>
<p>The right way</p>
<p>A more reasonable approach is simply to generate a truly random AES key when an application is first launched:</p>
<p>public static SecretKey generateKey() throws NoSuchAlgorithmException {<br>// Generate a 256-bit key<br>final int outputKeyLength = 256;</p>
<p>SecureRandom secureRandom = new SecureRandom();<br>// Do <em>not</em> seed secureRandom! Automatically seeded from system entropy.<br>KeyGenerator keyGenerator = KeyGenerator.getInstance(“AES”);<br>keyGenerator.init(outputKeyLength, secureRandom);<br>SecretKey key = keyGenerator.generateKey();<br>return key;<br>}<br>Note that the security of this approach relies on safeguarding the generated key, which is is predicated on the security of the internal storage. Leaving the target file unencrypted (but set to MODE_PRIVATE) would provide similar security.</p>
<p>Even more security<br>If your app needs additional encryption, a recommended approach is to require a passphase or PIN to access your application. This passphrase could be fed into PBKDF2 to generate the encryption key. (PBKDF2 is a commonly used algorithm for deriving key material from a passphrase, using a technique known as “key stretching”.) Android provides an implementation of this algorithm inside SecretKeyFactory as PBKDF2WithHmacSHA1:</p>
<p>public static SecretKey generateKey(char[] passphraseOrPin, byte[] salt) throws NoSuchAlgorithmException, InvalidKeySpecException {<br>// Number of PBKDF2 hardening rounds to use. Larger values increase<br>// computation time. You should select a value that causes computation<br>// to take &gt;100ms.<br>final int iterations = 1000;</p>
<p>// Generate a 256-bit key<br>final int outputKeyLength = 256;</p>
<p>SecretKeyFactory secretKeyFactory = SecretKeyFactory.getInstance(“PBKDF2WithHmacSHA1”);<br>KeySpec keySpec = new PBEKeySpec(passphraseOrPin, salt, iterations, outputKeyLength);<br>SecretKey secretKey = secretKeyFactory.generateSecret(keySpec);<br>return secretKey;<br>}<br>The salt should be a random string, again generated using SecureRandom and persisted on internal storage alongside any encrypted data. This is important to mitigate the risk of attackers using a rainbow table to precompute password hashes.<br>因为使用了固定的seed作为随机种子生成器(RNG)的参数,导致生成的随机数其实是固定的,所以官方不推荐这种用法,当然我类库里的seed其实就是 加密密码,如果不需要指定密码的话, 倒是可以用官方的推荐的这种方式.</p>
</blockquote>
<p></p>
<p>&nbsp;</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/android/">android</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 DK
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>