<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>DK&#39;s Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="DK's Lab">
<meta property="og:url" content="http://blog.dk-exp.com/index.html">
<meta property="og:site_name" content="DK's Lab">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DK's Lab">
<meta name="twitter:description">
  
    <link rel="alternative" href="/atom.xml" title="DK&#39;s Lab" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?47d977b9cd46d5988a3e06ada67a7fa9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">DK</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/circle/" style="font-size: 10px;">circle</a> <a href="/tags/list/" style="font-size: 10px;">list</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">DK</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">DK</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-Android-7-0-new-APK-Signature-Scheme-v2-problem-with-multiply-channel-packer" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/04/Android-7-0-new-APK-Signature-Scheme-v2-problem-with-multiply-channel-packer/" class="article-date">
  	<time datetime="2016-08-04T06:49:22.000Z" itemprop="datePublished">2016-08-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/04/Android-7-0-new-APK-Signature-Scheme-v2-problem-with-multiply-channel-packer/">Android 7.0 new APK Signature Scheme v2 problem with multiply channel packer</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android 7.0 中新增了 <code>APK Signature Scheme v2</code> 签名方式</p>
<p>如果Android Studio升级到 v2.2+,构建APK时默认使用的签名方式就是<code>APK Signature Scheme v2</code></p>
<p>目前比较流行的2套 多渠道打包脚本</p>
<ul>
<li>在APK内注入${channel}.txt 文件</li>
<li>在APK的zip info中写入 channel 信息</li>
</ul>
<p>实质上都会在签名后修改APK文件,目前都会造成 签名认证失败<br>失败信息如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Yuki-Android git:(feature/small-fix) adb install /Users/dk/Documents/yuki-release/v3.1.8/Yuki-base-Direct.apk</span><br><span class="line">Failed to install /Users/dk/Documents/yuki-release/v3.1.8/Yuki-base-Direct.apk: Failure [INSTALL_PARSE_FAILED_NO_CERTIFICATES: Failed to collect certificates from /data/app/vmdl453897674.tmp/base.apk: META-INF/CERT.SF indicates /data/app/vmdl453897674.tmp/base.apk is signed using APK Signature Scheme v2, but no such signature was found. Signature stripped?]</span><br></pre></td></tr></table></figure>
<p>在非7.0设备上可以正常安装,在7.0设备上则无法通过签名认证.<br>现在可以通过在build.gradle中手动关闭APK Signature Scheme v2来避免此问题</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">signingConfigs &#123;</span><br><span class="line">       release &#123;</span><br><span class="line">           <span class="function">storeFile <span class="title">file</span><span class="params">(<span class="string">"xxxx"</span>)</span></span><br><span class="line">           storePassword "xxxx"</span><br><span class="line">           keyAlias "xxxx"</span><br><span class="line">           keyPassword "xxxx"</span><br><span class="line">           v2SigningEnabled <span class="keyword">false</span></span><br><span class="line">       &#125;</span><br><span class="line">       debug </span>&#123;</span><br><span class="line">           <span class="function">storeFile <span class="title">file</span><span class="params">(<span class="string">"xxxx"</span>)</span></span><br><span class="line">           storePassword "xxxx"</span><br><span class="line">           keyAlias "xxxx"</span><br><span class="line">           keyPassword "xxxx"</span><br><span class="line">           v2SigningEnabled <span class="keyword">false</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span></span><br></pre></td></tr></table></figure>
<p>目前暂时这样,考虑到以后v2签名可能会变成一个强制配置,可能需要等<code>APK Signature Scheme v2</code>具体文档和认证方式公布后,更新一下现在的多渠道打包脚本</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-Receiver-not-registered-android-widget-ZoomButtonsController-crash" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/31/Receiver-not-registered-android-widget-ZoomButtonsController-crash/" class="article-date">
  	<time datetime="2016-05-31T04:28:39.000Z" itemprop="datePublished">2016-05-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/31/Receiver-not-registered-android-widget-ZoomButtonsController-crash/">Receiver not registered: android.widget.ZoomButtonsController crash</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#好吧,继续整理 最近一段时间遇到的比较离奇的Bug</p>
<p>这个Bug log是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Receiver not registered: android.widget.ZoomButtonsController$<span class="number">1</span>@<span class="number">487</span>a4290</span><br><span class="line">at android.app.ActivityThread$PackageInfo.forgetReceiverDispatcher(ActivityThread.java:<span class="number">793</span>)</span><br><span class="line">at android.app.ContextImpl.unregisterReceiver(ContextImpl.java:<span class="number">913</span>)</span><br><span class="line">at android.content.ContextWrapper.unregisterReceiver(ContextWrapper.java:<span class="number">331</span>)</span><br><span class="line">at android.widget.ZoomButtonsController.setVisible(ZoomButtonsController.java:<span class="number">404</span>)</span><br><span class="line">at android.widget.ZoomButtonsController$<span class="number">2</span>.handleMessage(ZoomButtonsController.java:<span class="number">178</span>)</span><br><span class="line">at android.os.Handler.dispatchMessage(Handler.java:<span class="number">99</span>)</span><br><span class="line">at android.os.Looper.loop(Looper.java:<span class="number">123</span>)</span><br><span class="line">at android.app.ActivityThread.main(ActivityThread.java:<span class="number">4627</span>)</span><br><span class="line">at java.lang.reflect.Method.invokeNative(Native Method)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:<span class="number">521</span>)</span><br><span class="line">at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">858</span>)</span><br><span class="line">at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">616</span>)</span><br><span class="line">at dalvik.system.NativeStart.main(Native Method)</span><br></pre></td></tr></table></figure>
<p>因为这个Log Trace里没有任何我的代码,所以感觉上和我的应用没什么关系,而且也看不出是在哪个界面哪个地方发生的,当时也没办法复现.<br>只是在Umeng的后台会不断收集到这样的crash log,不多,但是偶尔就会有那么几个.<br>后来花时间研究了一下,发现应用中只有Webview中有这个东西.</p>
<p>这样有针对性的来测试,很快就找到了重现路径. zoom controller有个默认的渐隐动画,只要在动画进行重退出Activity,就会重现这个crash</p>
<p>同时也找到了几个相关issue:<br><a href="https://code.google.com/p/android/issues/detail?id=15694" target="_blank" rel="external">https://code.google.com/p/android/issues/detail?id=15694</a><br><a href="http://stackoverflow.com/questions/5267639/how-to-safely-turn-webview-zooming-on-and-off-as-needed" target="_blank" rel="external">http://stackoverflow.com/questions/5267639/how-to-safely-turn-webview-zooming-on-and-off-as-needed</a><br><a href="http://stackoverflow.com/questions/4908794/webview-throws-receiver-not-registered-android-widget-zoombuttonscontroller" target="_blank" rel="external">http://stackoverflow.com/questions/4908794/webview-throws-receiver-not-registered-android-widget-zoombuttonscontroller</a></p>
<p>解决方案是各种hack</p>
<ol>
<li>如果不需要直接禁用即可</li>
<li>重载webview,destroy的时候处理zoomButtonController</li>
<li>重载Activity,延迟2秒destroy webview</li>
<li>finish之前把webview及所有子view从rootview里remove掉. (这个没试过)</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-java-lang-IllegalStateException-package-not-installed" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/31/java-lang-IllegalStateException-package-not-installed/" class="article-date">
  	<time datetime="2016-05-31T04:05:31.000Z" itemprop="datePublished">2016-05-31</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/31/java-lang-IllegalStateException-package-not-installed/">java.lang.IllegalStateException: package not installed</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#java.lang.IllegalStateException: package not installed</p>
<p>用了Android Studio的时候偶尔会遇到这个问题.</p>
<p>ref: <a href="http://stackoverflow.com/questions/24426635/caused-by-java-lang-illegalstateexception-package-not-installed" target="_blank" rel="external">http://stackoverflow.com/questions/24426635/caused-by-java-lang-illegalstateexception-package-not-installed</a><br>ref: <a href="http://stackoverflow.com/questions/35675855/android-studio-floatingactionbutton-error" target="_blank" rel="external">http://stackoverflow.com/questions/35675855/android-studio-floatingactionbutton-error</a></p>
<p>解决方案很简单,gradle重新sync一下就好了.</p>
<p>重现步骤大概是这样,gradle sync/build中,修改lib/compile配置,或者同时在命令行clean build,会导致build过程中某些该编译进去的jar/module丢失,于是运行时会报各种奇怪的Bug.大部分那都是 package not installed / class not found 一类的</p>
<p>这种时候修改一下gradle文件重新sync 就能修复此问题.本质上是IDE/gradle的bug,不知道原因的话解决起来有点蛋疼.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-mediaplayer-suspend-bug" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/27/mediaplayer-suspend-bug/" class="article-date">
  	<time datetime="2016-05-27T09:48:00.000Z" itemprop="datePublished">2016-05-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/27/mediaplayer-suspend-bug/">播放网络音频时,MediaPlayer在Prepare阶段访问任何API都会造成主线程阻塞</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#播放网络音频时,MediaPlayer在Prepare阶段访问任何API都会造成线程阻塞</p>
<p>播放本地音频时,prepare阶段很短,基本不会发生这种情况,但是播放网络音频时,无论是使用prepare() 还是 prepareAsync()<br>MediaPlayer都会进入lock状态,此时调用MediaPlayer的任何API,比如stop/release/reset时,都会直接阻塞调用的线程,直到Prepare完成或失败.应用会抛出ANR. </p>
<p>当时文件服务使用的是七牛,据观察,七牛CDN在我这里似乎有点问题,请求成功率大概只有95%左右,在糟糕的网络环境下,这个问题更容易出现</p>
<p>这个问题比较蛋疼,由于当时需求是需要在前台播放一段网络音频,不需要后台播放,所以MediaPlayer对象直接由前台持有,切换音频时,不销毁MediaPlayer,而是stop() &amp; reset()以后重新Prepare().</p>
<p>但是发现用户快速切换音频时,有时会发生anr,抓了一些anr log以后发现,anr竟然是在stop()release()上发生的.</p>
<p>尝试过新建Thread去prepare,也试过prepareAsync(),都不解决问题,阻塞是在调用stop/reset时发生的.</p>
<p>相关的Google issue : <a href="https://code.google.com/p/android/issues/detail?id=959" target="_blank" rel="external">https://code.google.com/p/android/issues/detail?id=959</a></p>
<p>最后的我的解决方案是,将MediaPlayer做一下包装,prepare完成前不允许访问其任何方法(比如 stop getDuration release reset …),需要访问的时候,比如退出界面的时候Stop/release 单独开一个Thread来call这些方法,这样也只会阻塞一个异步线程.</p>
<p>这样配置以后基本解决了该问题</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-android-secondary-sdcard" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/23/android-secondary-sdcard/" class="article-date">
  	<time datetime="2016-05-23T11:01:23.000Z" itemprop="datePublished">2016-05-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/23/android-secondary-sdcard/">Android中如何获取Secondary External Storage路径(android secondary sdcard setting)</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前置条件</p>
<p>当Android同时拥有内置存储区和外置SD卡时,外置存储卡会被识别为 <code>Secondary External Storage</code>.<br>本文讨论的是该情况下 <code>Secondart External Storage</code>的识别和读写问题,如果你没有SD卡,或没有内置存储区的设备,只要简单使用<code>Environment.getExternalStorageDirectory()</code> 就好了</p>
<ul>
<li>如何获得外置SD卡路径</li>
</ul>
<p><code>Environment.getExternalStorageDirectory()</code> 获得的只是系统逻辑上的存储区,在目前的大部分手机上,返回的其实是内置存储区路径<br>Google也没有提供一个明确的方法来或者外置存储卡路径.</p>
<p>1.对于Android 4.4 及以上设备使用 <code>Application.getExternalFilesDirs(null)</code>,然后返回的数组中就包含内置存储区路径和SD卡路径,简单判断一下就好了.<br>需要注意的是,返回的路径应当是 /storage/sdcard1/Android/data/your.packagename 的一个路径,在SD卡内,只有该路径下应用是拥有写权限的,其它路径下你都只有只读权限.<br>相关文档请参考这个:<br><a href="https://developer.android.com/reference/android/content/ContextWrapper.html#getExternalFilesDirs(java.lang.String" target="_blank" rel="external">https://developer.android.com/reference/android/content/ContextWrapper.html#getExternalFilesDirs(java.lang.String</a>)</p>
<p>简单来说,4.4以后你就不能在SD卡上瞎几把放东西了,只能存储在系统给你指定的地方</p>
<ol>
<li>对于低于4.4版本的设备,只有一些歪门邪道的方法</li>
</ol>
<p>一种方式是可以通过<code>mount</code>命令的返回来搜索SD卡路径,不是特别靠谱<br>相关代码可以参考 <a href="http://stackoverflow.com/questions/5694933/find-an-external-sd-card-location/9406276#9406276" target="_blank" rel="external">http://stackoverflow.com/questions/5694933/find-an-external-sd-card-location/9406276#9406276</a><br>但是请注意,我看到过4~5种不一样的匹配方法,感觉和manufacture关系很大,国内瞎几把定制ROM不确定性更大,请配合<code>File.canRead()</code>验证使用.</p>
<p>代码贴一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FilenameFilter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * <span class="doctag">@author</span> ajeet</span><br><span class="line"> *05-Dec-2014  2014</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StorageUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRemovebleSDCardMounted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"/sys/class/block/"</span>);</span><br><span class="line">        File[] files = file.listFiles(<span class="keyword">new</span> MmcblkFilter(<span class="string">"mmcblk\\d$"</span>));</span><br><span class="line">        <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (File mmcfile : files) &#123;</span><br><span class="line">            File scrfile = <span class="keyword">new</span> File(mmcfile, <span class="string">"device/scr"</span>);</span><br><span class="line">            <span class="keyword">if</span> (scrfile.exists()) &#123;</span><br><span class="line">                flag = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRemovebleSDCardPath</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String sdpath = <span class="keyword">null</span>;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"/sys/class/block/"</span>);</span><br><span class="line">        File[] files = file.listFiles(<span class="keyword">new</span> MmcblkFilter(<span class="string">"mmcblk\\d$"</span>));</span><br><span class="line">        String sdcardDevfile = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (File mmcfile : files) &#123;</span><br><span class="line">            Log.d(<span class="string">"SDCARD"</span>, mmcfile.getAbsolutePath());</span><br><span class="line">            File scrfile = <span class="keyword">new</span> File(mmcfile, <span class="string">"device/scr"</span>);</span><br><span class="line">            <span class="keyword">if</span> (scrfile.exists()) &#123;</span><br><span class="line">                sdcardDevfile = mmcfile.getName();</span><br><span class="line">                Log.d(<span class="string">"SDCARD"</span>, mmcfile.getName());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sdcardDevfile == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        FileInputStream is;</span><br><span class="line">        BufferedReader reader;</span><br><span class="line"></span><br><span class="line">        files = file.listFiles(<span class="keyword">new</span> MmcblkFilter(sdcardDevfile + <span class="string">"p\\d+"</span>));</span><br><span class="line">        String deviceName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (files.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Log.d(<span class="string">"SDCARD"</span>, files[<span class="number">0</span>].getAbsolutePath());</span><br><span class="line">            File devfile = <span class="keyword">new</span> File(files[<span class="number">0</span>], <span class="string">"dev"</span>);</span><br><span class="line">            <span class="keyword">if</span> (devfile.exists()) &#123;</span><br><span class="line">                FileInputStream fis = <span class="keyword">new</span> FileInputStream(devfile);</span><br><span class="line">                reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(fis));</span><br><span class="line">                String line = reader.readLine();</span><br><span class="line">                deviceName = line;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(<span class="string">"SDCARD"</span>, <span class="string">""</span> + deviceName);</span><br><span class="line">            <span class="keyword">if</span> (deviceName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(<span class="string">"SDCARD"</span>, deviceName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> File mountFile = <span class="keyword">new</span> File(<span class="string">"/proc/self/mountinfo"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mountFile.exists()) &#123;</span><br><span class="line">                is = <span class="keyword">new</span> FileInputStream(mountFile);</span><br><span class="line">                reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Log.d("SDCARD", line);</span></span><br><span class="line">                    <span class="comment">// line = reader.readLine();</span></span><br><span class="line">                    <span class="comment">// Log.d("SDCARD", line);</span></span><br><span class="line">                    String[] mPonts = line.split(<span class="string">"\\s+"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mPonts.length &gt; <span class="number">6</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mPonts[<span class="number">2</span>].trim().equalsIgnoreCase(deviceName)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mPonts[<span class="number">4</span>].contains(<span class="string">".android_secure"</span>)</span><br><span class="line">                                    || mPonts[<span class="number">4</span>].contains(<span class="string">"asec"</span>)) &#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            sdpath = mPonts[<span class="number">4</span>];</span><br><span class="line">                            Log.d(<span class="string">"SDCARD"</span>, mPonts[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sdpath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MmcblkFilter</span> <span class="keyword">implements</span> <span class="title">FilenameFilter</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String pattern;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MmcblkFilter</span><span class="params">(String pattern)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.pattern = pattern;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String filename)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (filename.matches(pattern)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以红米1举例,插入SD卡后,mount返回如下</p>
<pre><code>rootfs / rootfs ro,relatime 0 0
tmpfs /dev tmpfs rw,seclabel,nosuid,relatime,size=437680k,nr_inodes=109420,mode=755 0 0
devpts /dev/pts devpts rw,seclabel,relatime,mode=600 0 0
proc /proc proc rw,relatime 0 0
sysfs /sys sysfs rw,seclabel,relatime 0 0
selinuxfs /sys/fs/selinux selinuxfs rw,relatime 0 0
debugfs /sys/kernel/debug debugfs rw,relatime 0 0
none /acct cgroup rw,relatime,cpuacct 0 0
none /sys/fs/cgroup tmpfs rw,seclabel,relatime,size=437680k,nr_inodes=109420,mode=750,gid=1000 0 0
none /sys/fs/cgroup/memory cgroup rw,relatime,memory 0 0
tmpfs /mnt/asec tmpfs rw,seclabel,relatime,size=437680k,nr_inodes=109420,mode=755,gid=1000 0 0
tmpfs /mnt/obb tmpfs rw,seclabel,relatime,size=437680k,nr_inodes=109420,mode=755,gid=1000 0 0
none /dev/cpuctl cgroup rw,relatime,cpu 0 0
/dev/block/platform/msm_sdcc.1/by-name/system /system ext4 ro,seclabel,relatime,data=ordered 0 0
/dev/block/platform/msm_sdcc.1/by-name/userdata /data ext4 rw,seclabel,nosuid,nodev,relatime,discard,noauto_da_alloc,data=ordered 0 0
/dev/block/platform/msm_sdcc.1/by-name/cache /cache ext4 rw,seclabel,nosuid,nodev,relatime,discard,noauto_da_alloc,data=ordered 0 0
/dev/block/platform/msm_sdcc.1/by-name/persist /persist ext4 rw,seclabel,nosuid,nodev,relatime,discard,noauto_da_alloc,data=ordered 0 0
/dev/block/platform/msm_sdcc.1/by-name/modem /firmware vfat ro,relatime,uid=1000,gid=1000,fmask=0337,dmask=0227,codepage=cp437,iocharset=iso8859-1,shortname=lower,errors=remount-ro 0 0
/dev/fuse /mnt/shell/emulated fuse rw,nosuid,nodev,relatime,user_id=1023,group_id=1023,default_permissions,allow_other 0 0
/dev/fuse /storage/emulated/legacy fuse rw,nosuid,nodev,relatime,user_id=1023,group_id=1023,default_permissions,allow_other 0 0
/dev/block/vold/179:65 /mnt/media_rw/sdcard1 vfat rw,dirsync,nosuid,nodev,noexec,relatime,uid=1023,gid=1023,fmask=0007,dmask=0007,allow_utime=0020,codepage=cp437,iocharset=iso8859-1,shortname=mixed,utf8,errors=remount-ro 0 0
/dev/fuse /storage/sdcard1 fuse rw,nosuid,nodev,relatime,user_id=1023,group_id=1023,default_permissions,allow_other 0 0
</code></pre><p>可以看到,以上面的字符串匹配或者stackoverflow上其它几种验证方法(asec / vfat / void),都匹配不到最后那条记录</p>
<p>另一种方法:<br>读取 <code>/system/etc/vold.fstab</code></p>
<p>示例代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(<span class="keyword">new</span> File(<span class="string">"/system/etc/vold.fstab"</span>));</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNext()) &#123;</span><br><span class="line">            String line = scanner.nextLine();</span><br><span class="line">            <span class="keyword">if</span> (line.startsWith(<span class="string">"dev_mount"</span>)) &#123;</span><br><span class="line">                String[] lineElements = line.split(<span class="string">" "</span>);</span><br><span class="line">                String element = lineElements[<span class="number">2</span>];</span><br><span class="line">    </span><br><span class="line">                <span class="keyword">if</span> (element.contains(<span class="string">":"</span>))</span><br><span class="line">                    element = element.substring(<span class="number">0</span>, element.indexOf(<span class="string">":"</span>));</span><br><span class="line">    </span><br><span class="line">                <span class="keyword">if</span> (element.contains(<span class="string">"usb"</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line">                <span class="comment">// don't add the default vold path</span></span><br><span class="line">                <span class="comment">// it's already in the list.</span></span><br><span class="line">                <span class="keyword">if</span> (!out.contains(element))</span><br><span class="line">                    <span class="comment">//这里就是你要的SD卡路径了</span></span><br><span class="line">                    out.add(element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>还是以红米1为例,贴一下’/system/etc/vold.fstab’的内容</p>
<pre><code># Copyright (c) 2012, The Linux Foundation. All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are
# met:
#     * Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#     * Redistributions in binary form must reproduce the above
#       copyright notice, this list of conditions and the following
#       disclaimer in the documentation and/or other materials provided
#       with the distribution.
#     * Neither the name of The Linux Foundation nor the names of its
#       contributors may be used to endorse or promote products derived
#       from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED
# WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT
# ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

dev_mount sdcard /storage/sdcard1 auto /devices/msm_sdcc.2/mmc_host
</code></pre><p>保险起见,我目前是以上2种方法同时使用,再用<code>file.canRead()</code>检查是否存在</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-Android-App-ABI-setting" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/17/Android-App-ABI-setting/" class="article-date">
  	<time datetime="2016-05-17T02:18:43.000Z" itemprop="datePublished">2016-05-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/17/Android-App-ABI-setting/">Android-App-ABI-setting</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先放结论:<br>最优性能且不考虑安装包体积<br>提供armeabi,armeabi-v7a,arm64-v8a,x86_64</p>
<p>全适配+最小体积<br>提供armeabi,armeabi-v7a</p>
<p>最小体积+99%适配<br>提供armeabi-v7a</p>
<hr>
<p>首先官方的ABI说明<br>ref: <a href="https://developer.android.com/ndk/guides/abis.html" target="_blank" rel="external">https://developer.android.com/ndk/guides/abis.html</a></p>
<p>理想情况下,App应当同时提供armeabi,armeabi-v7a,arm64-v8a,x86,x86_64,mips,mips64的so文件<br>一些比较小的类库提供全部的so以保证在全平台能以最优性能运行,是没有问题的</p>
<p>但是有时候会有一些较大的类库,比如ffmpeg,opencv之类,一个so文件就有3~5mb,全部提供会让APK体积过于膨胀,这个时候就需要进行适当的权衡.</p>
<hr>
<p>不考虑最优性能的话:</p>
<p>其中 x86(x86_32) 的真实设备实际上并不存在,只有模拟器可以调成x86_32,实际存在的CPU都是x86_64的<br>并且,所有x86_64的设备都支持Secondary ABI, 大部分配置都是 armeabi/armeabi-v7a , 不考虑性能最优的话,是可以不提供的</p>
<p>mips略过,印象中只有早期起一些android laptop 是这种架构.</p>
<hr>
<p>这样我们需要实际考虑的ABI只有armeabi,armeabi-v7a,arm64-v8a</p>
<p>考虑最小体积,其实只提供一个armeabi-v7a对于99%的机型就足够了<br>目前就测试结果看<br>只有 MX4 / MX4 PRO 的5.1/5.1.1 会无法找到so文件,猜测可能Primary ABI是 arm64-v8a 并且 Secondary ABI是 armeabi<br>完美的避过了v7a ,当然也有可能是别的原因.目前观察到的只有这款机型有问题</p>
<hr>
<p>之后因为armeabi(实际上是V5)的设备现在市面上几乎已经没有了,考虑兼容,当时尝试使用了v7a+v8a的so,没有提供armeabi版本的so<br>大约也能覆盖98%的设备<br>上线后发现OPPO R7(全系列几乎都有),魅蓝Metal,魅蓝Note,魅族 PRO 5出现大量crash,马上做了hotfix.<br>从数据看,只发生在 Oppo和魅族上,其它机型完全没有.<br>我也很郁闷,这几款机型CPU都是 arm64的,反而找不到v8a的so,具体是个什么情况我不是很理解</p>
<p>就最终结果来看,使用v7a就能覆盖99%的设备(除了魅族 MX4 / MX 4 PRO)<br>为了支持这一设备,再配上个armeabi的so就好了</p>
<hr>
<p>主要观察的数据是应用在umeng后台的错误统计<br>以下是一些测试数据</p>
<p>OPPO R7 V5       OK</p>
<p>OPPO R7 v7 OK</p>
<p>OPPO R7 V5+v7    OK</p>
<p>OPPO R7 V5+v7+V8 OK</p>
<p>OPPO R7 v7+V8 CRASH</p>
<p>OPPO R7 5.0 V7+V8 OK</p>
<p>魅蓝note2 V5   CRASH</p>
<p>魅蓝note2 v7   OK </p>
<p>魅蓝note2 v7+v8   OK</p>
<p>魅蓝note2 V5+v7+v8 OK   </p>
<p>乐视 V5   CRASH</p>
<p>乐视 v7      OK</p>
<p>乐视 v7+v8      OK</p>
<p>乐视 V5+v7+v8    OK</p>
<p>NEXUS 5X V5 CRASH</p>
<p>NEXUS 5X V7 OK</p>
<p>NEXUS 5X V7+V8 OK </p>
<p>PRO 5 V7 CRASH</p>
<p>PRO 5 V7+V8 CRASH</p>
<p>PRO 5 V5 OK</p>
<p>PRO 5 V5+V7+V8 OK</p>
<p>GALAXY S6 V7 OK</p>
<p>GALAXY S6 V5+V7 OK</p>
<p>最终方案使用 v5+v7,v8a以兼容模式运行32位库<br>以下设备测试没问题.</p>
<p>OPPO R7 OK</p>
<p>三星 S6 OK</p>
<p>华为 mate S OK</p>
<p>魅蓝note2 OK</p>
<p>魅族 PRO 5 OK</p>
<p>nexus 5X OK</p>
<p>小米4C OK</p>
<p>乐视手机 OK</p>
<p>nexus 5 OK</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-Mediaplayer-ConfigPriority-0x6f800002-ERROR-on-Marshmallow" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/22/Mediaplayer-ConfigPriority-0x6f800002-ERROR-on-Marshmallow/" class="article-date">
  	<time datetime="2016-04-22T07:59:30.000Z" itemprop="datePublished">2016-04-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/22/Mediaplayer-ConfigPriority-0x6f800002-ERROR-on-Marshmallow/">Mediaplayer ConfigPriority(0x6f800002)) ERROR on Marshmallow</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#Mediaplayer ConfigPriority(0x6f800002)) ERROR on Marshmallow</p>
<p>Android 6.0 使用源生MediaPlayer播放小于15s的音频文件时,有可能会抛出此错误 ConfigPriority(0x6f800002))<br>不会crash,但是没有声音</p>
<p>log:</p>
<pre><code>04-21 16:42:11.787 745-21846/? I/QComExtractorFactory: Sniff: Set key to use qti parser
04-21 16:42:11.787 745-21846/? I/FFmpegExtractor: android-source:0xee977200
04-21 16:42:11.790 745-21846/? E/FFmpegExtractor: android-source:0xee977200: avformat_open_input failed, err:Invalid data found when processing input
04-21 16:42:11.790 745-21846/? W/FFmpegExtractor: sniff through BetterSniffFFMPEG failed, try LegacySniffFFMPEG
04-21 16:42:11.793 745-21846/? E/FFmpegExtractor: android-source:0xee977200|file:: avformat_open_input failed, err:Invalid data found when processing input
04-21 16:42:11.793 745-21846/? D/FFmpegExtractor: SniffFFMPEG failed to sniff this source
04-21 16:42:11.793 745-21846/? I/ExtendedExtractor: QTIParser is prefered
04-21 16:42:11.793 745-21846/? D/MMParserExtractor: setExtraFlags called with flags 3 for paser instance ee977340
04-21 16:42:11.793 745-21846/? D/MMParserExtractor: using bigger parser buffers
04-21 16:42:11.793 745-21846/? I/ExtendedExtractor: ExtendedExtractor::create 0xee977340
04-21 16:42:11.793 745-21846/? I/ExtendedExtractor: ExtendedExtractor::updateExtractor: Use default QTI parser 
04-21 16:42:11.793 745-21846/? D/MMParserExtractor: Overiding Parser out buffer size  = 262144 
04-21 16:42:11.794 745-21845/? D/NuPlayerDriver: notifyListener_l(0xefee20a0), (1, 0, 0)
04-21 16:42:11.796 745-3258/? D/NuPlayerDriver: start(0xefee20a0), state is 4, eos is 0
04-21 16:42:11.796 745-21845/? I/GenericSource: start
04-21 16:42:11.797 745-21845/? I/AudioPolicyManagerCustom: Offload min duration is 15s
04-21 16:42:11.797 745-21845/? I/AudioPolicyManagerCustom: PCM offload property is enabled
04-21 16:42:11.797 745-21845/? I/AudioPolicyManagerCustom: Offload min duration is 15s
04-21 16:42:11.798 745-21845/? I/AudioPolicyManagerCustom: Offload min duration is 15s
04-21 16:42:11.798 745-21845/? I/AudioPolicyManagerCustom: PCM offload property is enabled
04-21 16:42:11.798 745-21845/? I/AudioPolicyManagerCustom: Offload min duration is 15s
04-21 16:42:11.812 745-21850/? E/OMXNodeInstance: setConfig(21f:google.aac.decoder, ConfigPriority(0x6f800002)) ERROR: Undefined(0x80001001)
04-21 16:42:11.812 745-21850/? I/ACodec: codec does not support config priority (err -2147483648)
04-21 16:42:11.813 745-21850/? I/MediaCodec: MediaCodec will operate in async mode
04-21 16:42:11.814 745-21851/? I/SoftAAC2: Reconfiguring decoder: 0-&gt;44100 Hz, 0-&gt;0 channels
04-21 16:42:11.815 745-21851/? W/SoftAAC2: aacDecoder_DecodeFrame decoderErr = 0x4007
04-21 16:42:11.815 745-21851/? W/SoftAAC2: AAC decoder returned error 0x4007, substituting silence
04-21 16:42:11.816 745-21849/? I/NuPlayerDecoder: [audio] saw output EOS
04-21 16:42:11.816 745-21845/? I/ExtendedNuPlayer: notifyListener 2 0 0
04-21 16:42:11.816 745-21845/? D/NuPlayerDriver: notifyListener_l(0xefee20a0), (2, 0, 0)
04-21 16:42:11.816 745-21848/? W/NuPlayerRenderer: onDrainAudioQueue(): audio sink is not ready
</code></pre><p>google issue已经确认了此Bug,目前处在assign状态,不过在6.0.1上测试时已经正常.</p>
<p>ref <a href="https://code.google.com/p/android/issues/detail?id=189051" target="_blank" rel="external">google issue</a> [需翻墙]</p>
<p>从log和更新记录上看,猜测似乎是offload的影响</p>
<pre><code>av.offload.enable=true 
av.streaming.offload.enable=true 
audio.offload.buffer.size.kb=64 
audio.offload.min.duration.secs=30 
audio.offload.gapless.enabled=true 
audio.offload.pcm.16bit.enable=true 
audio.offload.pcm.24bit.enable=true
</code></pre><p>从源码上看 似乎针对不同长度的音频文件 ,根据offload.enable和offload.min.duration,会有不同的处理方式</p>
<p>Audio Offload 音频分载, 具体代码逻辑没有细看,也不大清楚具体错误原因</p>
<p>目前唯一已知解决方案是,降级到5.0或升级到6.0.1+</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-CoordinatorLayout" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/30/CoordinatorLayout/" class="article-date">
  	<time datetime="2016-03-30T01:56:02.000Z" itemprop="datePublished">2016-03-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/30/CoordinatorLayout/">CoordinatorLayout中的坑</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>踩完了坑记录一下，CoordinatorLayout使用介绍请看chrisbanes的<a href="https://github.com/chrisbanes/cheesesquare" target="_blank" rel="external">cheesesquare</a></p>
<p>如果你只打算学习一下CoordinatorLayout然后写2个Demo试试，那么本文并没有什么卵用，但是如果你打算在生产环境使用CoordinatorLayout，那么强烈推荐阅读一下本文，可以减少很多弯路，这个东西看起来很好，但是实际上坑也很多。</p>
<p>###前言<br>很多应用主页常见的构造模式</p>
<p>一个包含ActionBar和Banner的header+ViewPager的组合模式<br>比如这样：</p>
<p><img src="/images/appbar_extend.png" alt="img"></p>
<p>然后需要滚动的时候能够将 ActionBar和Banner滚出界面，但是又需要ViewPager的TabLayout能固定在屏幕顶部<br>比如滚动后是这样：</p>
<p><img src="/images/appbar_close.png" alt="img"></p>
<p>Github上有很多sticky-viewpager xx-header-viewpager之类的项目提供类似的功能，但是大部分都会存在各种事件冲突问题，比如滑动不流畅，卡顿，弹跳之类的。</p>
<p>好在Android新的SupportLibrary提供了CoordinatorLayout能直接实现类似功能，具体如何使用参考 SupportLibrary中CoordinatorLayout的使用文档即可，例子也可以直接看<a href="https://github.com/chrisbanes/cheesesquare" target="_blank" rel="external">cheesesquare</a></p>
<p>我就谈下使用过程中里面的坑：</p>
<h4 id="不支持ListView-不支持ScrollView，低版本不兼容ViewCompat-setNestedScrollingEnabled"><a href="#不支持ListView-不支持ScrollView，低版本不兼容ViewCompat-setNestedScrollingEnabled" class="headerlink" title="不支持ListView,不支持ScrollView，低版本不兼容ViewCompat.setNestedScrollingEnabled"></a>不支持ListView,不支持ScrollView，低版本不兼容ViewCompat.setNestedScrollingEnabled</h4><p>PS.更新</p>
<p>support 23.1+新增了</p>
<pre><code>ViewCompat.setNestedScrollingEnabled(listView/gridview,true); 
</code></pre><p>可以给ListView提供NestedScrolling支持,但是只在LOLIPOP+版本上生效，下面的方案也一样。</p>
<p>低版本只能使用RecyclerView</p>
<hr>
<p>一些文档/博客文章上说 可以使用一个 可滚动的组件<br>还有些错误的文章说 支持ListView</p>
<p>实际上该组件必须实现了 NestedScrollingChild接口</p>
<p>你可以使用RecyclerView,RecyclerView自身就实现了该接口，如果你要使用其他组件，那么可能需要继承原来的View并实现NestedScrollingChild接口</p>
<p>一个实现了NestedScrollingChild的Listview demo如下：</p>
<pre><code>public class NestedScrollingListView extends ListView implements NestedScrollingChild {

    private final NestedScrollingChildHelper mScrollingChildHelper;

    public NestedScrollingListView(Context context) {
        super(context);
        mScrollingChildHelper = new NestedScrollingChildHelper(this);
        setNestedScrollingEnabled(true);
    }

    public NestedScrollingListView(Context context, AttributeSet attrs) {
        super(context, attrs);
        mScrollingChildHelper = new NestedScrollingChildHelper(this);
        setNestedScrollingEnabled(true);
    }

    @Override
    public void setNestedScrollingEnabled(boolean enabled) {
        mScrollingChildHelper.setNestedScrollingEnabled(enabled);
    }

    @Override
    public boolean isNestedScrollingEnabled() {
        return mScrollingChildHelper.isNestedScrollingEnabled();
    }

    @Override
    public boolean startNestedScroll(int axes) {
        return mScrollingChildHelper.startNestedScroll(axes);
    }

    @Override
    public void stopNestedScroll() {
        mScrollingChildHelper.stopNestedScroll();
    }

    @Override
    public boolean hasNestedScrollingParent() {
        return mScrollingChildHelper.hasNestedScrollingParent();
    }

    @Override
    public boolean dispatchNestedScroll(int dxConsumed, int dyConsumed, int dxUnconsumed,
                                        int dyUnconsumed, int[] offsetInWindow) {
        return mScrollingChildHelper.dispatchNestedScroll(dxConsumed, dyConsumed,
                dxUnconsumed, dyUnconsumed, offsetInWindow);
    }

    @Override
    public boolean dispatchNestedPreScroll(int dx, int dy, int[] consumed, int[] offsetInWindow) {
        return mScrollingChildHelper.dispatchNestedPreScroll(dx, dy, consumed, offsetInWindow);
    }

    @Override
    public boolean dispatchNestedFling(float velocityX, float velocityY, boolean consumed) {
        return mScrollingChildHelper.dispatchNestedFling(velocityX, velocityY, consumed);
    }

    @Override
    public boolean dispatchNestedPreFling(float velocityX, float velocityY) {
        return mScrollingChildHelper.dispatchNestedPreFling(velocityX, velocityY);
    }
}
</code></pre><p>其他View也可以使用类似的方式实现。</p>
<p>只对 5.0+ 生效，低版本无效。</p>
<h4 id="RecyclerView滑动的时候不流畅"><a href="#RecyclerView滑动的时候不流畅" class="headerlink" title="RecyclerView滑动的时候不流畅"></a>RecyclerView滑动的时候不流畅</h4><p>目前已知 r23.1 &amp; r 23.2  都存在此问题，Google code的提交代码里倒是有相关修复记录，但是目前还没有发布。</p>
<p>直接原因是Fling Direction错误，导致Fling事件被吃掉了，ACTION_UP/ACTION_CANCEL事件一旦发生，scroll动作直接停止</p>
<p>StackOverFlow上一个高票解决方案是重写一个FlingBehavior，并配置给AppBar.</p>
<p>注意，这个Behavior是给AppBar的，不是给下面的可滚动组件的。</p>
<pre><code>&lt;android.support.design.widget.AppBarLayout
android:id=&quot;@+id/appbar&quot;
android:layout_width=&quot;match_parent&quot;
android:layout_height=&quot;wrap_content&quot;
app:layout_behavior=&quot;your.package.FlingBehavior&quot;&gt;
&lt;!--your views here--&gt;
 &lt;/android.support.design.widget.AppBarLayout&gt;
</code></pre><hr>
<pre><code>public class FlingBehavior extends AppBarLayout.Behavior {

    private static final int TOP_CHILD_FLING_THRESHOLD = 3;
    private boolean isPositive;

    public FlingBehavior() {
    }

    public FlingBehavior(Context context, AttributeSet attrs) {
        super(context, attrs);
    }

    @Override
    public boolean onNestedFling(CoordinatorLayout coordinatorLayout, AppBarLayout child, View target, float velocityX, float velocityY, boolean consumed) {
        if (velocityY &gt; 0 &amp;&amp; !isPositive || velocityY &lt; 0 &amp;&amp; isPositive) {
            velocityY = velocityY * -1;
        }
        if (target instanceof RecyclerView &amp;&amp; velocityY &lt; 0) {
            final RecyclerView recyclerView = (RecyclerView) target;
            final View firstChild = recyclerView.getChildAt(0);
            final int childAdapterPosition = recyclerView.getChildAdapterPosition(firstChild);
            consumed = childAdapterPosition &gt; TOP_CHILD_FLING_THRESHOLD;
        }
        consumed=false;
        return super.onNestedFling(coordinatorLayout, child, target, velocityX, velocityY, consumed);
    }

    @Override
    public void onNestedPreScroll(CoordinatorLayout coordinatorLayout, AppBarLayout child, View target, int dx, int dy, int[] consumed) {
        super.onNestedPreScroll(coordinatorLayout, child, target, dx, dy, consumed);
        isPositive = dy &gt; 0;
    }
</code></pre><p>注意consumed计算这部分，会影响滚动形式</p>
<p>请参考父类滚动的实现代码：</p>
<pre><code> @Override
public boolean onNestedFling(final CoordinatorLayout coordinatorLayout,
            final AppBarLayout child, View target, float velocityX, float velocityY,
            boolean consumed) {
        boolean flung = false;

        if (!consumed) {
            // It has been consumed so let&apos;s fling ourselves
            flung = fling(coordinatorLayout, child, -child.getTotalScrollRange(),
                    0, -velocityY);
        } else {
            // If we&apos;re scrolling up and the child also consumed the fling. We&apos;ll fake scroll
            // upto our &apos;collapsed&apos; offset
            if (velocityY &lt; 0) {
                // We&apos;re scrolling down
                final int targetScroll = -child.getTotalScrollRange()
                        + child.getDownNestedPreScrollRange();
                if (getTopBottomOffsetForScrollingSibling() &lt; targetScroll) {
                    // If we&apos;re currently not expanded more than the target scroll, we&apos;ll
                    // animate a fling
                    animateOffsetTo(coordinatorLayout, child, targetScroll);
                    flung = true;
                }
            } else {
                // We&apos;re scrolling up
                final int targetScroll = -child.getUpNestedPreScrollRange();
                if (getTopBottomOffsetForScrollingSibling() &gt; targetScroll) {
                    // If we&apos;re currently not expanded less than the target scroll, we&apos;ll
                    // animate a fling
                    animateOffsetTo(coordinatorLayout, child, targetScroll);
                    flung = true;
                }
            }
        }

        mWasNestedFlung = flung;
        return flung;
    }
</code></pre><p>确认你需要滚动哪一步分，你可以简单根据RecyclerView展示的first item的position来判断Recyclerview是否在top位置，也有另一种代码如下：</p>
<pre><code>@Override
public boolean onNestedFling(CoordinatorLayout coordinatorLayout, AppBarLayout child, View target, float velocityX, float velocityY, boolean consumed) {
    if (target instanceof RecyclerView) {
        final RecyclerView recyclerView = (RecyclerView) target;
        consumed = velocityY &gt; 0 || recyclerView.computeVerticalScrollOffset() &gt; 0;
    }
    return super.onNestedFling(coordinatorLayout, child, target, velocityX, velocityY, consumed);
}
</code></pre><p>另一个解决方案是使用 <a href="https://github.com/henrytao-me/smooth-app-bar-layout" target="_blank" rel="external">smooth-app-bar-layout</a></p>
<p>具体如何使用请参考它自己的文档</p>
<p>当header是Toolbar时，demo运作良好，当headerview高度较大时，滑动会发生剧烈抖动，弹跳，暂时还没去看它源代码，可能是我使用不正确</p>
<h4 id="不支持adjustResize"><a href="#不支持adjustResize" class="headerlink" title="不支持adjustResize"></a>不支持adjustResize</h4><p>可以参考这个问题<br><a href="http://stackoverflow.com/questions/35599125/adjustresize-does-not-work-with-coordinatorlayout" target="_blank" rel="external">http://stackoverflow.com/questions/35599125/adjustresize-does-not-work-with-coordinatorlayout</a></p>
<p>解决方案是可以通过ViewTreeObserver.OnGlobalLayoutListener监听界面改变，然后人工处理padding bottom</p>
<pre><code>public class KeyboardUtil {
    private View decorView;
    private View contentView;

    public KeyboardUtil(Activity act, View contentView) {
        this.decorView = act.getWindow().getDecorView();
        this.contentView = contentView;

        //only required on newer android versions. it was working on API level 19
        if (Build.VERSION.SDK_INT &gt;= 19) {
            decorView.getViewTreeObserver().addOnGlobalLayoutListener(onGlobalLayoutListener);
        }
    }

    public void enable() {
        if (Build.VERSION.SDK_INT &gt;= 19) {
            decorView.getViewTreeObserver().addOnGlobalLayoutListener(onGlobalLayoutListener);
        }
    }

    public void disable() {
        if (Build.VERSION.SDK_INT &gt;= 19) {
            decorView.getViewTreeObserver().removeOnGlobalLayoutListener(onGlobalLayoutListener);
        }
    }


    //a small helper to allow showing the editText focus
    ViewTreeObserver.OnGlobalLayoutListener onGlobalLayoutListener = new ViewTreeObserver.OnGlobalLayoutListener() {
        @Override
        public void onGlobalLayout() {
            Rect r = new Rect();
            //r will be populated with the coordinates of your view that area still visible.
            decorView.getWindowVisibleDisplayFrame(r);

            //get screen height and calculate the difference with the useable area from the r
            int height = decorView.getContext().getResources().getDisplayMetrics().heightPixels;
            int diff = height - r.bottom;

            //if it could be a keyboard add the padding to the view
            if (diff != 0) {
                // if the use-able screen height differs from the total screen height we assume that it shows a keyboard now
                //check if the padding is 0 (if yes set the padding for the keyboard)
                if (contentView.getPaddingBottom() != diff) {
                    //set the padding of the contentView for the keyboard
                    contentView.setPadding(0, 0, 0, diff);
                }
            } else {
                //check if the padding is != 0 (if yes reset the padding)
                if (contentView.getPaddingBottom() != 0) {
                    //reset the padding of the contentView
                    contentView.setPadding(0, 0, 0, 0);
                }
            }
        }
    };


    /**
     * Helper to hide the keyboard
     *
     * @param act
     */
    public static void hideKeyboard(Activity act) {
        if (act != null &amp;&amp; act.getCurrentFocus() != null) {
            InputMethodManager inputMethodManager = (InputMethodManager) act.getSystemService(Activity.INPUT_METHOD_SERVICE);
            inputMethodManager.hideSoftInputFromWindow(act.getCurrentFocus().getWindowToken(), 0);
        }
    }
}
</code></pre><hr>
<pre><code>KeyboardUtil keyboardUtil = new KeyboardUtil(this, findViewById(android.R.id.content));

//enable it
keyboardUtil.enable();
</code></pre><hr>
<p>ps.<br>fitSystemWindow 和 adjustResize 和 FLAG_TRANSLUCENT_STATUS 一起使用 一样也会有冲突，造成界面缩放不正常。  当时也是用的这个解决方案。</p>
<h3 id="CoordinatorLayout的onScrollListener只支持21"><a href="#CoordinatorLayout的onScrollListener只支持21" class="headerlink" title="CoordinatorLayout的onScrollListener只支持21+"></a>CoordinatorLayout的onScrollListener只支持21+</h3><p>解决方案：<br>在Behavior里监听滚动，并把数据传出来</p>
<p>代码和后一个问题贴在一起</p>
<p>注意 我这里只监听了 onDependentViewChanged<br>并在这里调用onScroll接口，然后外部实际使用的数据是 headerview.getTop , 并不能覆盖全部情况，但是我本身只用来做状态栏渐变色，有其它使用场景请自行修改</p>
<h3 id="当顶部容器不使用Toolbar时，Measure会有问题"><a href="#当顶部容器不使用Toolbar时，Measure会有问题" class="headerlink" title="当顶部容器不使用Toolbar时，Measure会有问题"></a>当顶部容器不使用Toolbar时，Measure会有问题</h3><p>解决方案：<br>自定义一个 Behavior,继承AppBarLayout.ScrollingViewBehavior</p>
<p>并重载onMeasureChild方法</p>
<pre><code>public class PatchedScrollingViewBehavior extends AppBarLayout.ScrollingViewBehavior {

    private OnScrollListener onScrollListener;

    public PatchedScrollingViewBehavior() {
        super();
    }

    public PatchedScrollingViewBehavior(Context context, AttributeSet attrs) {
        super(context, attrs);
    }

    @Override
    public boolean onMeasureChild(CoordinatorLayout parent, View child, int parentWidthMeasureSpec, int widthUsed, int parentHeightMeasureSpec, int heightUsed) {

        Log.e(&quot;####&quot;, &quot;onMeasureChild&quot;);


        if (child.getLayoutParams().height == -1) {
            List dependencies = parent.getDependencies(child);
            if (dependencies.isEmpty()) {
                return false;
            }

            AppBarLayout appBar = findFirstAppBarLayout(dependencies);
            if (appBar != null &amp;&amp; ViewCompat.isLaidOut(appBar)) {
                if (ViewCompat.getFitsSystemWindows(appBar)) {
                    ViewCompat.setFitsSystemWindows(child, true);
                }

                int scrollRange = appBar.getTotalScrollRange();
//                int height = parent.getHeight() - appBar.getMeasuredHeight() + scrollRange;
                int parentHeight = View.MeasureSpec.getSize(parentHeightMeasureSpec);
                int height = parentHeight - appBar.getMeasuredHeight() + scrollRange;
                int heightMeasureSpec = View.MeasureSpec.makeMeasureSpec(height, View.MeasureSpec.AT_MOST);
                parent.onMeasureChild(child, parentWidthMeasureSpec, widthUsed, heightMeasureSpec, heightUsed);
                return true;
            }
        }

        return false;
    }

    @Override
    public void onNestedScroll(CoordinatorLayout coordinatorLayout, View child, View target, int dxConsumed, int dyConsumed, int dxUnconsumed, int dyUnconsumed) {
        super.onNestedScroll(coordinatorLayout, child, target, dxConsumed, dyConsumed, dxUnconsumed, dyUnconsumed);
    }

    private static AppBarLayout findFirstAppBarLayout(List&lt;View&gt; views) {
        int i = 0;
        for (int z = views.size(); i &lt; z; ++i) {
            View view = (View) views.get(i);
            if (view instanceof AppBarLayout) {
                return (AppBarLayout) view;
            }
        }
        return null;
    }

    @Override
    public boolean onDependentViewChanged(CoordinatorLayout parent, View child,
                                          View dependency) {
        if (onScrollListener != null) {
            onScrollListener.onScroll(parent, child, dependency);
        }
        return super.onDependentViewChanged(parent, child, dependency);
    }

    public interface OnScrollListener {
        void onScroll(CoordinatorLayout parent, View child,
                      View dependency);

    }

    public OnScrollListener getOnScrollListener() {
        return onScrollListener;
    }

    public void setOnScrollListener(OnScrollListener onScrollListener) {
        this.onScrollListener = onScrollListener;
    }
}
</code></pre><p>REF:<br><a href="http://stackoverflow.com/questions/30923889/flinging-with-recyclerview-appbarlayout" target="_blank" rel="external">http://stackoverflow.com/questions/30923889/flinging-with-recyclerview-appbarlayout</a><br><a href="https://github.com/henrytao-me/smooth-app-bar-layout" target="_blank" rel="external">https://github.com/henrytao-me/smooth-app-bar-layout</a><br><a href="https://code.google.com/p/android/issues/detail?id=177729" target="_blank" rel="external">https://code.google.com/p/android/issues/detail?id=177729</a> </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-MVC-MVP-MVVM" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/21/MVC-MVP-MVVM/" class="article-date">
  	<time datetime="2015-12-21T00:15:11.000Z" itemprop="datePublished">2015-12-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/21/MVC-MVP-MVVM/">MVC &amp; MVP &amp; MVVM</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#MVC &amp; MVP &amp; MVVP</p>
<p>先放2个引用，概念上的讨论我觉得可以参考这2个。</p>
<p><a href="http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html</a></p>
<p><a href="http://weibo.com/p/1001603808855434892996" target="_blank" rel="external">http://weibo.com/p/1001603808855434892996</a>  </p>
<p>我主要想讨论下 这一演化过程,和架构选择的必要性。</p>
<p>###MVC</p>
<p>首先，传统的MVC项目中，layout.xml承担View的角色，Activity承担Controller的角色。</p>
<p>这本身没有什么问题，如果你的Activity代码不足千行（当然不包含网络请求及解析），多拆分几个方法，写好注释，也可以一用。<br>你也可以通过把其中部分逻辑 模块化抽出的方式 简化Activity代码。很多小型项目或者功能简单的Activity，使用MVC模型就可以了，盲目的使用MVP或MVVM并不是好事。</p>
<p>###MVP</p>
<p>然而随着项目的不断发展和复杂化，Activity承担的内容越来越多，请求数据，响应数据，数据处理，生成UI，修改view的状态，特效实现。</p>
<p>当Activity过于膨胀，我们就需要拆分它。</p>
<p>按职责，拆分为 <code>业务逻辑</code> 和 <code>UI逻辑</code>，就是Android中当前推荐的MVP实现.</p>
<ul>
<li><p>业务逻辑</p>
<p>  包含请求数据，响应操作，对数据的处理等等业务相关的代码。</p>
</li>
<li><p>UI逻辑</p>
<p>  包含界面的调整，UI状态的变化，动效等。</p>
</li>
</ul>
<p>业务逻辑通过抽出 Presenter 层实现。<br>UI逻辑通过构造 ViewInterface并由Activity实现。</p>
<p>由于View和Presenter仅通过  ViewInterface关联，单独修改View或Presenter不会互相影响。</p>
<p>这是个好事，一般工程上小的UI调整总是多如牛毛，避免其影响到业务逻辑层可以减少很多bug的产生。</p>
<p>反过来也是一样。</p>
<p>当然，坏处也有，当你的Presenter需要添加一个新的功能/行为时，你需要在ViewInterface上添加新的接口，并在Activity上实现。<br>更多的灵活性总是意味着 更复杂的项目层次。</p>
<p>如果你遇到2种问题，那么你应当使用MVP</p>
<ol>
<li>你需要自动化测试。</li>
</ol>
<p>MVP的引入会让测试变得非常方便。<br>写一个简单的包含mock数据的Presenter就可以测试所有UI逻辑。<br>可以非常方便的在没有后端的情况下完成所有UI层逻辑及测试</p>
<p>同时 Presenter的测试也变得容易，因为Presenter现在与View是完全分离的，这意味着，测试业务逻辑时，你甚至不需要Android 环境，而且可以简单的mock ui行为。<br>这可比用脚本在模拟器上跑测试要方便多了。</p>
<ol>
<li>更高的复用率</li>
</ol>
<p>Activity或Presenter都可以复用。如果你的项目需要快速迭代，那往往意味着，大量的UI变更，大量的逻辑调整。<br>分离Activity和Presenter可以减少很多 因为互相影响产生的bug，而且页面和逻辑变得方便调整和复用。</p>
<p>###MVVM</p>
<p>Android上谈MVVM，目前大多是指data binding.<br>这个东西刚出来的时候还比较火，但是实际用起来坑还比较多，目前没有看到哪个大型项目有实践这个东西。</p>
<p>具体使用可以参考这个文档  <a href="https://github.com/LyndonChin/MasteringAndroidDataBinding" target="_blank" rel="external">MasteringAndroidDataBinding</a> 。<br>看起来不错，用起来都是坑。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
    <article id="post-weak-handler" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/11/weak-handler/" class="article-date">
  	<time datetime="2015-11-11T04:08:47.000Z" itemprop="datePublished">2015-11-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/11/weak-handler/">Weak Handler 与 内存泄露</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#Weak Handler 与 内存泄露</p>
<p>Handler使用不当比较容易造成内存泄露.</p>
<p>比如这个例子:<a href="http://www.jianshu.com/p/c49f778e7acf" target="_blank" rel="external">http://www.jianshu.com/p/c49f778e7acf</a></p>
<p>通常的原因就是 Handler的生命周期和Activity的生命周期不一致.</p>
<hr>
<p>一个通用的场景是 使用 匿名内部类 实例 作为某个 行为/动作的 回调,如果该行为/动作 是异步的,则其返回时间往往无法确定,有造成内存泄露风险.</p>
<p>使用静态内部类,或者妥善处理生命周期,都不会造成内存泄露,反过来,当没有内存泄露风险时,一般直接匿名内部类即可.</p>
<p>这其实是一个特别矛盾的说法.</p>
<p>因为这要求程序员能 能了解到 回调行为是在何时发生的. </p>
<p>而相反,我们设计接口回调的时候总是尽力屏蔽内部实现细节.</p>
<p>而面对不确定的行为,当然也可以使用静态内部类,或者removeCallback去取消回调(特指Handler),然而这样代码变得繁琐,或者添加不必要的代码.</p>
<p>对于Handler,一个简单的第三方解决方案是使用 android-weak-handler ,该库尝试使用WeakReference解决这个问题,然而却引入新的问题.</p>
<p><a href="https://github.com/badoo/android-weak-handler" target="_blank" rel="external">https://github.com/badoo/android-weak-handler</a></p>
<p>核心代码如下:</p>
<pre><code>public class WeakHandler {
    private final Handler.Callback mCallback; // hard reference to Callback. We need to keep callback in memory
    private final ExecHandler mExec;
    private Lock mLock = new ReentrantLock();
    @SuppressWarnings(&quot;ConstantConditions&quot;)
    @VisibleForTesting
    final ChainedRef mRunnables = new ChainedRef(mLock, null);

    public WeakHandler() {
        mCallback = null;
        mExec = new ExecHandler();
    }

    public WeakHandler(@Nullable Handler.Callback callback) {
        mCallback = callback; // Hard referencing body
        mExec = new ExecHandler(new WeakReference&lt;&gt;(callback)); // Weak referencing inside ExecHandler
    }

    public WeakHandler(@NonNull Looper looper) {
        mCallback = null;
        mExec = new ExecHandler(looper);
    }

    public WeakHandler(@NonNull Looper looper, @NonNull Handler.Callback callback) {
        mCallback = callback;
        mExec = new ExecHandler(looper, new WeakReference&lt;&gt;(callback));
    }

    public final boolean post(@NonNull Runnable r) {
        return mExec.post(wrapRunnable(r));
    }

    public final boolean postAtTime(@NonNull Runnable r, long uptimeMillis) {
        return mExec.postAtTime(wrapRunnable(r), uptimeMillis);
    }

    public final boolean postAtTime(Runnable r, Object token, long uptimeMillis) {
        return mExec.postAtTime(wrapRunnable(r), token, uptimeMillis);
    }

    public final boolean postDelayed(Runnable r, long delayMillis) {
        return mExec.postDelayed(wrapRunnable(r), delayMillis);
    }

    public final boolean postAtFrontOfQueue(Runnable r) {
        return mExec.postAtFrontOfQueue(wrapRunnable(r));
    }

    public final void removeCallbacks(Runnable r) {
        final WeakRunnable runnable = mRunnables.remove(r);
        if (runnable != null) {
            mExec.removeCallbacks(runnable);
        }
    }

    public final void removeCallbacks(Runnable r, Object token) {
        final WeakRunnable runnable = mRunnables.remove(r);
        if (runnable != null) {
            mExec.removeCallbacks(runnable, token);
        }
    }

    public final boolean sendMessage(Message msg) {
        return mExec.sendMessage(msg);
    }

    public final boolean sendEmptyMessage(int what) {
        return mExec.sendEmptyMessage(what);
    }

    public final boolean sendEmptyMessageDelayed(int what, long delayMillis) {
        return mExec.sendEmptyMessageDelayed(what, delayMillis);
    }

    public final boolean sendEmptyMessageAtTime(int what, long uptimeMillis) {
        return mExec.sendEmptyMessageAtTime(what, uptimeMillis);
    }

    public final boolean sendMessageDelayed(Message msg, long delayMillis) {
        return mExec.sendMessageDelayed(msg, delayMillis);
    }

    public boolean sendMessageAtTime(Message msg, long uptimeMillis) {
        return mExec.sendMessageAtTime(msg, uptimeMillis);
    }

    public final boolean sendMessageAtFrontOfQueue(Message msg) {
        return mExec.sendMessageAtFrontOfQueue(msg);
    }

    public final void removeMessages(int what) {
        mExec.removeMessages(what);
    }

    public final void removeMessages(int what, Object object) {
        mExec.removeMessages(what, object);
    }

    public final void removeCallbacksAndMessages(Object token) {
        mExec.removeCallbacksAndMessages(token);
    }

    public final boolean hasMessages(int what) {
        return mExec.hasMessages(what);
    }

    public final boolean hasMessages(int what, Object object) {
        return mExec.hasMessages(what, object);
    }

    public final Looper getLooper() {
        return mExec.getLooper();
    }

    private WeakRunnable wrapRunnable(@NonNull Runnable r) {
        //noinspection ConstantConditions
        if (r == null) {
            throw new NullPointerException(&quot;Runnable can&apos;t be null&quot;);
        }
        final ChainedRef hardRef = new ChainedRef(mLock, r);
        mRunnables.insertAfter(hardRef);
        return hardRef.wrapper;
    }

    private static class ExecHandler extends Handler {
        private final WeakReference&lt;Handler.Callback&gt; mCallback;

        ExecHandler() {
            mCallback = null;
        }

        ExecHandler(WeakReference&lt;Handler.Callback&gt; callback) {
            mCallback = callback;
        }

        ExecHandler(Looper looper) {
            super(looper);
            mCallback = null;
        }

        ExecHandler(Looper looper, WeakReference&lt;Handler.Callback&gt; callback) {
            super(looper);
            mCallback = callback;
        }

        @Override
        public void handleMessage(@NonNull Message msg) {
            if (mCallback == null) {
                return;
            }
            final Handler.Callback callback = mCallback.get();
            if (callback == null) { // Already disposed
                return;
            }
            callback.handleMessage(msg);
        }
    }

    static class WeakRunnable implements Runnable {
        private final WeakReference&lt;Runnable&gt; mDelegate;
        private final WeakReference&lt;ChainedRef&gt; mReference;

        WeakRunnable(WeakReference&lt;Runnable&gt; delegate, WeakReference&lt;ChainedRef&gt; reference) {
            mDelegate = delegate;
            mReference = reference;
        }

        @Override
        public void run() {
            final Runnable delegate = mDelegate.get();
            final ChainedRef reference = mReference.get();
            if (reference != null) {
                reference.remove();
            }
            if (delegate != null) {
                delegate.run();
            }
        }
    }

    static class ChainedRef {
        @Nullable
        ChainedRef next;
        @Nullable
        ChainedRef prev;
        @NonNull
        final Runnable runnable;
        @NonNull
        final WeakRunnable wrapper;

        @NonNull
        Lock lock;

        public ChainedRef(@NonNull Lock lock, @NonNull Runnable r) {
            this.runnable = r;
            this.lock = lock;
            this.wrapper = new WeakRunnable(new WeakReference&lt;&gt;(r), new WeakReference&lt;&gt;(this));
        }

        public WeakRunnable remove() {
            lock.lock();
            try {
                if (prev != null) {
                    prev.next = next;
                }
                if (next != null) {
                    next.prev = prev;
                }
                prev = null;
                next = null;
            } finally {
                lock.unlock();
            }
            return wrapper;
        }

        public void insertAfter(@NonNull ChainedRef candidate) {
            lock.lock();
            try {
                if (this.next != null) {
                    this.next.prev = candidate;
                }

                candidate.next = this.next;
                this.next = candidate;
                candidate.prev = this;
            } finally {
                lock.unlock();
            }
        }

        @Nullable
        public WeakRunnable remove(Runnable obj) {
            lock.lock();
            try {
                ChainedRef curr = this.next; // Skipping head
                while (curr != null) {
                    if (curr.runnable == obj) { // We do comparison exactly how Handler does inside
                        return curr.remove();
                    }
                    curr = curr.next;
                }
            } finally {
                lock.unlock();
            }
            return null;
        }
    }
}
</code></pre><p>这个类的实现有个问题,为了避免持有Runnable的引用,使用WeakRunnable作为Wrapper,为了能够在Activity销毁时释放Runnable,这里使用的WeakReference去持有Runnable引用.<br>从目的上看,它确实解决了由于Runnable隐式持有Activity强引用而导致Acticity实例无法销毁的问题</p>
<p>##但是</p>
<p>作为匿名内部类被传入的Runnable对象如果只存在一个WeakReference,那意味着,任何一次GC操作都将导致其被回收.<br>看看这个例子</p>
<pre><code>import com.badoo.mobile.util.WeakHandler;

public class ExampleActivity extends Activity {

    private WeakHandler mHandler; // We still need at least one hard reference to WeakHandler

    protected void onCreate(Bundle savedInstanceState) {
        mHandler = new WeakHandler();
        ...
    }

    private void onClick(View view) {
        mHandler.postDelayed(new Runnable() {
            view.setVisibility(View.INVISIBLE);
        }, 5000);
    }
}
</code></pre><p>如果在这5s内系统触发了一次GC操作会怎么样? Runnable会被回收?</p>
<p>将Demo简单修改一下</p>
<pre><code>protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    WeakHandler  mHandler = new WeakHandler();
    mHandler.postDelayed(new Runnable() {


        @Override
        public void run() {
            System.out.println(&quot;####################### Do Something&quot;);
            );
        }
    }, 10000);

    mHandler.postDelayed(new Runnable() {


        @Override
        public void run() {
            System.out.println(&quot;#######################GC&quot;);

            System.gc();
        }
    }, 5000);

}
</code></pre><p>看看运行结果,GC操作发生了,而Do Something并没有执行,因为 GC动作发生时, WeakReference持有的Runnable已经被释放了.</p>
<p>通常来讲,GC操作发生的时间不可预料的,你无法预期等待回调的这几秒种内用户做了什么操作,而一旦触发了GC,则回调会被立刻取消</p>
<p>注意,Activity并未被关闭,Runnable回调也会被释放!</p>
<p>如果在大型项目中遇到这样的问题,排查一定是灾难性的.因为GC的不确定性,出现了回调丢失情况一定是随机的,难以预测的,难以重现的.</p>
<p>而处理这个问题的办法是,将mHandler从临时变量 换成 成Activity的一个实例变量.</p>
<p>然而通常程序员不一定意识这2种写法的区别,而且使用系统提供的Handler时,这2种写法是没有区别的.</p>
<p>最后我检查了下文档,作者还是写了一句话作为提示</p>
<blockquote>
<p>We still need at least one hard reference to WeakHandler</p>
</blockquote>
<p>至于使用者是否能意识到问题所在我持怀疑态度.</p>
<p>第三方库就是容易出现这种问题,使用起来能很方便的解决很多问题,然而又很容易挖几个隐蔽的坑给你.</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>






  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 DK
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>