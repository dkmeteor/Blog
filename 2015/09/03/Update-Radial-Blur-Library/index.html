<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Update Radial Blur Library | DK&#39;s Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="因为看了@drakeet的FingerTransparentView想起来去年自己也写过一个类似的动态模糊(Motion Blur)的库
于是翻出来看了一下,花了点时间迁移到了Android Studio
在看的时候自己发现一个问题,这TM根本不是 Motion Blur ,我自己写的代码实际上实现的效果是 径向模糊(Radial Blur)
嘛…我还是要说一下 MotionBlur和Radial">
<meta property="og:type" content="article">
<meta property="og:title" content="Update Radial Blur Library">
<meta property="og:url" content="http://blog.dk-exp.com/2015/09/03/Update-Radial-Blur-Library/index.html">
<meta property="og:site_name" content="DK's Lab">
<meta property="og:description" content="因为看了@drakeet的FingerTransparentView想起来去年自己也写过一个类似的动态模糊(Motion Blur)的库
于是翻出来看了一下,花了点时间迁移到了Android Studio
在看的时候自己发现一个问题,这TM根本不是 Motion Blur ,我自己写的代码实际上实现的效果是 径向模糊(Radial Blur)
嘛…我还是要说一下 MotionBlur和Radial">
<meta property="og:image" content="https://raw.githubusercontent.com/dkmeteor/MotionBlur-Android/master/release/blur_center.png">
<meta property="og:updated_time" content="2015-10-01T05:51:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Update Radial Blur Library">
<meta name="twitter:description" content="因为看了@drakeet的FingerTransparentView想起来去年自己也写过一个类似的动态模糊(Motion Blur)的库
于是翻出来看了一下,花了点时间迁移到了Android Studio
在看的时候自己发现一个问题,这TM根本不是 Motion Blur ,我自己写的代码实际上实现的效果是 径向模糊(Radial Blur)
嘛…我还是要说一下 MotionBlur和Radial">
<meta name="twitter:image" content="https://raw.githubusercontent.com/dkmeteor/MotionBlur-Android/master/release/blur_center.png">
  
    <link rel="alternative" href="/atom.xml" title="DK&#39;s Lab" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
  
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?47d977b9cd46d5988a3e06ada67a7fa9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">DK</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/android/" style="font-size: 20px;">android</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/circle/" style="font-size: 10px;">circle</a> <a href="/tags/list/" style="font-size: 10px;">list</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">DK</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://dk-exp.qiniudn.com/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">DK</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/dkmeteor" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2699012760" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/ding-ke-53-78" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Update-Radial-Blur-Library" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/09/03/Update-Radial-Blur-Library/" class="article-date">
  	<time datetime="2015-09-02T18:24:42.000Z" itemprop="datePublished">2015-09-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Update Radial Blur Library
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>因为看了@drakeet的FingerTransparentView想起来去年自己也写过一个类似的动态模糊(Motion Blur)的库</p>
<p>于是翻出来看了一下,花了点时间迁移到了Android Studio</p>
<p>在看的时候自己发现一个问题,这TM根本不是 <code>Motion Blur</code> ,我自己写的代码实际上实现的效果是 径向模糊(<code>Radial Blur</code>)</p>
<p>嘛…我还是要说一下 MotionBlur和RadialBlur看起来很像,但实际上是不一样的,我之前也是误解了,后来仔细看了些效果图,下面提到的几个库算法实现虽然名字都是叫MotionBlur,但是实现的效果其实都是RadialBlur</p>
<p>Demo效果</p>
<p><img src="https://raw.githubusercontent.com/dkmeteor/MotionBlur-Android/master/release/blur_center.png" alt="Examples list"></p>
<p>因为涉及到重复draw,当时我写得时候就记得性能很一般,这次迁移顺便也打算看看这个问题</p>
<p>核心代码其实很简单</p>
<pre><code>  public static Bitmap doRadialBlur(Bitmap src, int centerX, int centerY, float factor, int times) {

    Bitmap dst = Bitmap.createBitmap(src.getWidth(), src.getHeight(), Bitmap.Config.ARGB_8888);
    Canvas canvas = new Canvas(dst);
    Matrix matrix = new Matrix();
    Paint paint = new Paint();
    canvas.drawBitmap(src, matrix, paint);
    paint.setAlpha(51);

    for (int i = 0; i &lt; times; i++) {
        matrix.setScale(i * factor + 1, i * factor + 1, centerX, centerY);
        canvas.drawBitmap(src, matrix, paint);
    }
    return dst;
}
</code></pre><p>为了实现效果需要反复的Scale并重复的draw同一张Bitmap,性能当然狠捉急.<br>测试时发现渲染一次需要 1400ms 左右.</p>
<p>图片是2400<em>2400的,换成800</em>800的以后,减少到200ms左右,作为一个滤镜来讲,尚可接受吧,一时间也想不到什么优化的方法.<br>优化到16ms以下可以做成实时滤镜,否则的话,似乎意义不大.</p>
<p>想起jhlab也有 径向模糊 的滤镜算法,于是拔出来代码看了下</p>
<pre><code> public BufferedImage filter( BufferedImage src, BufferedImage dst ) {
    if ( dst == null )
        dst = createCompatibleDestImage( src, null );
    BufferedImage tsrc = src;
    float cx = (float)src.getWidth() * centreX;
    float cy = (float)src.getHeight() * centreY;
    float imageRadius = (float)Math.sqrt( cx*cx + cy*cy );
    float translateX = (float)(distance * Math.cos( angle ));
    float translateY = (float)(distance * -Math.sin( angle ));
    float scale = zoom;
    float rotate = rotation;
    float maxDistance = distance + Math.abs(rotation*imageRadius) + zoom*imageRadius;
    int steps = log2((int)maxDistance);

    translateX /= maxDistance;
    translateY /= maxDistance;
    scale /= maxDistance;
    rotate /= maxDistance;

    if ( steps == 0 ) {
        Graphics2D g = dst.createGraphics();
        g.drawRenderedImage( src, null );
        g.dispose();
        return dst;
    }

    BufferedImage tmp = createCompatibleDestImage( src, null );
    for ( int i = 0; i &lt; steps; i++ ) {
        Graphics2D g = tmp.createGraphics();
        g.drawImage( tsrc, null, null );
        g.setRenderingHint( RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON );
        g.setRenderingHint( RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR );
        g.setComposite( AlphaComposite.getInstance( AlphaComposite.SRC_OVER, 0.5f ) );

        g.translate( cx+translateX, cy+translateY );
        g.scale( 1.0001+scale, 1.0001+scale );  // The .0001 works round a bug on Windows where drawImage throws an ArrayIndexOutofBoundException
        if ( rotation != 0 )
            g.rotate( rotate );
        g.translate( -cx, -cy );

        g.drawImage( dst, null, null );
        g.dispose();
        BufferedImage ti = dst;
        dst = tmp;
        tmp = ti;
        tsrc = dst;

        translateX *= 2;
        translateY *= 2;
        scale *= 2;
        rotate *= 2;
    }
    return dst;
}
</code></pre><p>Jhlabs比较古老,BufferedImage是awt里面,做Android的如果不了解的话当Bitmap理解就好了.<br>可以看到Jhlabs的代码逻辑也没什么区别,一样是通过反复draw image实现的径向模糊效果.</p>
<p>参考意义不大.</p>
<p>另外在Github上搜索了一下,一个叫做AndroidFastImageProcessing的库也支持MotionBlur,其实现机制比较特别</p>
<p>核心代码是这样</p>
<pre><code>protected String getFragmentShader() {
    return 
             &quot;precision mediump float;\n&quot; 
            +&quot;uniform sampler2D &quot;+UNIFORM_TEXTURE0+&quot;;\n&quot;  
            +&quot;varying vec2 &quot;+VARYING_TEXCOORD+&quot;;\n&quot;    
            +&quot;uniform float &quot;+UNIFORM_TEXELWIDTH+&quot;;\n&quot;
            +&quot;uniform float &quot;+UNIFORM_TEXELHEIGHT+&quot;;\n&quot;

              +&quot;void main(){\n&quot;
              +&quot;   vec2 step = vec2(&quot;+UNIFORM_TEXELWIDTH+&quot;, &quot;+UNIFORM_TEXELHEIGHT+&quot;);\n&quot;
              +&quot;   vec4 fragColour = texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot;) * 0.18;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; + step) * 0.15;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; - step) * 0.15;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; + step * 2.0) * 0.12;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; - step * 2.0) * 0.12;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; + step * 3.0) * 0.09;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; - step * 3.0) * 0.09;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; + step * 4.0) * 0.05;\n&quot;
              +&quot;   fragColour += texture2D(&quot;+UNIFORM_TEXTURE0+&quot;, &quot;+VARYING_TEXCOORD+&quot; - step * 4.0) * 0.05;\n&quot;
              +&quot;   gl_FragColor = fragColour;\n&quot;
              +&quot;}\n&quot;;
}
</code></pre><p>可以看到 这是生成了一段代码</p>
<p>然后对应的执行部分</p>
<pre><code>GLES20.glShaderSource(fragmentShaderHandle, fragmentShader);
GLES20.glCompileShader(fragmentShaderHandle);
</code></pre><p>好吧,其实我压根就不懂OpenGl.大概是把图片作为Shader进行了多次渲染来实现MontionBlur的效果.</p>
<p>这个研究基本上没有结果,往下层去看都是native方法,OpenGl可能是一个可行的优化方法,可惜是我不懂OpenGL,看了一点点实在没什么头绪,可能需要系统的从头学习一下.</p>
<hr>
<p>然后过程中还发现个比较奇特的问题</p>
<p>将项目发布到jcenter以后,打算自己测试一下,但是一直编译不过,提示如下:</p>
<pre><code>Error:A problem occurred configuring project &apos;:app&apos;.
&gt; Could not resolve all dependencies for configuration &apos;:app:_debugCompile&apos;.
   &gt; Could not resolve com.dk.image.process.radialblur:library:0.1.0.
     Required by:
         MotionBlur-Android:app:unspecified
      &gt; Could not resolve com.dk.image.process.radialblur:library:0.1.0.
         &gt; Could not get resource &apos;https://jcenter.bintray.com/com/dk/image/process/radialblur/library/0.1.0/library-0.1.0.pom&apos;.
            &gt; Could not HEAD &apos;https://jcenter.bintray.com/com/dk/image/process/radialblur/library/0.1.0/library-0.1.0.pom&apos;. Received status code 400 from server: Bad Request
</code></pre><p>我自己反复确认了几次, <a href="https://jcenter.bintray.com/com/dk/image/process/radialblur/library/0.1.0/library-0.1.0.pom" target="_blank" rel="external">https://jcenter.bintray.com/com/dk/image/process/radialblur/library/0.1.0/library-0.1.0.pom</a> 绝对是可以访问的.</p>
<p>然后我一想,可能是代理的问题,但是我确定自己肯定没给Android Studio配过代理,因为我自己用的代理是 红杏,需要全局代理的时候我用的mxvpm需要客户端登陆,根本不会在Android Studio里配置,<br>不过还是检查了下Android Studio的代理配置,代理配置确实是空的,但是最顶部有一个Warnning提示,提示我JVM里配置了一个Proxy</p>
<p><code>mirrors.opencas.cn</code></p>
<p>我其实不大理解什么叫JVM PROXY,不过这个代理服务器地址我一看就知道是我在SDK Manager里使用的镜像的地址,我也不知道为什么Android Studio会把SDK Manager里的配置读过来,之前是从来没有过的.<br>打开SDK Manager,删掉镜像配置,重启Android Studio,恢复了正常,denpendices可以正常sync.</p>
<p>关掉Android Studio,再打开SDK Manager,把镜像重新配回去.重启Android Studio,检查代理设置,正常.</p>
<p>这我就不理解了,什么情况下Android Studio会读取SDK Mananger的代理配置,什么时候不会?</p>
<p>出现问题的版本 Android Studio版本1.3.1 </p>
<p>之前从来没有遇到过,因为我SDK Manager里一直是挂着镜像的地址.</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/03/about-vysor/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Vysor
        
      </div>
    </a>
  
  
    <a href="/2015/08/26/关于Looper的瞎扯蛋/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">关于Looper的瞎扯蛋</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Update-Radial-Blur-Library" data-title="Update Radial Blur Library" data-url="http://blog.dk-exp.com/2015/09/03/Update-Radial-Blur-Library/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 DK
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/mobile.js"></script>
<script src="/js/main.js"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>